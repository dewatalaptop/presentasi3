<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <title>tokopintar.id - Professional POS</title>

    <style>
        /* === 1. DESIGN SYSTEM & RESET (UNCHANGED) === */
        :root {
            --primary-500: #3b82f6; --primary-600: #2563eb;
            --neutral-0: #ffffff; --neutral-50: #f8fafc; --neutral-100: #f1f5f9; --neutral-200: #e2e8f0; --neutral-400: #94a3b8; --neutral-600: #475569; --neutral-800: #1e293b;
            --success-500: #10b981; --success-100: #d1fae5; --success-700: #047857;
            --danger-500: #ef4444; --danger-100: #fee2e2; --danger-700: #b91c1c;
            --warning-500: #f59e0b; --warning-100: #fef3c7; --warning-700: #b45309;
            --info-500: #38bdf8; --info-100: #e0f2fe;
            --font-main: 'Inter', sans-serif;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }
        html { scroll-behavior: smooth; }
        body { background-color: var(--neutral-100); color: var(--neutral-800); -webkit-font-smoothing: antialiased; }
        ::selection { background-color: var(--primary-500); color: var(--neutral-0); }

        /* === 2. LAYOUT UTAMA (UNCHANGED, with minor adjustments) === */
        .app-container { display: flex; }
        .main-content { width: 100%; padding: 0; padding-bottom: 80px; /* Space for bottom nav */ transition: margin-left 0.3s ease; }
        .sidebar { display: none; } /* Hidden on mobile */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background-color: var(--neutral-0); border-top: 1px solid var(--neutral-200); display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .bottom-nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--neutral-400); gap: 4px; }
        .bottom-nav-link i { font-size: 20px; }
        .bottom-nav-link span { font-size: 10px; font-weight: 500; }
        .bottom-nav-link.active { color: var(--primary-500); }

        /* TABLET LAYOUT */
        @media (min-width: 768px) {
            .main-content { margin-left: 80px; width: calc(100% - 80px); padding: 20px; padding-bottom: 20px; }
            .sidebar { display: flex; flex-direction: column; position: fixed; width: 80px; height: 100vh; background-color: var(--neutral-0); border-right: 1px solid var(--neutral-200); padding: 20px 0; transition: width 0.3s ease; z-index: 1001; }
            .sidebar:hover { width: 250px; }
            .sidebar-header { display: flex; align-items: center; justify-content: center; padding: 0 10px; min-height: 40px; }
            .sidebar-header i { color: var(--primary-500); font-size: 28px; }
            .sidebar-header h2 { font-size: 22px; opacity: 0; visibility: hidden; white-space: nowrap; margin-left:12px; }
            .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu { list-style: none; margin-top: 30px; }
            .sidebar-menu a { display: flex; align-items: center; text-decoration: none; color: var(--neutral-600); padding: 15px 28px; white-space: nowrap; }
            .sidebar-menu a i { font-size: 22px; min-width: 24px; }
            .sidebar-menu a span { margin-left: 20px; font-weight: 500; opacity: 0; visibility: hidden; }
            .sidebar:hover .sidebar-menu a span { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu a:hover { background-color: var(--neutral-100); }
            .sidebar-menu a.active { color: var(--primary-500); font-weight: 600; position: relative; }
            .sidebar-menu a.active::before { content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background-color: var(--primary-500); border-radius: 0 4px 4px 0; }
            .bottom-nav { display: none; }
        }
        /* DESKTOP LAYOUT */
        @media (min-width: 1200px) {
            .main-content { margin-left: 250px; width: calc(100% - 250px); }
            .sidebar, .sidebar:hover { width: 250px; }
            .sidebar-header { justify-content: flex-start; padding: 0 25px; }
            .sidebar-header h2, .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: none; }
            .sidebar-menu a span, .sidebar:hover .sidebar-menu a span { opacity: 1; visibility: visible; transition: none; }
        }

        /* === 3. KOMPONEN UI MODERN (UNCHANGED, with additions) === */
        .page-container { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 24px; }
        @media (min-width: 768px) { .header h1 { font-size: 28px; } }
        .card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; border-radius: 8px; font-weight: 600; text-decoration: none; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .btn:disabled { background-color: var(--neutral-200); color: var(--neutral-600); cursor: not-allowed; opacity: 0.7; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-500); color: var(--neutral-0); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-600); }
        .btn-secondary { background-color: var(--neutral-0); color: var(--neutral-800); border-color: var(--neutral-200); }
        .btn-secondary:hover { background-color: var(--neutral-50); }
        .btn-danger { background-color: var(--danger-500); color: var(--neutral-0); }
        .btn-danger:hover { background-color: #d73737; }
        .btn-text { background: none; color: var(--primary-500); padding: 8px; }
        .btn-text:hover { background-color: var(--neutral-100); }
        .form-group { position: relative; margin-bottom: 25px; }
        .form-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--neutral-200); font-size: 16px; background-color: var(--neutral-0); }
        .form-input:focus { border-color: var(--primary-500); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-label { position: absolute; left: 12px; top: 12px; font-size: 16px; color: var(--neutral-400); background-color: var(--neutral-0); padding: 0 4px; transition: all 0.2s ease; pointer-events: none; }
        .form-input:not(:placeholder-shown) + .form-label, .form-input:focus + .form-label, .form-group.has-value .form-label { top: -10px; font-size: 12px; color: var(--primary-500); }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal { position: fixed; inset: 0; background-color: rgba(30, 41, 59, 0.5); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; padding: 15px; }
        .modal-content { background-color: var(--neutral-0); border-radius: 12px; padding: 25px; min-width: 300px; max-width: 500px; width: 100%; box-shadow: var(--shadow-md); animation: scaleIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-400); }
        #toast-container { position: fixed; bottom: 85px; right: 20px; z-index: 3000; } /* Adjusted position for bottom nav */
        .toast { padding: 15px 20px; border-radius: 8px; color: var(--neutral-0); margin-top: 10px; box-shadow: var(--shadow-md); animation: slideIn 0.3s ease; }
        .toast.success { background-color: var(--success-500); }
        .toast.error { background-color: var(--danger-500); }
        .toast.warning { background-color: var(--warning-500); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @media (min-width: 768px) { #toast-container { bottom: 20px; } }
        /* NEW: Tab styles */
        .tabs { display: flex; border-bottom: 1px solid var(--neutral-200); margin-bottom: 20px; }
        .tab-link { padding: 10px 15px; cursor: pointer; font-weight: 500; color: var(--neutral-600); border-bottom: 2px solid transparent; }
        .tab-link.active { color: var(--primary-500); border-bottom-color: var(--primary-500); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        /* NEW: Switch toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--neutral-200); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-500); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* === 4. TAMPILAN SPESIFIK HALAMAN (UPDATED & NEW) === */
        /* Kasir */
        .kasir-container { display: grid; grid-template-columns: 1fr; gap: 20px; height: calc(100vh - 80px); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 5px; }
        .product-card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; overflow: hidden; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-card.out-of-stock { opacity: 0.5; cursor: not-allowed; }
        .product-card.out-of-stock::after { content: 'Stok Habis'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .product-card-stock { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.5); color: white; padding: 2px 6px; font-size: 10px; font-weight: 600; border-radius: 4px; }
        .product-card img { width: 100%; height: 100px; object-fit: cover; background-color: var(--neutral-200); }
        .product-card-info { padding: 10px; }
        .product-card-info h4 { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .product-card-info p { font-size: 12px; color: var(--primary-500); font-weight: 500; }
        #cart-summary-bar { position: fixed; bottom: 65px; left: 0; right: 0; background-color: var(--primary-500); color: var(--neutral-0); padding: 15px; display: none; justify-content: space-between; align-items: center; cursor: pointer; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cart-item-controls { display: flex; align-items: center; gap: 8px; }
        .cart-item-controls button { background: var(--neutral-200); border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        @media (min-width: 1200px) {
            .kasir-container { grid-template-columns: 2fr 1.2fr; height: calc(100vh - 40px); }
            .cart-container { display: flex !important; flex-direction: column; }
            #cart-summary-bar { display: none !important; }
        }
        
        /* Tabel Responsif (UNCHANGED) */
        .table-wrapper { overflow-x: auto; }
        .responsive-table { width: 100%; border-collapse: collapse; }
        .responsive-table th, .responsive-table td { padding: 12px 15px; text-align: left; }
        .responsive-table thead { background-color: var(--neutral-50); }
        .responsive-table tbody tr { border-bottom: 1px solid var(--neutral-200); }
        .responsive-table .actions { display: flex; gap: 5px; }
        .stock-badge { padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .stock-badge.low { background-color: var(--warning-100); color: var(--warning-700); }
        .stock-badge.out { background-color: var(--danger-100); color: var(--danger-700); }
        .stock-badge.ok { background-color: var(--success-100); color: var(--success-700); }
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; background: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid var(--neutral-100); padding: 10px 0; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 15px; }
        }
        
        /* NEW: F&B Table Management */
        .table-map-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px; padding: 10px; }
        .table-object { border: 2px solid var(--neutral-200); border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .table-object:hover { box-shadow: var(--shadow-md); transform: translateY(-3px); }
        .table-object.available { background-color: var(--neutral-0); }
        .table-object.occupied { background-color: var(--warning-100); border-color: var(--warning-500); }
        .table-object h4 { font-size: 18px; margin-bottom: 5px; }
        .table-object span { font-size: 12px; color: var(--neutral-600); }
        .table-object.occupied span { color: var(--warning-700); font-weight: 500; }

        /* NEW: Analytics Dashboard */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 12px; padding: 15px; }
        .stat-card h4 { font-size: 14px; font-weight: 500; color: var(--neutral-600); margin-bottom: 8px; }
        .stat-card p { font-size: 20px; font-weight: 700; }
        .chart-container { height: 350px; } /* Set a fixed height for chart containers */

        /* NEW: Promotion Badge */
        .promo-badge { background-color: var(--info-100); color: var(--primary-600); font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fa-solid fa-bolt"></i>
                <h2 id="store-name-sidebar"></h2>
            </div>
            <ul class="sidebar-menu"></ul>
        </nav>

        <main class="main-content">
            <div id="page-content"></div>
        </main>

        <nav class="bottom-nav"></nav>
        
        <div id="modal-container" class="modal"></div>
        <div id="toast-container"></div>
    </div>

<script>
// --- APLIKASI POS PROFESIONAL V2 (SINGLE-FILE) ---
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        // === 1. STATE & INISIALISASI ===
        state: { 
            currentPage: 'beranda', 
            currentUserRole: 'admin', 
            cart: [], // Used for Retail mode or Take Away in F&B
            products: [], 
            customers: [], 
            transactions: [], 
            expenses: [], 
            stockHistory: [],
            // NEW F&B State
            tables: [], // { id, name, orderId }
            activeOrders: {}, // { orderId: { items: [], customerId, ... } }
            // NEW Promotions State
            promotions: [],
            settings: {},
            // REFACTORED: activeTransaction holds context for the CURRENT checkout session
            activeTransaction: {
                orderId: null, // Can be a table orderId or a temporary cart ID
                customerId: null,
                customerName: 'Pelanggan Umum'
            }
        },
        elements: {},
        charts: {}, // To hold chart instances
        
        init() {
            this.initData();
            this.injectBaseHTML();
            this.cacheDOMElements();
            this.applySettings();
            this.attachEventListeners();
            this.showPage(this.state.currentPage || 'beranda');
        },

        initData() {
            const defaultSettings = { 
                namaToko: 'Kopi Pagi V2', pemilik: 'Budi Gunawan', alamatToko: 'Jl. Digital No. 1, Semarang', 
                pesanDiStruk: 'Terima kasih telah berbelanja!', teleponToko: '081234567890', lowStockThreshold: 10,
                posMode: 'retail' // NEW: 'retail' or 'fnb'
            };
            try {
                this.state.settings = this.getFromLocalStorage('settings', defaultSettings);
                this.state.products = this.getFromLocalStorage('products', [ 
                    { id: 1, name: 'Kopi Susu Gula Aren', category: 'Kopi', price: 18000, cost: 10000, stock: 50 }, 
                    { id: 2, name: 'Croissant Coklat', category: 'Roti', price: 22000, cost: 12000, stock: 8 },
                    { id: 3, name: 'Americano', category: 'Kopi', price: 15000, cost: 7000, stock: 20 }, 
                    { id: 4, name: 'Teh Lemon', category: 'Non-Kopi', price: 12000, cost: 5000, stock: 30 },
                ]);
                this.state.customers = this.getFromLocalStorage('customers', []);
                this.state.transactions = this.getFromLocalStorage('transactions', []);
                this.state.expenses = this.getFromLocalStorage('expenses', []);
                this.state.stockHistory = this.getFromLocalStorage('stockHistory', []);
                this.state.cart = this.getFromLocalStorage('cart', []);
                // NEW: Load F&B and Promo data
                this.state.tables = this.getFromLocalStorage('tables', [
                    { id: 'T1', name: 'Meja 1', orderId: null }, { id: 'T2', name: 'Meja 2', orderId: null },
                    { id: 'T3', name: 'Meja 3', orderId: null }, { id: 'T4', name: 'Meja 4', orderId: null },
                ]);
                this.state.activeOrders = this.getFromLocalStorage('activeOrders', {});
                this.state.promotions = this.getFromLocalStorage('promotions', []);
                this.state.currentPage = this.getFromLocalStorage('currentPage', 'beranda');
            } catch (e) {
                console.error("Gagal memuat data dari localStorage:", e);
                if (confirm("Data aplikasi tampaknya rusak. Apakah Anda ingin mereset ke pengaturan awal? Data yang ada akan hilang.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            this.saveAllData();
        },

        injectBaseHTML() {
            const menuItems = [
                { id: 'beranda', icon: 'fa-solid fa-store', label: 'Beranda', role: 'all' },
                { id: 'meja', icon: 'fa-solid fa-utensils', label: 'Meja', role: 'all', mode: 'fnb' },
                { id: 'kasir', icon: 'fa-solid fa-cash-register', label: 'Kasir', role: 'all', mode: 'retail' },
                { id: 'produk', icon: 'fa-solid fa-box-open', label: 'Produk', role: 'admin' },
                { id: 'analitik', icon: 'fa-solid fa-chart-line', label: 'Analitik', role: 'admin' },
                { id: 'lainnya', icon: 'fa-solid fa-ellipsis', label: 'Lainnya', role: 'all', mobileOnly: true },
                { id: 'pelanggan', icon: 'fa-solid fa-users', label: 'Pelanggan', role: 'admin' },
                { id: 'biaya', icon: 'fa-solid fa-wallet', label: 'Biaya', role: 'admin' },
                { id: 'pengaturan', icon: 'fa-solid fa-gear', label: 'Pengaturan', role: 'admin' }
            ];
            
            const isFnbMode = this.state.settings.posMode === 'fnb';
            
            const sidebarMenu = document.querySelector('.sidebar-menu');
            sidebarMenu.innerHTML = menuItems
                .filter(item => !item.mobileOnly)
                .filter(item => !item.mode || (item.mode === 'fnb' && isFnbMode) || (item.mode === 'retail' && !isFnbMode))
                .map(item => `<li data-role="${item.role}"><a href="#" class="nav-link" data-page="${item.id}"><i class="${item.icon}"></i><span>${item.label}</span></a></li>`)
                .join('');
            
            const mobileMenuIds = isFnbMode ? ['beranda', 'meja', 'produk', 'lainnya'] : ['beranda', 'kasir', 'produk', 'lainnya'];
            const bottomNav = document.querySelector('.bottom-nav');
            bottomNav.innerHTML = menuItems
                .filter(item => mobileMenuIds.includes(item.id))
                .filter(item => !item.mode || (item.mode === 'fnb' && isFnbMode) || (item.mode === 'retail' && !isFnbMode))
                .map(item => `<a href="#" class="bottom-nav-link nav-link" data-page="${item.id}" data-role="${item.role}"><i class="${item.icon}"></i><span>${item.label}</span></a>`)
                .join('');
        },

        cacheDOMElements() {
            this.elements = {
                pageContent: document.getElementById('page-content'), modalContainer: document.getElementById('modal-container'),
                toastContainer: document.getElementById('toast-container'), sidebarStoreName: document.getElementById('store-name-sidebar'),
            };
        },
        
        attachEventListeners() {
            // Use event delegation on the body for dynamically added elements
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.nav-link, .nav-link-dynamic');
                if (navLink) { 
                    e.preventDefault(); 
                    this.showPage(navLink.dataset.page); 
                    return;
                }
                
                const actionEl = e.target.closest('[data-action]');
                if(actionEl) {
                    e.preventDefault();
                    this.handleAction(actionEl.dataset.action, actionEl.dataset.id || actionEl.dataset.value, actionEl);
                    return;
                }
                
                // NEW: Tab switching
                const tabLink = e.target.closest('.tab-link');
                if (tabLink) {
                    const target = tabLink.dataset.target;
                    tabLink.parentElement.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                    tabLink.closest('.page-container').querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tabLink.classList.add('active');
                    document.getElementById(target).classList.add('active');
                    return;
                }
            });

            document.addEventListener('keydown', e => { 
                if (e.key === 'Escape') this.closeModal(); 
                if (this.state.currentPage === 'kasir') {
                    if (e.key === 'F1') { e.preventDefault(); document.getElementById('kasir-search-input')?.focus(); }
                    if (e.key === 'F9' && this.getCurrentCartItems().length > 0) { e.preventDefault(); this.openPaymentModal(); }
                }
            });
        },

        attachPageSpecificEventListeners(pageId) {
             // Destroy old charts to prevent memory leaks
            Object.values(this.charts).forEach(chart => chart.destroy());
            this.charts = {};

            switch(pageId) {
                case 'beranda':
                    // Attach any event listeners for the new Beranda page if needed
                    break;
                case 'kasir':
                case 'meja': // Kasir view is used by Meja as well
                    const searchInput = document.getElementById('kasir-search-input');
                    if (searchInput) searchInput.addEventListener('input', e => this.renderProductGrid(e.target.value));
                    
                    const productGrid = document.getElementById('product-grid');
                    if(productGrid) productGrid.addEventListener('click', e => { 
                        const card = e.target.closest('.product-card:not(.out-of-stock)'); 
                        if (card) this.addToCart(parseInt(card.dataset.id)); 
                    });
                    
                    const btnBayar = document.getElementById('btn-bayar');
                    if(btnBayar) btnBayar.addEventListener('click', () => this.openPaymentModal());
                    
                    const summaryBar = document.getElementById('cart-summary-bar');
                    if(summaryBar) summaryBar.addEventListener('click', () => this.openPaymentModal());

                    this.renderProductGrid();
                    this.renderCart();
                    break;
                case 'analitik':
                    document.getElementById('generate-report-btn').addEventListener('click', () => this.renderAnalyticsCharts());
                    this.renderAnalyticsCharts(); // Initial render
                    break;
                // Other pages...
                case 'produk':
                    document.getElementById('product-search').addEventListener('input', e => this.renderProductTable(e.target.value));
                    break;
            }
        },
        
        handleAction(action, id, element) {
            const value = id; // For clarity
            switch(action) {
                // Navigation & Modals
                case 'showPage': this.showPage(value); break;
                case 'addProduct': this.showProductModal(); break;
                case 'editProduct': this.showProductModal(value); break;
                case 'deleteProduct': this.deleteProduct(value); break;
                // NEW: Promotions
                case 'addPromo': this.showPromoModal(); break;
                case 'editPromo': this.showPromoModal(value); break;
                case 'deletePromo': this.deletePromo(value); break;
                // NEW: F&B Actions
                case 'openTableOrder': this.openTableOrder(value); break;
                case 'showTableEditor': this.showTableEditorModal(); break;
                case 'saveTableLayout': this.saveTableLayout(); break;
                case 'openTakeAway': this.openTakeAwayOrder(); break;
                // Cart Actions
                case 'updateCartQty': this.updateCartQuantity(value, parseInt(element.dataset.change)); break;
                case 'removeFromCart': this.updateCartQuantity(value, -Infinity); break;
                // Payment & Checkout
                case 'showCustomerSelection': this.showCustomerSelectionModal(); break;
                case 'openSplitBill': this.showSplitBillModal(); break;
                // Settings
                case 'saveSettings': this.saveSettings(); break;
                case 'changePosMode': this.changePosMode(element.checked); break;
                // ... other actions
                default: console.warn('Unhandled action:', action);
            }
        },

        // === 2. UTILITIES (mostly unchanged) ===
        saveAllData() { for (const key in this.state) { this.saveToLocalStorage(key, this.state[key]); } },
        getFromLocalStorage(key, defaultValue) { const data = localStorage.getItem(key); if (!data) return defaultValue; try { return JSON.parse(data); } catch { return defaultValue; } },
        saveToLocalStorage: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        formatRupiah: (number) => `Rp ${new Intl.NumberFormat('id-ID').format(number)}`,
        formatDate: (isoString) => new Date(isoString).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
        applySettings() { document.title = `${this.state.settings.namaToko} - POS`; if(this.elements.sidebarStoreName) this.elements.sidebarStoreName.textContent = this.state.settings.namaToko; },
        showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; this.elements.toastContainer.appendChild(toast); setTimeout(() => { toast.remove(); }, 3000); },
        showModal(title, contentHTML, onConfirm, confirmText = 'Simpan', onConfirmShouldClose = true) {
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <div class="modal-header"><h2>${title}</h2><button class="close-modal">&times;</button></div>
                <form id="modal-form" novalidate>${contentHTML}</form>
                <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn btn-secondary close-modal">Batal</button>
                    ${onConfirm ? `<button type="button" class="btn btn-primary" id="modal-confirm">${confirmText}</button>` : ''}
                </div>`;
            this.elements.modalContainer.innerHTML = '';
            this.elements.modalContainer.appendChild(modalContent);
            this.elements.modalContainer.style.display = 'flex';
            
            modalContent.querySelectorAll('.form-input').forEach(input => {
                if (input.value || input.type === 'date' || document.activeElement === input) { input.parentElement.classList.add('has-value'); }
            });
            const modalForm = document.getElementById('modal-form');
            if (onConfirm) {
                const confirmBtn = document.getElementById('modal-confirm');
                confirmBtn.addEventListener('click', () => { 
                    if (modalForm && !modalForm.checkValidity()) { modalForm.reportValidity(); this.showToast('Mohon isi semua kolom yang wajib diisi.', 'error'); return; }
                    const result = onConfirm();
                    if(onConfirmShouldClose && result !== false) this.closeModal(); 
                });
                if(modalForm) modalForm.addEventListener('submit', (e) => { e.preventDefault(); confirmBtn.click(); });
            }
            this.elements.modalContainer.querySelectorAll('.close-modal').forEach(el => el.addEventListener('click', () => this.closeModal()));
        },
        showConfirmModal(title, message, onConfirm) { this.showModal(title, `<p>${message}</p>`, () => { onConfirm(); return true; }, "Ya, Lanjutkan", true); },
        closeModal() { this.elements.modalContainer.style.display = 'none'; this.elements.modalContainer.innerHTML = ''; },

        // === 3. NAVIGASI & RENDER HALAMAN ===
        showPage(pageId) {
            if (!pageId) return;
            // REFACTORED: Centralized navigation logic
            const isFnbMode = this.state.settings.posMode === 'fnb';
            const targetPage = pageId === 'kasir' && isFnbMode ? 'meja' : pageId;

            // Update active links
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll(`.nav-link[data-page="${targetPage}"]`).forEach(l => l.classList.add('active'));
            
            this.state.currentPage = targetPage;
            this.saveToLocalStorage('currentPage', targetPage);
            
            const pageRenderers = {
                beranda: this.renderBeranda, 
                kasir: this.renderKasir,
                produk: this.renderProduk, 
                analitik: this.renderAnalitik,
                lainnya: this.renderLainnya, 
                pelanggan: this.renderPelanggan,
                biaya: this.renderBiaya, 
                pengaturan: this.renderPengaturan,
                meja: this.renderMeja, // F&B main page
            };
            
            const renderer = pageRenderers[targetPage];

            if (renderer) {
                const pageHTML = renderer.call(this);
                this.elements.pageContent.innerHTML = pageHTML;
                this.attachPageSpecificEventListeners(targetPage);
            } else {
                this.elements.pageContent.innerHTML = `<div class="page-container"><div class="card">Halaman "${targetPage}" tidak ditemukan.</div></div>`;
            }
        },

        // === 4. FUNGSI RENDER HALAMAN (REFACTORED & NEW) ===
        
        renderBeranda() {
            const today = new Date().toISOString().slice(0, 10);
            const todayTrx = this.state.transactions.filter(t => t.date.startsWith(today));
            const revenueToday = todayTrx.reduce((sum, t) => sum + t.finalTotal, 0);
            const lowStockProducts = this.state.products.filter(p => p.stock > 0 && p.stock <= this.state.settings.lowStockThreshold);
            const activeTables = Object.values(this.state.tables).filter(t => t.orderId).length;

            const quickActionTarget = this.state.settings.posMode === 'fnb' ? 'meja' : 'kasir';
            const quickActionIcon = this.state.settings.posMode === 'fnb' ? 'fa-utensils' : 'fa-cash-register';

            return `
            <div class="page-container">
                <header class="header">
                  <h1>Selamat Datang, ${this.state.settings.pemilik.split(' ')[0]}!</h1>
                </header>
                <div class="stats-grid">
                    <div class="stat-card"><h4>Pendapatan Hari Ini</h4><p>${this.formatRupiah(revenueToday)}</p></div>
                    <div class="stat-card"><h4>Transaksi Hari Ini</h4><p>${todayTrx.length}</p></div>
                    ${this.state.settings.posMode === 'fnb' ? `<div class="stat-card"><h4>Meja Terisi</h4><p>${activeTables}</p></div>` : ''}
                    <div class="stat-card"><h4>Stok Menipis</h4><p>${lowStockProducts.length}</p></div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 20px;">Aksi Cepat</h3>
                    <div class="quick-actions-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center;">
                        <a href="#" class="action-button nav-link-dynamic" data-page="${quickActionTarget}" style="color: var(--neutral-800); text-decoration:none;">
                            <span class="action-button-icon" style="width:60px; height:60px; background-color: var(--neutral-100); color: var(--primary-500); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid ${quickActionIcon}"></i></span>
                            <span style="display:block; margin-top:8px; font-weight:500;">Mulai Transaksi</span>
                        </a>
                        <a href="#" class="action-button" data-action="addProduct" style="color: var(--neutral-800); text-decoration:none;">
                            <span class="action-button-icon" style="width:60px; height:60px; background-color: var(--neutral-100); color: var(--primary-500); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid fa-plus"></i></span>
                            <span style="display:block; margin-top:8px; font-weight:500;">Tambah Produk</span>
                        </a>
                        <a href="#" class="action-button nav-link-dynamic" data-page="analitik" style="color: var(--neutral-800); text-decoration:none;">
                            <span class="action-button-icon" style="width:60px; height:60px; background-color: var(--neutral-100); color: var(--primary-500); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid fa-chart-line"></i></span>
                            <span style="display:block; margin-top:8px; font-weight:500;">Lihat Analitik</span>
                        </a>
                    </div>
                </div>
            </div>`;
        },

        renderAnalitik() {
            const today = new Date().toISOString().slice(0, 10);
            return `
            <div class="page-container">
                <header class="header"><h1>Analitik & Laporan</h1></header>
                <div class="card">
                    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                        <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                            <div class="form-group" style="margin-bottom:0;"><input type="date" id="report-start" class="form-input" value="${today}"><label class="form-label">Mulai</label></div>
                            <div class="form-group" style="margin-bottom:0;"><input type="date" id="report-end" class="form-input" value="${today}"><label class="form-label">Selesai</label></div>
                        </div>
                        <button id="generate-report-btn" class="btn btn-primary"><i class="fa-solid fa-arrows-rotate"></i> Tampilkan</button>
                    </div>
                </div>
                <div id="report-results">
                  <div class="stats-grid" id="analytics-summary"></div>
                  <div class="card">
                    <h3 style="margin-bottom:20px;">Tren Penjualan</h3>
                    <div class="chart-container"><canvas id="sales-trend-chart"></canvas></div>
                  </div>
                  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                      <div class="card">
                        <h3 style="margin-bottom:20px;">Produk Terlaris</h3>
                        <div class="chart-container"><canvas id="top-products-chart"></canvas></div>
                      </div>
                      <div class="card">
                        <h3 style="margin-bottom:20px;">Jam Tersibuk</h3>
                        <div class="chart-container"><canvas id="busy-hours-chart"></canvas></div>
                      </div>
                  </div>
                </div>
            </div>`;
        },
        
        renderMeja() { // NEW Page for F&B Mode
            const tablesHTML = this.state.tables.map(table => {
                const isOccupied = table.orderId && this.state.activeOrders[table.orderId];
                const order = isOccupied ? this.state.activeOrders[table.orderId] : null;
                const total = order ? this.calculateCartTotals(order.items).finalTotal : 0;
                
                return `
                <div class="table-object ${isOccupied ? 'occupied' : 'available'}" data-action="openTableOrder" data-id="${table.id}">
                    <h4>${table.name}</h4>
                    <span>${isOccupied ? this.formatRupiah(total) : 'Kosong'}</span>
                </div>`;
            }).join('');

            return `
            <div class="page-container">
                <header class="header">
                  <h1>Manajemen Meja</h1>
                  <div>
                    <button class="btn btn-secondary" data-action="showTableEditor"><i class="fa-solid fa-pen-ruler"></i> Atur Meja</button>
                    <button class="btn btn-primary" data-action="openTakeAway"><i class="fa-solid fa-shopping-bag"></i> Bawa Pulang</button>
                  </div>
                </header>
                <div class="card">
                  <div class="table-map-container">
                    ${tablesHTML}
                  </div>
                </div>
            </div>`;
        },

        renderKasir(options = {}) {
            const { isTakeAway = false, orderName = 'Keranjang' } = options;
            const title = isTakeAway ? `Pesanan Bawa Pulang` : `Kasir`;

            return `
            <div class="kasir-container page-container">
                <div class="card product-section" style="padding: 15px; display:flex; flex-direction:column;">
                    <div style="margin-bottom:15px;"><input type="text" id="kasir-search-input" class="form-input" placeholder="Cari produk (F1)..."></div>
                    <div id="product-grid" class="product-grid" style="flex-grow:1;"></div>
                </div>
                <div id="cart-container" class="card cart-container" style="display:none;">
                    <h3 style="margin-bottom:15px;">${orderName}</h3>
                    <div id="cart-items" style="flex-grow:1; overflow-y:auto; padding-right:10px;"></div>
                    <div id="cart-total" style="margin-top:auto; padding-top:15px; border-top:1px solid var(--neutral-200);"></div>
                    <div id="cart-actions" style="display:flex; gap:10px; margin-top:15px;">
                      ${ this.state.settings.posMode === 'fnb' ? `<button id="btn-split-bill" class="btn btn-secondary" style="width:100%;" data-action="openSplitBill" disabled>Bagi Tagihan</button>` : '' }
                      <button id="btn-bayar" class="btn btn-primary" style="width:100%;" disabled>Bayar (F9)</button>
                    </div>
                </div>
            </div>
            <div id="cart-summary-bar"></div>`;
        },
        
        renderProductGrid(searchTerm = '') {
            const grid = document.getElementById('product-grid');
            if(!grid) return;
            const term = searchTerm.toLowerCase();
            const filteredProducts = this.state.products.filter(p => p.name.toLowerCase().includes(term));
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = `<p style="color: var(--neutral-400); text-align:center; width:100%;">Produk tidak ditemukan.</p>`; return;
            }
            
            grid.innerHTML = filteredProducts.map(p => `
                <div class="product-card ${p.stock <= 0 ? 'out-of-stock' : ''}" data-id="${p.id}">
                    <div class="product-card-stock">Stok: ${p.stock}</div>
                    <div class="product-card-info">
                        <h4>${p.name}</h4>
                        <p>${this.formatRupiah(p.price)}</p>
                    </div>
                </div>`).join('');
        },

        renderPengaturan() {
            const { settings } = this.state;
            return `
            <div class="page-container">
                <header class="header"><h1>Pengaturan</h1></header>
                <div style="max-width: 700px; margin: 0 auto;">
                    <div class="tabs">
                        <span class="tab-link active" data-target="tab-toko">Toko</span>
                        <span class="tab-link" data-target="tab-promo">Promosi</span>
                    </div>
                    <div id="tab-toko" class="tab-content active">
                        <div class="card">
                            <h3 style="margin-bottom:20px;">Mode Operasional</h3>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>Mode F&B (Manajemen Meja)</strong>
                                    <p style="font-size:14px; color:var(--neutral-600);">Aktifkan untuk kafe atau restoran.</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="pos-mode-toggle" ${settings.posMode === 'fnb' ? 'checked' : ''} data-action="changePosMode">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="card">
                            <h3 style="margin-bottom:20px;">Informasi Toko</h3>
                            <div class="form-group"><input type="text" id="s-namaToko" class="form-input" value="${settings.namaToko}" required placeholder=" "><label class="form-label">Nama Toko</label></div>
                            <div class="form-group"><input type="text" id="s-pemilik" class="form-input" value="${settings.pemilik}" placeholder=" "><label class="form-label">Nama Pemilik</label></div>
                            <div class="form-group"><input type="number" id="s-lowStockThreshold" class="form-input" value="${settings.lowStockThreshold}" placeholder=" " min="0"><label class="form-label">Ambang Batas Stok Rendah</label></div>
                            <div style="text-align:right;"><button class="btn btn-primary" data-action="saveSettings">Simpan Pengaturan</button></div>
                        </div>
                    </div>
                    <div id="tab-promo" class="tab-content">
                        ${this.renderPromoManagementPage()}
                    </div>
                </div>
            </div>`;
        },

        renderPromoManagementPage() {
            const promosHTML = this.state.promotions.map(p => `
                <tr>
                    <td data-label="Nama">${p.name} <span class="promo-badge">${p.type}</span></td>
                    <td data-label="Deskripsi">${p.description}</td>
                    <td data-label="Aksi">
                        <div class="actions">
                            <button class="btn btn-text" data-action="editPromo" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button class="btn btn-text" data-action="deletePromo" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="page-header">
                  <h2>Manajemen Promosi</h2>
                  <button class="btn btn-primary" data-action="addPromo"><i class="fa-solid fa-plus"></i> Tambah Promo</button>
                </div>
                <div class="card" style="padding:0;">
                    <div class="table-wrapper">
                        <table class="responsive-table">
                            <thead><tr><th>Nama Promo</th><th>Deskripsi</th><th>Aksi</th></tr></thead>
                            <tbody>${promosHTML || '<tr><td colspan="3" style="text-align:center;">Belum ada promosi.</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>`;
        },
        
        // --- All other render functions (produk, pelanggan, etc.) are largely unchanged ---
        renderProduk() { return `<div class="page-container"><header class="header"><h1>Manajemen Produk</h1></header><div class="page-header"><input type="text" id="product-search" class="form-input" placeholder="Cari produk..." style="max-width:300px;"><button class="btn btn-primary" data-action="addProduct"><i class="fa-solid fa-plus"></i> Tambah Produk</button></div><div class="card" style="padding:0;"><div class="table-wrapper">${this.renderProductTable()}</div></div></div>`; },
        renderProductTable(filter = '') { const filtered = this.state.products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase())); let tableHTML = `<table class="responsive-table"><thead><tr><th>Nama Produk</th><th>Kategori</th><th>Harga Jual</th><th>Stok</th><th>Aksi</th></tr></thead><tbody>`; if (filtered.length > 0) { filtered.forEach(p => { let stockBadge = `<span class="stock-badge ok">${p.stock}</span>`; if (p.stock <= 0) stockBadge = `<span class="stock-badge out">Habis</span>`; else if (p.stock <= this.state.settings.lowStockThreshold) stockBadge = `<span class="stock-badge low">${p.stock}</span>`; tableHTML += `<tr><td data-label="Nama">${p.name}</td> <td data-label="Kategori">${p.category}</td><td data-label="Harga Jual">${this.formatRupiah(p.price)}</td> <td data-label="Stok">${stockBadge}</td><td data-label="Aksi"><div class="actions"><button class="btn btn-text" data-action="editProduct" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn btn-text" data-action="deleteProduct" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button></div></td></tr>`; }); } else { tableHTML += `<tr><td colspan="5" style="text-align:center;">Belum ada data produk.</td></tr>`; } tableHTML += `</tbody></table>`; return tableHTML; },
        renderLainnya() { return `<div class="page-container"><header class="header"><h1>Menu Lainnya</h1></header><ul class="lainnya-menu" style="list-style:none;"><li class="lainnya-menu-item"><a href="#" style="display:flex; align-items:center; padding: 20px 15px; background-color: var(--neutral-0); border-bottom:1px solid var(--neutral-200); text-decoration:none; color:var(--neutral-800);" class="nav-link-dynamic" data-page="analitik"><i class="fa-solid fa-chart-line" style="margin-right:15px; width:24px; text-align:center;"></i>Analitik</a></li><li class="lainnya-menu-item"><a href="#" style="display:flex; align-items:center; padding: 20px 15px; background-color: var(--neutral-0); border-bottom:1px solid var(--neutral-200); text-decoration:none; color:var(--neutral-800);" class="nav-link-dynamic" data-page="pelanggan"><i class="fa-solid fa-users" style="margin-right:15px; width:24px; text-align:center;"></i>Pelanggan</a></li><li class="lainnya-menu-item"><a href="#" style="display:flex; align-items:center; padding: 20px 15px; background-color: var(--neutral-0); border-bottom:1px solid var(--neutral-200); text-decoration:none; color:var(--neutral-800);" class="nav-link-dynamic" data-page="biaya"><i class="fa-solid fa-wallet" style="margin-right:15px; width:24px; text-align:center;"></i>Biaya</a></li><li class="lainnya-menu-item"><a href="#" style="display:flex; align-items:center; padding: 20px 15px; background-color: var(--neutral-0); text-decoration:none; color:var(--neutral-800);" class="nav-link-dynamic" data-page="pengaturan"><i class="fa-solid fa-gear" style="margin-right:15px; width:24px; text-align:center;"></i>Pengaturan</a></li></ul></div>`; },
        // ... (other simple renderers like pelanggan, biaya can remain as they were)

        // === 5. CORE LOGIC (CART, PAYMENT, etc. - HEAVILY REFACTORED) ===

        // REFACTORED: Get current active cart items (from activeOrders or global cart)
        getCurrentCartItems() {
            if (this.state.activeTransaction.orderId) {
                const order = this.state.activeOrders[this.state.activeTransaction.orderId];
                return order ? order.items : [];
            }
            return this.state.cart;
        },
        
        // REFACTORED: Save current cart state
        saveCurrentCart(items) {
            if (this.state.activeTransaction.orderId) {
                if (this.state.activeOrders[this.state.activeTransaction.orderId]) {
                    this.state.activeOrders[this.state.activeTransaction.orderId].items = items;
                    this.saveToLocalStorage('activeOrders', this.state.activeOrders);
                }
            } else {
                this.state.cart = items;
                this.saveToLocalStorage('cart', this.state.cart);
            }
        },

        addToCart(productId) {
            const product = this.state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) return;
            
            let currentCart = [...this.getCurrentCartItems()]; // Create a mutable copy
            const cartItem = currentCart.find(item => item.id === productId);

            if (cartItem) {
                if(cartItem.quantity < product.stock) { 
                    cartItem.quantity++;
                } else {
                    this.showToast(`Stok ${product.name} tidak mencukupi.`, 'warning');
                }
            } else {
                currentCart.push({ ...product, quantity: 1 });
            }
            
            this.saveCurrentCart(currentCart);
            this.renderCart();
        },

        updateCartQuantity(productId, change) {
            let currentCart = [...this.getCurrentCartItems()];
            const cartItemIndex = currentCart.findIndex(item => item.id == productId);
            if (cartItemIndex === -1) return;

            const cartItem = currentCart[cartItemIndex];

            if (change === -Infinity || (cartItem.quantity + change <= 0)) {
                currentCart.splice(cartItemIndex, 1);
            } else {
                const product = this.state.products.find(p => p.id == productId);
                const newQuantity = cartItem.quantity + change;
                if (product && newQuantity > product.stock) {
                    this.showToast(`Stok ${product.name} tidak mencukupi.`, 'warning');
                    return;
                }
                cartItem.quantity = newQuantity;
            }
            
            this.saveCurrentCart(currentCart);
            this.renderCart();
        },
        
        renderCart() {
            const container = document.getElementById('cart-items');
            if (!container) return;

            const items = this.getCurrentCartItems();
            const { subtotal, totalDiscount, finalTotal, appliedPromos } = this.calculateCartTotals(items);
            
            container.innerHTML = items.length ? items.map(item => {
                let priceDisplay = `<div style="text-align:right;">
                    <strong style="font-weight: 500;">${this.formatRupiah(item.price * item.quantity)}</strong>
                  </div>`;
                if(item.originalPrice) {
                    priceDisplay = `<div style="text-align:right;">
                        <strong style="color: var(--success-700);">${this.formatRupiah(item.price * item.quantity)}</strong>
                        <del style="font-size:12px; color: var(--neutral-400);">${this.formatRupiah(item.originalPrice * item.quantity)}</del>
                    </div>`;
                }
                
                return `<div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--neutral-100);">
                    <div>
                        <strong style="display:block; margin-bottom: 4px; font-size: 14px;">${item.name}</strong>
                        <div class="cart-item-controls">
                            <button data-action="updateCartQty" data-id="${item.id}" data-change="-1">-</button>
                            <span>${item.quantity}</span>
                            <button data-action="updateCartQty" data-id="${item.id}" data-change="1">+</button>
                            <button data-action="removeFromCart" data-id="${item.id}" style="margin-left:10px; color: var(--danger-500); background: transparent;"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    ${priceDisplay}
                </div>`
            }).join('') : `<p style="color: var(--neutral-400); text-align:center; padding: 20px 0;">Keranjang kosong</p>`;
            
            const totalEl = document.getElementById('cart-total');
            if (totalEl) {
                totalEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom: 5px;"><span>Subtotal:</span><span>${this.formatRupiah(subtotal)}</span></div>
                    ${totalDiscount > 0 ? `<div style="display:flex; justify-content:space-between; margin-bottom: 10px; color:var(--success-700);"><span>Diskon:</span><span>-${this.formatRupiah(totalDiscount)}</span></div>` : ''}
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size: 1.2em;"><strong>Total:</strong> <strong>${this.formatRupiah(finalTotal)}</strong></div>
                `;
            }

            const btnBayar = document.getElementById('btn-bayar');
            if(btnBayar) btnBayar.disabled = items.length === 0;
            const btnSplitBill = document.getElementById('btn-split-bill');
            if(btnSplitBill) btnSplitBill.disabled = items.length === 0;

            const summaryBar = document.getElementById('cart-summary-bar');
            if (summaryBar) {
                if(items.length > 0) {
                    summaryBar.style.display = 'flex';
                    summaryBar.innerHTML = `<span>${items.reduce((t,i) => t+i.quantity, 0)} item (${this.formatRupiah(finalTotal)})</span><strong>Lihat Keranjang & Bayar &nbsp; &rsaquo;</strong>`;
                } else {
                    summaryBar.style.display = 'none';
                }
            }
        },
        
        openPaymentModal(itemsToPay) {
            const items = itemsToPay || this.getCurrentCartItems();
            if (items.length === 0) return;
            const { finalTotal } = this.calculateCartTotals(items);
            
            const content = `<div style="text-align:center; margin-bottom:20px;"><span style="font-size: 14px; color: var(--neutral-600);">Total Tagihan</span><h3 style="font-size: 32px; color: var(--primary-500);">${this.formatRupiah(finalTotal)}</h3></div><div class="form-group"><input type="number" id="p-paid" class="form-input" placeholder=" " required min="${finalTotal}"><label class="form-label">Jumlah Dibayar</label></div> <div style="text-align:center; margin-top: -15px;"><span style="font-size: 14px; color: var(--neutral-600);">Kembalian</span><h3 id="payment-change" style="font-size: 24px;">${this.formatRupiah(0)}</h3></div><hr style="margin: 20px 0;"><div style="display:flex; justify-content:space-between; align-items:center;"><span>Pelanggan: <strong>${this.state.activeTransaction.customerName}</strong></span><button type="button" class="btn btn-secondary" data-action="showCustomerSelection">Ganti</button></div>`;
            this.showModal('Pembayaran', content, () => this.processPayment(items), 'Proses Pembayaran');
            
            const paidInput = document.getElementById('p-paid');
            const changeEl = document.getElementById('payment-change');
            paidInput.addEventListener('input', () => {
                const paidAmount = parseFloat(paidInput.value) || 0;
                const change = paidAmount - finalTotal;
                changeEl.textContent = this.formatRupiah(change >= 0 ? change : 0);
            });
        },
        
        processPayment(paidItems) {
            const { finalTotal, subtotal } = this.calculateCartTotals(paidItems);
            const paidInput = document.getElementById('p-paid');
            if (!paidInput || !paidInput.value) { this.showToast('Masukkan jumlah uang dibayar!', 'error'); return false; }
            const paidAmount = parseFloat(paidInput.value);
            if(isNaN(paidAmount) || paidAmount < finalTotal) { this.showToast('Jumlah bayar tidak cukup!', 'error'); return false; }

            // Reduce stock
            paidItems.forEach(item => {
                const product = this.state.products.find(p => p.id === item.id);
                if(product) {
                    const oldStock = product.stock;
                    product.stock -= item.quantity;
                    this.addStockLog(product.id, -item.quantity, oldStock, product.stock, `Penjualan #${'TRX-' + Date.now()}`);
                }
            });

            // Create transaction record
            const newTransaction = { id: 'TRX-' + Date.now(), date: new Date().toISOString(), items: paidItems, subtotal, finalTotal, customerId: this.state.activeTransaction.customerId, customerName: this.state.activeTransaction.customerName };
            this.state.transactions.unshift(newTransaction);
            
            // Handle clearing the cart/order
            if (this.state.activeTransaction.orderId) {
                const order = this.state.activeOrders[this.state.activeTransaction.orderId];
                if (order) {
                    // Remove paid items from the active order
                    order.items = order.items.filter(orderItem => !paidItems.find(paidItem => paidItem.id === orderItem.id));
                    
                    // If all items are paid, close the order
                    if (order.items.length === 0) {
                        const table = this.state.tables.find(t => t.orderId === this.state.activeTransaction.orderId);
                        if(table) table.orderId = null;
                        delete this.state.activeOrders[this.state.activeTransaction.orderId];
                    }
                }
            } else {
                this.state.cart = []; // Clear retail cart
            }

            // Reset and save
            this.saveAllData();
            this.showToast('Transaksi berhasil!');

            if (this.state.settings.posMode === 'fnb') {
                this.showPage('meja');
            } else {
                this.showPage('kasir');
            }
            return true;
        },

        // === 6. PROMOTIONS LOGIC (NEW) ===
        
        calculateCartTotals(items) {
            const subtotal = items.reduce((sum, item) => sum + (item.originalPrice || item.price) * item.quantity, 0);
            
            // Apply promotions
            const { items: itemsWithPromo, appliedPromos } = this.applyPromotions(items);
            const finalTotal = itemsWithPromo.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const totalDiscount = subtotal - finalTotal;

            return { subtotal, totalDiscount, finalTotal, appliedPromos, items: itemsWithPromo };
        },
        
        applyPromotions(cartItems) {
            let processedItems = JSON.parse(JSON.stringify(cartItems)); // Deep copy
            let appliedPromos = [];
            // Reset any previous promo calculations
            processedItems.forEach(item => {
                if (item.originalPrice) { item.price = item.originalPrice; delete item.originalPrice; }
            });

            // Very simple logic: apply first matching promo. A more complex system could find the best combo.
            for (const promo of this.state.promotions) {
                if (promo.type === 'happy_hour') {
                    const now = new Date();
                    const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday..
                    const currentHour = now.getHours();
                    if (promo.rules.days.includes(currentDay) && currentHour >= promo.rules.startHour && currentHour < promo.rules.endHour) {
                         processedItems.forEach(item => {
                            if (promo.rules.targetCategory === 'Semua' || item.category === promo.rules.targetCategory) {
                                if (!item.originalPrice) { // Don't stack discounts
                                    item.originalPrice = item.price;
                                    item.price = item.price * (1 - promo.discount.value / 100);
                                    appliedPromos.push(promo.name);
                                }
                            }
                        });
                    }
                }
                // Add logic for BOGO and BUNDLE here if needed
            }
            return { items: processedItems, appliedPromos: [...new Set(appliedPromos)] };
        },

        showPromoModal(promoId) {
            const isEdit = promoId !== undefined;
            const promo = isEdit ? this.state.promotions.find(p => p.id == promoId) : { type: 'happy_hour', rules:{}, discount:{} };
            const title = isEdit ? 'Edit Promosi' : 'Tambah Promosi';
            
            const categories = ['Semua', ...new Set(this.state.products.map(p => p.category))];
            
            const content = `
                <div class="form-group"><input type="text" id="promo-name" class="form-input" placeholder=" " value="${promo.name || ''}" required><label class="form-label">Nama Promo</label></div>
                <div class="form-group">
                    <select id="promo-type" class="form-input" disabled><option value="happy_hour">Happy Hour</option></select>
                    <label class="form-label">Tipe Promo</label>
                </div>
                <div id="promo-rules-container">
                    </div>
            `;
            this.showModal(title, content, () => this.savePromotion(promoId));
            
            // Simple Happy Hour form
            const rulesContainer = document.getElementById('promo-rules-container');
            rulesContainer.innerHTML = `
                <p style="font-size:14px; margin-bottom:15px; color:var(--neutral-600)">Atur diskon berdasarkan waktu dan kategori produk.</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                  <div class="form-group"><input type="number" id="promo-start-hour" class="form-input" placeholder=" " value="${promo.rules.startHour || ''}" min="0" max="23" required><label class="form-label">Jam Mulai</label></div>
                  <div class="form-group"><input type="number" id="promo-end-hour" class="form-input" placeholder=" " value="${promo.rules.endHour || ''}" min="0" max="23" required><label class="form-label">Jam Selesai</label></div>
                </div>
                <div class="form-group"><input type="number" id="promo-discount-value" class="form-input" placeholder=" " value="${promo.discount.value || ''}" min="1" max="100" required><label class="form-label">Diskon (%)</label></div>
                <div class="form-group">
                    <select id="promo-target-category" class="form-input">${categories.map(c => `<option value="${c}" ${promo.rules.targetCategory === c ? 'selected' : ''}>${c}</option>`).join('')}</select>
                    <label class="form-label">Kategori Target</label>
                </div>
                 <div class="form-group">
                    <label style="font-size:14px; margin-bottom:10px; display:block;">Hari Berlaku</label>
                    <div style="display:flex; flex-wrap:wrap; gap:10px;">
                        ${['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'].map((day, i) => `
                        <label><input type="checkbox" class="promo-day" value="${i}" ${promo.rules.days && promo.rules.days.includes(i) ? 'checked' : ''}> ${day}</label>
                        `).join('')}
                    </div>
                </div>
            `;
        },

        savePromotion(promoId) {
            const promoData = {
                id: promoId || 'PROMO-' + Date.now(),
                name: document.getElementById('promo-name').value,
                type: document.getElementById('promo-type').value,
                description: '',
                rules: {
                    startHour: parseInt(document.getElementById('promo-start-hour').value),
                    endHour: parseInt(document.getElementById('promo-end-hour').value),
                    targetCategory: document.getElementById('promo-target-category').value,
                    days: Array.from(document.querySelectorAll('.promo-day:checked')).map(el => parseInt(el.value)),
                },
                discount: {
                    type: 'percentage',
                    value: parseFloat(document.getElementById('promo-discount-value').value)
                }
            };
            promoData.description = `Diskon ${promoData.discount.value}% untuk kategori ${promoData.rules.targetCategory} pada jam ${promoData.rules.startHour}-${promoData.rules.endHour}`;
            
            if(promoId) {
                const index = this.state.promotions.findIndex(p => p.id == promoId);
                this.state.promotions[index] = promoData;
            } else {
                this.state.promotions.push(promoData);
            }
            this.saveAllData();
            this.showPage('pengaturan');
            this.showToast('Promosi berhasil disimpan!');
            return true;
        },

        deletePromo(promoId) {
            this.showConfirmModal('Hapus Promosi?', 'Anda yakin ingin menghapus promosi ini?', () => {
                this.state.promotions = this.state.promotions.filter(p => p.id != promoId);
                this.saveAllData();
                this.showPage('pengaturan');
                this.showToast('Promosi berhasil dihapus.');
            });
        },


        // === 7. F&B LOGIC (NEW) ===

        openTableOrder(tableId) {
            const table = this.state.tables.find(t => t.id === tableId);
            if(!table) return;

            let orderId = table.orderId;
            if (!orderId) {
                // Create new order for this table
                orderId = 'ORDER-' + Date.now();
                table.orderId = orderId;
                this.state.activeOrders[orderId] = {
                    id: orderId,
                    type: 'dine-in',
                    name: table.name,
                    items: [],
                    customerId: null,
                    customerName: 'Pelanggan Umum',
                    createdAt: new Date().toISOString()
                };
            }
            
            this.state.activeTransaction = {
                orderId: orderId,
                customerId: this.state.activeOrders[orderId].customerId,
                customerName: this.state.activeOrders[orderId].customerName
            };

            this.state.currentPage = 'kasir'; // Set page to kasir but don't save to LS
            this.elements.pageContent.innerHTML = this.renderKasir({ orderName: `Pesanan ${table.name}` });
            this.attachPageSpecificEventListeners('kasir');
        },
        
        openTakeAwayOrder() {
            // Use the global cart for take away, identified by a null orderId
             this.state.activeTransaction = {
                orderId: null, // signifies this is the global retail/takeaway cart
                customerId: null,
                customerName: 'Pelanggan Umum'
            };
            this.state.currentPage = 'kasir'; // Set page to kasir but don't save to LS
            this.elements.pageContent.innerHTML = this.renderKasir({ isTakeAway: true, orderName: 'Bawa Pulang' });
            this.attachPageSpecificEventListeners('kasir');
        },
        
        showSplitBillModal() {
            const items = this.getCurrentCartItems();
            if (items.length === 0) return;
            
            const content = `
                <p>Pilih item yang ingin dibayar sekarang.</p>
                <div id="split-bill-items" style="margin-top:15px; max-height: 300px; overflow-y:auto;">
                ${items.map((item, index) => `
                    <div style="display:flex; align-items:center; padding:10px; border-bottom: 1px solid var(--neutral-100);">
                        <input type="checkbox" id="split-item-${index}" class="split-item-checkbox" data-index="${index}" style="width:20px; height:20px; margin-right:15px;">
                        <label for="split-item-${index}" style="flex-grow:1; display:flex; justify-content:space-between;">
                            <span>${item.name} (x${item.quantity})</span>
                            <strong>${this.formatRupiah(item.price * item.quantity)}</strong>
                        </label>
                    </div>
                `).join('')}
                </div>
                <div style="text-align:right; margin-top:20px;">
                    <span style="color:var(--neutral-600);">Total Dipilih:</span>
                    <h3 id="split-bill-total" style="color:var(--primary-500);">${this.formatRupiah(0)}</h3>
                </div>
            `;
            
            this.showModal('Bagi Tagihan (Split Bill)', content, () => {
                const selectedItems = [];
                document.querySelectorAll('.split-item-checkbox:checked').forEach(checkbox => {
                    selectedItems.push(items[parseInt(checkbox.dataset.index)]);
                });
                if (selectedItems.length > 0) {
                    this.openPaymentModal(selectedItems);
                } else {
                    this.showToast('Pilih minimal satu item untuk dibayar.', 'warning');
                    return false; // Don't close modal
                }
            }, 'Lanjut Bayar');
            
            document.getElementById('split-bill-items').addEventListener('change', () => {
                let total = 0;
                document.querySelectorAll('.split-item-checkbox:checked').forEach(checkbox => {
                    const item = items[parseInt(checkbox.dataset.index)];
                    total += item.price * item.quantity;
                });
                document.getElementById('split-bill-total').textContent = this.formatRupiah(total);
            });
        },
        
        // === 8. ANALYTICS LOGIC (NEW) ===
        
        renderAnalyticsCharts() {
            const start = document.getElementById('report-start').value;
            const end = document.getElementById('report-end').value;
            if (!start || !end) return;

            const startDate = new Date(start); startDate.setHours(0,0,0,0);
            const endDate = new Date(end); endDate.setHours(23,59,59,999);
            
            const filteredTrx = this.state.transactions.filter(t => {
                const d = new Date(t.date);
                return d >= startDate && d <= endDate;
            });
            
            this.renderAnalyticsSummary(filteredTrx);
            this.renderSalesTrendChart(filteredTrx);
            this.renderTopProductsChart(filteredTrx);
            this.renderBusyHoursChart(filteredTrx);
        },

        renderAnalyticsSummary(transactions) {
            const totalRevenue = transactions.reduce((sum, t) => sum + t.finalTotal, 0);
            const totalTransactions = transactions.length;
            const avgTransaction = totalTransactions > 0 ? totalRevenue / totalTransactions : 0;
            const summaryEl = document.getElementById('analytics-summary');
            if(summaryEl) {
                summaryEl.innerHTML = `
                    <div class="stat-card"><h4>Total Pendapatan</h4><p>${this.formatRupiah(totalRevenue)}</p></div>
                    <div class="stat-card"><h4>Total Transaksi</h4><p>${totalTransactions}</p></div>
                    <div class="stat-card"><h4>Rata-rata Transaksi</h4><p>${this.formatRupiah(avgTransaction)}</p></div>
                `;
            }
        },
        
        renderSalesTrendChart(transactions) {
            const ctx = document.getElementById('sales-trend-chart')?.getContext('2d');
            if(!ctx) return;
            
            const salesByDate = transactions.reduce((acc, trx) => {
                const date = trx.date.split('T')[0];
                acc[date] = (acc[date] || 0) + trx.finalTotal;
                return acc;
            }, {});

            const sortedDates = Object.keys(salesByDate).sort();
            const labels = sortedDates;
            const data = sortedDates.map(date => salesByDate[date]);

            if (this.charts.sales) this.charts.sales.destroy();
            this.charts.sales = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Pendapatan', data, borderColor: 'var(--primary-500)', tension: 0.1, fill: false }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        },
        
        renderTopProductsChart(transactions) {
            const ctx = document.getElementById('top-products-chart')?.getContext('2d');
            if(!ctx) return;

            const productSales = transactions.flatMap(t => t.items).reduce((acc, item) => {
                acc[item.name] = (acc[item.name] || 0) + item.quantity;
                return acc;
            }, {});

            const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const labels = sortedProducts.map(p => p[0]);
            const data = sortedProducts.map(p => p[1]);

            if (this.charts.products) this.charts.products.destroy();
            this.charts.products = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ label: 'Jumlah Terjual', data, backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#94a3b8'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        },

        renderBusyHoursChart(transactions) {
            const ctx = document.getElementById('busy-hours-chart')?.getContext('2d');
            if(!ctx) return;

            const salesByHour = transactions.reduce((acc, trx) => {
                const hour = new Date(trx.date).getHours();
                acc[hour] = (acc[hour] || 0) + 1; // Count transactions
                return acc;
            }, {});
            
            const labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const data = Array.from({length: 24}, (_, i) => salesByHour[i] || 0);

            if (this.charts.hours) this.charts.hours.destroy();
            this.charts.hours = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'Jumlah Transaksi', data, backgroundColor: 'var(--primary-500)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        },

        // === 9. SETTINGS & OTHER LOGIC (UPDATED) ===
        changePosMode(isFnb) {
            const hasActiveOrders = Object.keys(this.state.activeOrders).length > 0;
            if (isFnb === false && hasActiveOrders) {
                this.showToast('Selesaikan semua pesanan meja sebelum beralih ke Mode Retail.', 'error');
                document.getElementById('pos-mode-toggle').checked = true; // Revert toggle
                return;
            }

            this.showConfirmModal('Ganti Mode?', `Anda yakin ingin beralih ke Mode ${isFnb ? 'F&B' : 'Retail'}? Aplikasi akan dimuat ulang.`, () => {
                this.state.settings.posMode = isFnb ? 'fnb' : 'retail';
                this.saveAllData();
                window.location.reload();
            });
        },

        saveSettings() {
             this.state.settings.namaToko = document.getElementById('s-namaToko').value; 
             this.state.settings.pemilik = document.getElementById('s-pemilik').value; 
             this.state.settings.lowStockThreshold = parseInt(document.getElementById('s-lowStockThreshold').value) || 10; 
             this.saveAllData(); this.applySettings(); this.showToast('Pengaturan berhasil disimpan!'); 
        },

        // Dummy/Unchanged functions from original file to ensure no breakage
        addStockLog(productId, change, from, to, reason) { this.state.stockHistory.unshift({ id: 'STK-' + Date.now(), productId, date: new Date().toISOString(), change, from, to, reason }); },
        deleteProduct(productId) { this.showConfirmModal('Hapus Produk?', 'Anda yakin ingin menghapus produk ini?', () => { this.state.products = this.state.products.filter(p => p.id != productId); this.saveAllData(); this.showPage('produk'); this.showToast('Produk berhasil dihapus.'); }); },
        showProductModal(productId) {
            const isEdit = productId !== undefined;
            const product = isEdit ? this.state.products.find(p => p.id == productId) : {};
            const title = isEdit ? 'Edit Produk' : 'Tambah Produk';
            const content = `<div class="form-group"><input type="text" id="p-name" class="form-input" placeholder=" " value="${product.name || ''}" required><label class="form-label">Nama Produk</label></div><div class="form-group"><input type="text" id="p-category" class="form-input" placeholder=" " value="${product.category || ''}" required><label class="form-label">Kategori</label></div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><div class="form-group"><input type="number" id="p-price" class="form-input" placeholder=" " value="${product.price || ''}" required min="0"><label class="form-label">Harga Jual</label></div><div class="form-group"><input type="number" id="p-cost" class="form-input" placeholder=" " value="${product.cost || ''}" required min="0"><label class="form-label">Harga Modal</label></div></div><div class="form-group"><input type="number" id="p-stock" class="form-input" placeholder=" " value="${product.stock !== undefined ? product.stock : 0}" required min="0" ${isEdit ? 'disabled' : ''}><label class="form-label">${isEdit ? 'Stok Saat Ini' : 'Stok Awal'}</label></div>`;
            this.showModal(title, content, () => this.saveProduct(productId));
        },
        saveProduct(productId) {
            const name = document.getElementById('p-name').value.trim();
            const price = parseFloat(document.getElementById('p-price').value);
            const cost = parseFloat(document.getElementById('p-cost').value);
            const stock = parseInt(document.getElementById('p-stock').value);
            if (!name || isNaN(price) || isNaN(cost) || price < 0 || cost < 0) return false;
            const productData = { name, category: document.getElementById('p-category').value.trim(), price, cost };
            if(productId) {
                const index = this.state.products.findIndex(p => p.id == productId);
                this.state.products[index] = { ...this.state.products[index], ...productData };
            } else {
                if(isNaN(stock) || stock < 0) return false;
                productData.stock = stock;
                productData.id = Date.now();
                this.state.products.push(productData);
                this.addStockLog(productData.id, stock, 0, stock, 'Stok Awal');
            }
            this.saveAllData(); this.showPage('produk');
            this.showToast(`Produk berhasil ${productId ? 'diperbarui' : 'ditambahkan'}.`);
            return true;
        },
    };
    
    App.init();
});
</script>
</body>
</html>
