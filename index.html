<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>

    <title>tokopintar.id - Professional POS</title>

    <style>
        /* === 1. DESIGN SYSTEM & RESET === */
        :root {
            --primary-500: #3b82f6; --primary-600: #2563eb;
            --neutral-0: #ffffff; --neutral-50: #f8fafc; --neutral-100: #f1f5f9; --neutral-200: #e2e8f0; --neutral-400: #94a3b8; --neutral-600: #475569; --neutral-800: #1e293b;
            --success-500: #10b981; --success-100: #d1fae5; --success-700: #047857;
            --danger-500: #ef4444; --danger-100: #fee2e2; --danger-700: #b91c1c;
            --warning-500: #f59e0b; --warning-100: #fef3c7; --warning-700: #b45309;
            --info-500: #38bdf8; --info-100: #e0f2fe;
            --font-main: 'Inter', sans-serif;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }
        html { scroll-behavior: smooth; }
        body { background-color: var(--neutral-100); color: var(--neutral-800); -webkit-font-smoothing: antialiased; }
        ::selection { background-color: var(--primary-500); color: var(--neutral-0); }
        body.mobile-cart-open, body.forced-modal-open { overflow: hidden; }

        /* PERBAIKAN: Mencegah klik di belakang modal paksa */
        body.forced-modal-open .app-container {
            pointer-events: none;
        }

        /* === 2. LAYOUT UTAMA === */
        .app-container { display: none; flex-direction: row; } /* Initially hidden */
        .main-content { width: 100%; padding: 0; padding-bottom: 80px; transition: margin-left 0.3s ease; }
        .sidebar { display: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background-color: var(--neutral-0); border-top: 1px solid var(--neutral-200); display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .bottom-nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--neutral-400); gap: 4px; }
        .bottom-nav-link i { font-size: 20px; }
        .bottom-nav-link span { font-size: 10px; font-weight: 500; }
        .bottom-nav-link.active { color: var(--primary-500); }

        @media (min-width: 768px) {
            .main-content { margin-left: 80px; width: calc(100% - 80px); padding: 20px; padding-bottom: 20px; }
            .sidebar { display: flex; flex-direction: column; position: fixed; width: 80px; height: 100vh; background-color: var(--neutral-0); border-right: 1px solid var(--neutral-200); padding: 20px 0; transition: width 0.3s ease; z-index: 1001; }
            .sidebar:hover { width: 250px; }
            .sidebar-header { display: flex; align-items: center; justify-content: center; padding: 0 10px; min-height: 40px; }
            .sidebar-header i { color: var(--primary-500); font-size: 28px; }
            .sidebar-header h2 { font-size: 22px; opacity: 0; visibility: hidden; white-space: nowrap; margin-left:12px; }
            .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu { list-style: none; margin-top: 30px; flex-grow: 1; }
            .sidebar-footer { margin-top: auto; }
            .sidebar-menu a, .sidebar-footer a { display: flex; align-items: center; text-decoration: none; color: var(--neutral-600); padding: 15px 28px; white-space: nowrap; }
            .sidebar-menu a i, .sidebar-footer a i { font-size: 22px; min-width: 24px; }
            .sidebar-menu a span, .sidebar-footer a span { margin-left: 20px; font-weight: 500; opacity: 0; visibility: hidden; }
            .sidebar:hover .sidebar-menu a span, .sidebar:hover .sidebar-footer a span { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu a:hover, .sidebar-footer a:hover { background-color: var(--neutral-100); }
            .sidebar-menu a.active { color: var(--primary-500); font-weight: 600; position: relative; }
            .sidebar-menu a.active::before { content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background-color: var(--primary-500); border-radius: 0 4px 4px 0; }
            .bottom-nav { display: none; }
        }
        @media (min-width: 1200px) {
            .main-content { margin-left: 250px; width: calc(100% - 250px); }
            .sidebar, .sidebar:hover { width: 250px; }
            .sidebar-header { justify-content: flex-start; padding: 0 25px; }
            .sidebar-header h2, .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: none; }
            .sidebar-menu a span, .sidebar:hover .sidebar-menu a span, .sidebar-footer a span, .sidebar:hover .sidebar-footer a span { opacity: 1; visibility: visible; transition: none; }
        }

        /* === 3. KOMPONEN UI MODERN === */
        .page-container { animation: fadeIn 0.4s ease; padding: 15px; }
        @media (min-width: 768px) { .page-container { padding: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 24px; }
        @media (min-width: 768px) { .header h1 { font-size: 28px; } }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; border-radius: 8px; font-weight: 600; text-decoration: none; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .btn:disabled { background-color: var(--neutral-200); color: var(--neutral-600); cursor: not-allowed; opacity: 0.7; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-500); color: var(--neutral-0); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-600); }
        .btn-secondary { background-color: var(--neutral-0); color: var(--neutral-800); border-color: var(--neutral-200); }
        .btn-secondary:hover { background-color: var(--neutral-50); }
        .btn-danger { background-color: var(--danger-500); color: var(--neutral-0); }
        .btn-danger:hover { background-color: #d73737; }
        .btn-text { background: none; color: var(--primary-500); padding: 8px; }
        .btn-text:hover { background-color: var(--neutral-100); }
        .form-group { position: relative; margin-bottom: 25px; }
        .form-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--neutral-200); font-size: 16px; background-color: var(--neutral-0); }
        .form-input:focus { border-color: var(--primary-500); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-label { position: absolute; left: 12px; top: 12px; font-size: 16px; color: var(--neutral-400); background-color: var(--neutral-0); padding: 0 4px; transition: all 0.2s ease; pointer-events: none; }
        .form-input:not(:placeholder-shown) + .form-label, .form-input:focus + .form-label, .form-group.has-value .form-label { top: -10px; font-size: 12px; color: var(--primary-500); }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .modal { position: fixed; inset: 0; background-color: rgba(30, 41, 59, 0.5); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; padding: 15px; pointer-events: auto; }
        .modal-content { background-color: var(--neutral-0); border-radius: 12px; padding: 25px; min-width: 300px; max-width: 500px; width: 100%; box-shadow: var(--shadow-md); animation: scaleIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-400); }
        #toast-container { position: fixed; bottom: 85px; right: 20px; z-index: 3000; pointer-events: none;}
        .toast { padding: 15px 20px; border-radius: 8px; color: var(--neutral-0); margin-top: 10px; box-shadow: var(--shadow-md); animation: slideIn 0.3s ease; }
        .toast.success { background-color: var(--success-500); }
        .toast.error { background-color: var(--danger-500); }
        .toast.warning { background-color: var(--warning-500); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @media (min-width: 768px) { #toast-container { bottom: 20px; } }
        .tabs { display: flex; border-bottom: 1px solid var(--neutral-200); margin-bottom: 20px; overflow-x: auto; }
        .tab-link { padding: 10px 15px; cursor: pointer; font-weight: 500; color: var(--neutral-600); border-bottom: 2px solid transparent; white-space: nowrap; }
        .tab-link.active { color: var(--primary-500); border-bottom-color: var(--primary-500); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        
        /* PENAMBAHAN: Gaya untuk Loader */
        .loader-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .loader-spinner { border: 5px solid var(--neutral-200); border-top: 5px solid var(--primary-500); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PENAMBAHAN: Gaya untuk Paginasi */
        .pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 10px 0; }
        .pagination-info { font-size: 14px; color: var(--neutral-600); }
        .pagination-buttons { display: flex; gap: 10px; }

        /* PENAMBAHAN: Gaya untuk notifikasi harga di keranjang */
        @keyframes flash-bg { 0%, 100% { background-color: transparent; } 50% { background-color: var(--warning-100); } }
        .price-updated-flash { animation: flash-bg 1.5s ease-out; }

        /* === 4. TAMPILAN SPESIFIK HALAMAN & FITUR BARU === */
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--neutral-50); }
        .login-box { background: var(--neutral-0); padding: 40px; border-radius: 16px; box-shadow: var(--shadow-md); text-align: center; width: 100%; max-width: 380px; margin: 20px; }
        .login-box h1 { font-size: 28px; margin-bottom: 10px; }
        .login-box p { color: var(--neutral-600); margin-bottom: 30px; }
        .kasir-container { display: grid; grid-template-columns: 1fr; gap: 20px; height: calc(100vh - 110px); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 5px; }
        .product-card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; overflow: hidden; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-card.out-of-stock { opacity: 0.5; cursor: not-allowed; }
        .product-card.out-of-stock::after { content: 'Stok Habis'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .product-card-stock { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.5); color: white; padding: 2px 6px; font-size: 10px; font-weight: 600; border-radius: 4px; }
        .product-card img { width: 100%; height: 100px; object-fit: cover; background-color: var(--neutral-200); }
        .product-card-placeholder { width:100%; height:100px; background-color: var(--neutral-200); color:var(--neutral-600); display:flex; align-items:center; justify-content:center; font-size: 3rem; font-weight: bold; }
        .product-card-info { padding: 10px; }
        .product-card-info h4 { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .product-card-info p { font-size: 12px; color: var(--primary-500); font-weight: 500; }
        #cart-summary-bar { position: fixed; bottom: 65px; left: 0; right: 0; background-color: var(--primary-500); color: var(--neutral-0); padding: 15px; display: none; justify-content: space-between; align-items: center; cursor: pointer; animation: slideUp 0.3s ease-out; z-index: 999; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cart-item-controls { display: flex; align-items: center; gap: 8px; }
        .cart-item-controls button { background: var(--neutral-200); border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-container .mobile-cart-close-btn { display: none; }
        @media (max-width: 1199.98px) {
            #cart-container {
                display: none;
                position: fixed;
                bottom: 0; left: 0; right: 0;
                height: 75vh;
                margin-bottom: 0;
                z-index: 1500;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
                flex-direction: column;
                transform: translateY(100%);
                transition: transform 0.3s ease-out;
            }
            #cart-container.is-visible { display: flex; transform: translateY(0); }
            .cart-container .mobile-cart-close-btn { display: block; position: absolute; top: 15px; right: 15px; background: var(--neutral-100); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer; }
        }
        @media (min-width: 1200px) {
            .kasir-container { grid-template-columns: 2fr 1.2fr; height: calc(100vh - 40px); }
            .cart-container { display: flex !important; }
            #cart-summary-bar { display: none !important; }
        }
        .table-wrapper { overflow-x: auto; }
        .responsive-table { width: 100%; border-collapse: collapse; }
        .responsive-table th, .responsive-table td { padding: 12px 15px; text-align: left; }
        .responsive-table thead { background-color: var(--neutral-50); }
        .responsive-table tbody tr { border-bottom: 1px solid var(--neutral-200); }
        .responsive-table .actions { display: flex; gap: 5px; }
        .stock-badge { padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .stock-badge.low { background-color: var(--warning-100); color: var(--warning-700); }
        .stock-badge.out { background-color: var(--danger-100); color: var(--danger-700); }
        .stock-badge.ok { background-color: var(--success-100); color: var(--success-700); }
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; background: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid var(--neutral-100); padding: 10px 0; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 15px; }
        }
        .lainnya-menu { list-style: none; }
        .lainnya-menu-item a { display: flex; align-items: center; padding: 20px 15px; background-color: var(--neutral-0); border-bottom: 1px solid var(--neutral-200); text-decoration: none; color: var(--neutral-800); font-weight: 500; }
        .lainnya-menu-item a:hover { background-color: var(--neutral-50); }
        .lainnya-menu-item:first-child a { border-radius: 16px 16px 0 0; }
        .lainnya-menu-item:last-child a { border-bottom: none; border-radius: 0 0 16px 16px; }
        .lainnya-menu-item i { margin-right: 15px; color: var(--neutral-400); width: 24px; text-align: center; }
        .carousel-container { position: relative; overflow: hidden; border-radius: 16px; margin-bottom: 20px; background-color: var(--primary-500); }
        .carousel-track { display: flex; transition: transform 0.5s ease-in-out; }
        .carousel-slide { min-width: 100%; position: relative; }
        .carousel-slide img { width: 100%; display: block; height: 250px; object-fit: cover; }
        .carousel-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .carousel-dot { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background-color 0.3s; }
        .carousel-dot.active { background-color: white; }
        .banner-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .banner-preview-item { position: relative; }
        .banner-preview-item img { width: 100%; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid var(--neutral-200); }
        .banner-remove-btn { position: absolute; top: -8px; right: -8px; width: 22px; height: 22px; background-color: var(--danger-500); color: white; border: 2px solid var(--neutral-0); border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); }
        .banner-remove-btn:hover { background-color: var(--danger-700); }
        .custom-file-upload { border: 1px solid var(--neutral-200); display: inline-block; padding: 10px 18px; cursor: pointer; border-radius: 8px; font-weight: 600; background-color: var(--neutral-0); color: var(--neutral-800); }
        .custom-file-upload:hover { background-color: var(--neutral-50); }
        input[type="file"] { display: none; }
        
        @media print {
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 58mm;
                font-size: 8pt;
                color: #000;
                padding: 0;
            }
            .modal-content { box-shadow: none; border: none; padding: 0; }
            .btn, .modal-header .close-modal, #receipt-actions { display: none; }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader-overlay" style="display: none;">
        <div class="loader-spinner"></div>
    </div>

    <div id="login-screen"></div>

    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header"><i class="fa-solid fa-bolt"></i><h2 id="store-name-sidebar"></h2></div>
            <ul class="sidebar-menu"></ul>
            <div class="sidebar-footer"><a href="#" data-action="logout"><i class="fa-solid fa-right-from-bracket"></i><span>Keluar</span></a></div>
        </nav>
        
        <main class="main-content">
            <div id="page-content"></div>
        </main>
        
        <nav class="bottom-nav"></nav>
    </div>
    
    <div id="modal-container" class="modal"></div>
    
    <div id="toast-container"></div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        // === 1. STATE & INISIALISASI ===
        state: { 
            currentPage: 'beranda', 
            currentUser: null, 
            staff: [], 
            cart: [], 
            products: [], 
            customers: [], 
            transactions: [], 
            expenses: [], 
            stockHistory: [], 
            promotions: [],
            settings: {}, 
            shifts: [], 
            activeShift: null,
            pagination: {
                products: { currentPage: 1, filter: '' },
                transactions: { currentPage: 1, filter: '' },
                customers: { currentPage: 1, filter: '' },
                expenses: { currentPage: 1 },
                users: { currentPage: 1, filter: '' }
            },
            itemsPerPage: 15,
            activeTransaction: { 
                customerId: null, 
                customerName: 'Pelanggan Umum' 
            }
        },
        elements: {}, 
        charts: {}, 
        carouselInterval: null,
        
        isRenderScheduled: false,
        pendingRender: new Set(),

        init() {
            this.initData();
            this.cacheDOMElements(); 
            this.attachEventListeners();
            const loggedInUser = this.getFromLocalStorage('currentUser', null);
            if (loggedInUser) {
                this.state.currentUser = loggedInUser;
                this.startApp();
            } else { 
                this.renderLoginScreen(); 
            }
        },
        
        startApp() {
            this.elements.loginScreen.style.display = 'none';
            this.elements.appContainer.style.display = 'flex';
            this.injectBaseHTML();
            this.applySettings();
            if (!this.state.activeShift && this.state.currentUser.role === 'kasir') { 
                this.showStartShiftModal(); 
            }
            this.showPage(this.state.currentPage || 'beranda');
        },

        initData() {
            const defaultSettings = { 
                namaToko: 'Kopi Pagi Ceria', 
                alamatToko: 'Jl. Merdeka No. 45, Semarang', 
                pesanDiStruk: 'Terima kasih telah berkunjung!', 
                teleponToko: '081234567890', 
                lowStockThreshold: 10,
                dashboardBanners: []
            };
            try {
                this.state.products = this.getFromLocalStorage('products', [ 
                    { id: 1, name: 'Kopi Susu Gula Aren', category: 'Kopi', price: 18000, cost: 10000, stock: 50, imageUrl: null }, 
                    { id: 2, name: 'Croissant Coklat', category: 'Roti', price: 22000, cost: 12000, stock: 8, imageUrl: null },
                    { id: 3, name: 'Americano', category: 'Kopi', price: 15000, cost: 7000, stock: 0, imageUrl: null }, 
                ]);
                
                if (this.state.products.length > 0 && !Number.isInteger(this.state.products[0].price)) {
                    this.state.products.forEach(p => {
                        p.price = Math.round(p.price);
                        p.cost = Math.round(p.cost);
                    });
                    this.saveToLocalStorage('products', this.state.products);
                }

                const existingStaff = this.getFromLocalStorage('staff', []);
                if (existingStaff.length === 0) { 
                    this.state.staff = [
                        { id: 1, name: 'Admin Utama', username: 'admin', pin: '1234', role: 'admin' },
                        { id: 2, name: 'Kasir Satu', username: 'kasir1', pin: '0000', role: 'kasir' }
                    ]; 
                    this.saveToLocalStorage('staff', this.state.staff); 
                } else { this.state.staff = existingStaff; }

                this.state.settings = this.getFromLocalStorage('settings', defaultSettings);
                this.state.customers = this.getFromLocalStorage('customers', []);
                this.state.transactions = this.getFromLocalStorage('transactions', []);
                this.state.expenses = this.getFromLocalStorage('expenses', []);
                this.state.stockHistory = this.getFromLocalStorage('stockHistory', []);
                this.state.cart = this.getFromLocalStorage('cart', []);
                this.state.promotions = this.getFromLocalStorage('promotions', []);
                this.state.shifts = this.getFromLocalStorage('shifts', []);
                this.state.activeShift = this.getFromLocalStorage('activeShift', null);
                this.state.currentPage = this.getFromLocalStorage('currentPage', 'beranda');
            } catch (e) { 
                console.error("Gagal memuat data:", e); 
                if (confirm("Data aplikasi rusak atau korup. Apakah Anda ingin mereset semua data ke pengaturan awal?")) { 
                    localStorage.clear(); 
                    window.location.reload(); 
                } 
            }
        },

        // ++++++++++++++++++++ MULAI KODE PENGGANTI ++++++++++++++++++++

        injectBaseHTML() {
            // Log untuk memulai proses debug
            console.log('Memulai proses injectBaseHTML...');

            // PENGECEKAN PENTING: Validasi bahwa currentUser ada.
            // Jika tidak ada, hentikan fungsi untuk mencegah error.
            if (!this.state.currentUser) {
                console.error('KESALAHAN: injectBaseHTML dipanggil tetapi this.state.currentUser tidak ada. Proses login mungkin gagal.');
                // Kosongkan menu sebagai tindakan pengamanan
                const sidebarMenuEl = document.querySelector('.sidebar-menu');
                const bottomNavEl = document.querySelector('.bottom-nav');
                if (sidebarMenuEl) sidebarMenuEl.innerHTML = '';
                if (bottomNavEl) bottomNavEl.innerHTML = '';
                return; // Hentikan eksekusi fungsi
            }

            const menuItems = [
                { id: 'beranda', icon: 'fa-solid fa-store', label: 'Beranda', role: 'all' },
                { id: 'kasir', icon: 'fa-solid fa-cash-register', label: 'Kasir', role: 'all' },
                { id: 'riwayat', icon: 'fa-solid fa-receipt', label: 'Riwayat', role: 'all' },
                { id: 'produk', icon: 'fa-solid fa-box-open', label: 'Produk', role: 'admin' },
                { id: 'analitik', icon: 'fa-solid fa-chart-line', label: 'Analitik', role: 'admin' },
                { id: 'pelanggan', icon: 'fa-solid fa-users', label: 'Pelanggan', role: 'admin' },
                { id: 'biaya', icon: 'fa-solid fa-wallet', label: 'Biaya', role: 'admin' },
                { id: 'pengguna', icon: 'fa-solid fa-user-shield', label: 'Pengguna', role: 'admin' },
                { id: 'pengaturan', icon: 'fa-solid fa-gear', label: 'Pengaturan', role: 'admin' },
                { id: 'lainnya', icon: 'fa-solid fa-ellipsis', label: 'Lainnya', role: 'all', mobileOnly: true },
            ];

            // SOLUSI: Berikan peran default 'kasir' jika properti 'role' tidak ditemukan.
            // Ini membuat validasi lebih toleran dan mencegah menu kosong.
            const userRole = this.state.currentUser.role || 'kasir'; 
            console.log(`Peran pengguna yang terdeteksi: "${userRole}"`);

            // Filter menu berdasarkan peran yang sudah valid
            const visibleMenuItems = menuItems.filter(item => item.role === 'all' || item.role === userRole);

            console.log('Jumlah menu yang akan ditampilkan:', visibleMenuItems.length);

            // Ambil elemen DOM
            const sidebarMenuEl = document.querySelector('.sidebar-menu');
            const bottomNavEl = document.querySelector('.bottom-nav');

            // Pastikan elemen target ada di HTML
            if (!sidebarMenuEl || !bottomNavEl) {
                console.error('KESALAHAN: Elemen .sidebar-menu atau .bottom-nav tidak ditemukan di HTML.');
                return;
            }

            // Buat HTML untuk sidebar (desktop)
            // Filter tambahan untuk item yang bukan 'mobileOnly'
            const sidebarHTML = visibleMenuItems
                .filter(item => !item.mobileOnly)
                .map(item => `<li><a href="#" class="nav-link" data-page="${item.id}"><i class="${item.icon}"></i><span>${item.label}</span></a></li>`)
                .join('');

            // Buat HTML untuk navigasi bawah (mobile)
            // Tampilkan hanya menu utama di mobile
            const mobileMenuIds = ['beranda', 'kasir', 'riwayat', 'lainnya'];
            const bottomNavHTML = visibleMenuItems
                .filter(item => mobileMenuIds.includes(item.id))
                .map(item => `<a href="#" class="bottom-nav-link nav-link" data-page="${item.id}"><i class="${item.icon}"></i><span>${item.label}</span></a>`)
                .join('');

            // Terapkan HTML ke elemen DOM
            sidebarMenuEl.innerHTML = sidebarHTML;
            bottomNavEl.innerHTML = bottomNavHTML;
            
            // Panggil kembali fungsi untuk mengaktifkan link halaman saat ini setelah menu dirender
            this.showPage(this.state.currentPage, false);

            console.log('Proses injectBaseHTML selesai. Menu seharusnya sudah tampil.');
        },

// ++++++++++++++++++++ AKHIR KODE PENGGANTI ++++++++++++++++++++



        cacheDOMElements() {
            this.elements = {
                appContainer: document.querySelector('.app-container'),
                loginScreen: document.getElementById('login-screen'),
                pageContent: document.getElementById('page-content'),
                modalContainer: document.getElementById('modal-container'),
                toastContainer: document.getElementById('toast-container'),
                sidebarStoreName: document.getElementById('store-name-sidebar'),
                loader: document.getElementById('loader'),
            };
        },
        
        attachEventListeners() {
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.nav-link, .nav-link-dynamic');
                if (navLink) { e.preventDefault(); this.showPage(navLink.dataset.page); return; }
                
                const actionEl = e.target.closest('[data-action]');
                if (actionEl) { e.preventDefault(); this.handleAction(actionEl.dataset.action, actionEl.dataset.id || actionEl.dataset.value, actionEl); return; }
                
                const pageBtn = e.target.closest('.page-btn');
                if (pageBtn && !pageBtn.disabled) { this.handlePageChange(pageBtn); return; }

                const tabLink = e.target.closest('.tab-link');
                if (tabLink) {
                    const target = tabLink.dataset.target;
                    tabLink.parentElement.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
                    tabLink.closest('.page-container, .modal-content').querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tabLink.classList.add('active');
                    document.getElementById(target).classList.add('active');
                    return;
                }
            });
            
            document.body.addEventListener('submit', e => {
                if (e.target.id === 'login-form') { e.preventDefault(); this.handleLogin(); }
            });
            
            document.body.addEventListener('change', e => {
                const uploader = e.target.closest('[data-uploader]');
                if (uploader) this.handleUploader(uploader.dataset.uploader, uploader.files);
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') this.closeModal();
                if (this.state.currentPage === 'kasir') {
                    if (e.key === 'F1') { e.preventDefault(); document.getElementById('kasir-search-input')?.focus(); }
                    if (e.key === 'F9' && this.getCurrentCartItems().length > 0) { e.preventDefault(); this.openPaymentModal(); }
                }
            });
        },
        
        // === 2. AUTHENTICATION & SHIFT MANAGEMENT ===
        renderLoginScreen() { this.elements.appContainer.style.display = 'none'; const loginScreen = this.elements.loginScreen; loginScreen.style.display = 'flex'; loginScreen.innerHTML = `<div class="login-box"><i class="fa-solid fa-bolt" style="font-size: 40px; color: var(--primary-500); margin-bottom: 20px;"></i><h1>Selamat Datang</h1><p>Masukkan username dan PIN Anda untuk masuk.</p><form id="login-form"><div class="form-group"><input type="text" id="username" class="form-input" placeholder=" " required><label for="username" class="form-label">Username</label></div><div class="form-group"><input type="password" id="pin" class="form-input" placeholder=" " required inputmode="numeric" pattern="\\d*"><label for="pin" class="form-label">PIN</label></div><button type="submit" class="btn btn-primary" style="width: 100%;">Masuk</button></form></div>`; },
        handleLogin() { const username = document.getElementById('username').value; const pin = document.getElementById('pin').value; const user = this.state.staff.find(u => u.username === username && u.pin === pin); if (user) { this.state.currentUser = user; this.saveToLocalStorage('currentUser', user); this.showToast(`Selamat datang, ${user.name}!`, 'success'); this.startApp(); } else { this.showToast('Username atau PIN salah.', 'error'); } },
        logout() { if (this.state.activeShift) { this.showToast('Anda harus menutup shift terlebih dahulu.', 'error'); this.showEndShiftModal(); return; } this.state.currentUser = null; localStorage.removeItem('currentUser'); this.state.currentPage = 'beranda'; this.saveToLocalStorage('currentPage', 'beranda'); window.location.reload(); },
        showStartShiftModal() { const content = `<p>Masukkan modal awal Anda.</p><div class="form-group" style="margin-top: 20px;"><input type="number" id="opening-cash" class="form-input" placeholder=" " required min="0" inputmode="numeric"><label class="form-label">Modal Awal</label></div>`; this.showModal('Buka Kasir', content, () => { const openingCash = this.parseRupiahToInt(document.getElementById('opening-cash').value); if (isNaN(openingCash) || openingCash < 0) { this.showToast('Masukkan jumlah modal yang valid.', 'error'); return false; } this.startShift(openingCash); }, 'Mulai Shift', true, true); },
        startShift(openingCash) { const newShift = { id: 'SHIFT-' + Date.now(), userId: this.state.currentUser.id, userName: this.state.currentUser.name, startTime: new Date().toISOString(), endTime: null, openingCash: openingCash, closingCash: null, cashSales: 0, calculatedCash: 0, difference: 0 }; this.state.activeShift = newShift; this.saveToLocalStorage('activeShift', this.state.activeShift); this.showToast('Shift berhasil dimulai!', 'success'); this.showPage(this.state.currentPage); },
        showEndShiftModal() { const shiftTransactions = this.state.transactions.filter(t => this.state.activeShift && t.shiftId === this.state.activeShift.id); const cashSales = shiftTransactions.filter(t => t.paymentMethod === 'Tunai').reduce((sum, t) => sum + t.finalTotal, 0); const expectedCash = this.state.activeShift.openingCash + cashSales; const content = `<div style="font-size: 14px; color: var(--neutral-600);"><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Modal Awal:</span> <strong>${this.formatIntToRupiah(this.state.activeShift.openingCash)}</strong></div><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><span>Total Penjualan Tunai:</span> <strong>${this.formatIntToRupiah(cashSales)}</strong></div><hr style="margin: 10px 0;"><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span>Uang di Laci Seharusnya:</span> <strong style="color:var(--primary-500);">${this.formatIntToRupiah(expectedCash)}</strong></div></div><p>Masukkan jumlah uang tunai aktual di laci.</p><div class="form-group" style="margin-top:20px;"><input type="number" id="closing-cash" class="form-input" placeholder=" " required min="0" inputmode="numeric"><label class="form-label">Uang Tunai Aktual</label></div>`; this.showModal('Tutup Kasir', content, () => { const closingCash = this.parseRupiahToInt(document.getElementById('closing-cash').value); if (isNaN(closingCash) || closingCash < 0) { this.showToast('Masukkan jumlah yang valid.', 'error'); return false; } this.endShift(closingCash, cashSales, expectedCash); }, 'Selesaikan Shift', true, true); },
        endShift(closingCash, cashSales, expectedCash) { let shift = { ...this.state.activeShift }; shift.endTime = new Date().toISOString(); shift.closingCash = closingCash; shift.cashSales = cashSales; shift.calculatedCash = expectedCash; shift.difference = closingCash - expectedCash; this.state.shifts.unshift(shift); this.state.activeShift = null; this.saveToLocalStorage('shifts', this.state.shifts); this.saveToLocalStorage('activeShift', null); let message = 'Shift berhasil ditutup.'; if (shift.difference !== 0) { message += ` Ada selisih ${this.formatIntToRupiah(shift.difference)}.`; } this.showToast(message, shift.difference === 0 ? 'success' : 'warning'); this.showPage('beranda'); },

        // === 3. UTILITIES & MODALS ===
        getFromLocalStorage(key, defaultValue) { const data = localStorage.getItem(key); if (!data) return defaultValue; try { return JSON.parse(data); } catch { return defaultValue; } },
        saveToLocalStorage: (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error("Gagal menyimpan ke LocalStorage:", e); App.showToast('Error: Penyimpanan lokal penuh atau rusak.', 'error'); } },
        formatIntToRupiah: (number) => { const num = number || 0; return `Rp ${new Intl.NumberFormat('id-ID').format(num)}`; },
        parseRupiahToInt: (stringValue) => { if (typeof stringValue !== 'string' && typeof stringValue !== 'number') return NaN; const cleanString = String(stringValue).replace(/[Rp.\s]/g, ''); return parseInt(cleanString, 10); },
        showLoader() { if (this.elements.loader) this.elements.loader.style.display = 'flex'; },
        hideLoader() { if (this.elements.loader) this.elements.loader.style.display = 'none'; },
        fuzzySearch(haystack, needles) {
            const hs = haystack.toLowerCase();
            const ndls = needles.toLowerCase().split(' ').filter(n => n);
            return ndls.every(needle => hs.includes(needle));
        },
        formatDate: (isoString, withTime = false) => { const options = { day: '2-digit', month: 'short', year: 'numeric' }; if (withTime) { options.hour = '2-digit'; options.minute = '2-digit'; } return new Date(isoString).toLocaleDateString('id-ID', options); },
        applySettings() { document.title = `${this.state.settings.namaToko} - POS`; if(this.elements.sidebarStoreName) this.elements.sidebarStoreName.textContent = this.state.settings.namaToko; },
        showToast(message, type = 'success') { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; this.elements.toastContainer.appendChild(toast); setTimeout(() => { toast.remove(); }, 3000); },
        showModal(title, contentHTML, onConfirm, confirmText = 'Simpan', onConfirmShouldClose = true, isForced = false) {
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `<div class="modal-header"><h2>${title}</h2><button class="close-modal">&times;</button></div><form id="modal-form" novalidate>${contentHTML}</form><div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:10px;"><button type="button" class="btn btn-secondary close-modal">Batal</button>${onConfirm ? `<button type="button" class="btn btn-primary" id="modal-confirm">${confirmText}</button>` : ''}</div>`;
            this.elements.modalContainer.innerHTML = '';
            this.elements.modalContainer.appendChild(modalContent);
            this.elements.modalContainer.style.display = 'flex';
            
            if (isForced) {
                document.body.classList.add('forced-modal-open');
                modalContent.querySelector('.modal-header .close-modal')?.remove();
                modalContent.querySelector('.btn-secondary.close-modal')?.remove();
                modalContent.querySelector('form').dataset.modalType = 'shift-modal';
            }

            modalContent.querySelectorAll('.form-group').forEach(group => { const input = group.querySelector('.form-input'); if (input && input.value.trim() !== '') { group.classList.add('has-value'); } });
            
            const modalForm = document.getElementById('modal-form');
            if (onConfirm) {
                const confirmBtn = document.getElementById('modal-confirm');
                confirmBtn.addEventListener('click', () => { if (modalForm && !modalForm.checkValidity()) { modalForm.reportValidity(); this.showToast('Mohon isi semua kolom yang wajib diisi.', 'error'); return; } const result = onConfirm(); if(onConfirmShouldClose && result !== false) this.closeModal(); });
                if(modalForm) modalForm.addEventListener('submit', (e) => { e.preventDefault(); confirmBtn.click(); });
            }
            this.elements.modalContainer.querySelectorAll('.close-modal').forEach(el => el.addEventListener('click', () => this.closeModal()));
        },
        showConfirmModal(title, message, onConfirm) { this.showModal(title, `<p>${message}</p>`, () => { onConfirm(); return true; }, "Ya, Lanjutkan", true); },
        closeModal() {
            if (document.querySelector('#modal-form[data-modal-type="shift-modal"]')) {
                this.showToast('Harap selesaikan aksi shift untuk melanjutkan.', 'warning');
                return;
            }
            this.elements.modalContainer.style.display = 'none';
            this.elements.modalContainer.innerHTML = '';
            document.body.classList.remove('forced-modal-open');
        },

        // === 4. NAVIGASI, AKSI & RENDER HALAMAN ===
        handleAction(action, id, element) {
            const value = id; 
            switch(action) {
                case 'logout': this.logout(); break;
                case 'startShift': this.startShift(); break;
                case 'showEndShiftModal': this.showEndShiftModal(); break;
                case 'showPage': this.showPage(value); break;
                case 'finishTransaction': this.closeModal(); this.showPage('kasir'); break;
                case 'addProduct': this.showProductModal(); break;
                case 'editProduct': this.showProductModal(value); break;
                case 'deleteProduct': this.deleteProduct(value); break;
                case 'addCustomer': this.showCustomerModal(); break;
                case 'editCustomer': this.showCustomerModal(value); break;
                case 'deleteCustomer': this.deleteCustomer(value); break;
                case 'addUser': this.showUserModal(); break;
                case 'editUser': this.showUserModal(value); break;
                case 'deleteUser': this.deleteUser(value); break;
                case 'addExpense': this.showExpenseModal(); break;
                case 'editExpense': this.showExpenseModal(value); break;
                case 'deleteExpense': this.deleteExpense(value); break;
                case 'updateCartQty': this.updateCartQuantity(value, parseInt(element.dataset.change)); break;
                case 'removeFromCart': this.showConfirmModal('Hapus Item?', `Anda yakin ingin menghapus item ini dari keranjang?`, () => this.updateCartQuantity(value, -Infinity)); break;
                case 'showCustomerSelection': this.showCustomerSelectionModal(); break;
                case 'openPaymentModal': this.openPaymentModal(); break;
                case 'showMobileCart': this.toggleMobileCart(true); break;
                case 'hideMobileCart': this.toggleMobileCart(false); break;
                case 'viewTransaction': this.showTransactionDetailModal(value); break;
                case 'saveReceipt':
                    this.showLoader();
                    element.disabled = true;
                    element.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';
                    this.showToast('Menyiapkan nota...', 'warning');
                    setTimeout(() => {
                        const receiptEl = document.getElementById('receipt-print-area');
                        const filename = document.getElementById('receipt-filename').value || 'struk.png';
                        html2canvas(receiptEl, { scale: 3 }).then(canvas => {
                            const link = document.createElement('a');
                            link.href = canvas.toDataURL('image/png');
                            link.download = filename;
                            link.click();
                            this.showToast('Nota berhasil diunduh.', 'success');
                        }).catch(err => {
                            console.error('Gagal menyimpan nota:', err);
                            this.showToast('Gagal menyimpan nota.', 'error');
                        }).finally(() => {
                            element.disabled = false;
                            element.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Simpan Nota';
                            this.hideLoader();
                        });
                    }, 100);
                    break;
                case 'printThermalReceipt': window.print(); break;
                case 'printReceipt': window.print(); break;
                case 'saveSettings': this.saveSettings(); break;
                case 'removeBanner':
                    const index = parseInt(id);
                    if (!isNaN(index)) {
                        this.state.settings.dashboardBanners.splice(index, 1);
                        this.saveToLocalStorage('settings', this.state.settings);
                        this.showPage('pengaturan');
                        this.showToast('Banner berhasil dihapus.', 'success');
                    }
                    break;
                default: console.warn('Unhandled action:', action);
            }
        },

        handlePageChange(button) {
            const pageName = button.dataset.pageName;
            const change = parseInt(button.dataset.change, 10);
            if (this.state.pagination[pageName]) {
                this.state.pagination[pageName].currentPage += change;
                this.showPage(pageName, false);
            }
        },
        
        showPage(pageId, resetFilter = true) { 
            if (!pageId) return;
            
            const adminPages = ['analitik', 'pelanggan', 'biaya', 'pengguna', 'pengaturan', 'produk']; 
            if (this.state.currentUser.role !== 'admin' && adminPages.includes(pageId)) { 
                this.showToast('Anda tidak memiliki akses ke halaman ini.', 'error'); 
                return; 
            } 
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); 
            document.querySelectorAll(`.nav-link[data-page="${pageId}"]`).forEach(l => l.classList.add('active')); 
            this.state.currentPage = pageId; 
            this.saveToLocalStorage('currentPage', pageId); 
            
            if (resetFilter && this.state.pagination[pageId]) {
                this.state.pagination[pageId].currentPage = 1;
                this.state.pagination[pageId].filter = '';
            }

            const pageRenderers = { 
                beranda: this.renderBeranda.bind(this), 
                kasir: this.renderKasir.bind(this), 
                produk: this.renderProduk.bind(this), 
                riwayat: this.renderRiwayat.bind(this),
                analitik: this.renderAnalitik.bind(this), 
                lainnya: this.renderLainnya.bind(this), 
                pelanggan: this.renderPelanggan.bind(this), 
                biaya: this.renderBiaya.bind(this), 
                pengaturan: this.renderPengaturan.bind(this), 
                pengguna: this.renderPengguna.bind(this), 
            }; 
            const renderer = pageRenderers[pageId]; 
            
            if (renderer) { 
                this.elements.pageContent.innerHTML = renderer(); 
            } else { 
                this.elements.pageContent.innerHTML = `<div class="page-container"><div class="card">Halaman "${pageId}" tidak ditemukan.</div></div>`; 
            } 
        },

        renderPaginator(pageName, totalItems) {
            const { currentPage } = this.state.pagination[pageName];
            const totalPages = Math.ceil(totalItems / this.state.itemsPerPage);
            if (totalPages <= 1) return '';

            const startItem = (currentPage - 1) * this.state.itemsPerPage + 1;
            const endItem = Math.min(currentPage * this.state.itemsPerPage, totalItems);

            return `
                <div class="pagination-controls">
                    <span class="pagination-info">Menampilkan ${startItem}-${endItem} dari ${totalItems}</span>
                    <div class="pagination-buttons">
                        <button class="btn btn-secondary page-btn" data-page-name="${pageName}" data-change="-1" ${currentPage === 1 ? 'disabled' : ''}>
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-secondary page-btn" data-page-name="${pageName}" data-change="1" ${currentPage === totalPages ? 'disabled' : ''}>
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>
                </div>`;
        },

        // === 5. FUNGSI RENDER HALAMAN UTAMA ===
        renderBeranda() {
            const today = new Date().toISOString().slice(0, 10);
            const todayTrx = this.state.transactions.filter(t => t.date.startsWith(today));
            const revenueToday = todayTrx.reduce((sum, t) => sum + t.finalTotal, 0);
            let cogsToday = 0;
            todayTrx.forEach(t => { t.items.forEach(item => { cogsToday += (item.cost || 0) * item.quantity; }); });
            const expensesToday = this.state.expenses.filter(e => e.date === today).reduce((sum, e) => sum + e.amount, 0);
            const netProfitToday = revenueToday - cogsToday - expensesToday;
            const lowStockProducts = this.state.products.filter(p => p.stock > 0 && p.stock <= this.state.settings.lowStockThreshold);
            
            const userName = this.state.currentUser?.name?.split(' ')[0] || 'Pengguna';

            const banners = this.state.settings.dashboardBanners || [];
            let heroHTML = banners.length > 0 
                ? `<div id="dashboard-carousel" class="carousel-container">
                       <div class="carousel-track">${banners.map(src => `<div class="carousel-slide"><img src="${src}" alt="Banner Promosi"></div>`).join('')}</div>
                       <div class="carousel-dots">${banners.map((_, i) => `<div class="carousel-dot ${i === 0 ? 'active' : ''}" data-slide-to="${i}"></div>`).join('')}</div>
                   </div>` 
                : `<div class="card" style="background-color: var(--primary-500); color: white;">
                       <h2>Selamat Datang, ${userName}!</h2>
                       <p>Siap memulai hari yang produktif.</p>
                   </div>`;

            let shiftInfoHTML = '';
            if (this.state.currentUser?.role === 'kasir') {
                if (this.state.activeShift) {
                    const shiftDuration = Math.floor((new Date() - new Date(this.state.activeShift.startTime)) / 60000);
                    shiftInfoHTML = `<div class="card" style="background-color: var(--success-100);"><div style="display:flex; justify-content:space-between; align-items:center;"><div><h4 style="color: var(--success-700);">Shift Berjalan</h4><p style="font-size:14px; color: var(--success-700);">Dimulai ${shiftDuration} menit lalu.</p></div><button class="btn btn-danger" data-action="showEndShiftModal">Tutup Kasir</button></div></div>`;
                } else {
                     shiftInfoHTML = `<div class="card" style="background-color: var(--warning-100);"><div style="display:flex; justify-content:space-between; align-items:center;"><div><h4 style="color: var(--warning-700);">Shift Belum Dimulai</h4><p style="font-size:14px; color: var(--warning-700);">Buka kasir untuk mulai transaksi.</p></div><button class="btn btn-primary" data-action="showStartShiftModal">Buka Kasir</button></div></div>`;
                }
            }
            
            const berandaHTML = `<div class="page-container"><header class="header"><h1>Beranda</h1></header>${heroHTML}${shiftInfoHTML}<div class="dashboard-section-title">Ringkasan Hari Ini</div><div class="stats-grid"><div class="stat-card"><h4>Pendapatan</h4><p class="stat-card-value">${this.formatIntToRupiah(revenueToday)}</p></div><div class="stat-card"><h4>Laba Bersih</h4><p class="stat-card-value">${this.formatIntToRupiah(netProfitToday)}</p></div><div class="stat-card"><h4>Transaksi</h4><p class="stat-card-value">${todayTrx.length}</p></div></div><div class="dashboard-section-title">Aksi Cepat</div><div class="card"><div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; text-align: center;"><a href="#" class="nav-link-dynamic" data-page="kasir" style="color: var(--neutral-800); text-decoration:none;"><span style="width:60px; height:60px; background-color: var(--neutral-100); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid fa-cash-register"></i></span><span style="display:block; margin-top:8px; font-weight:500;">Mulai Transaksi</span></a><a href="#" data-action="addProduct" style="color: var(--neutral-800); text-decoration:none; ${this.state.currentUser?.role !== 'admin' ? 'display:none;' : ''}"><span style="width:60px; height:60px; background-color: var(--neutral-100); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid fa-plus"></i></span><span style="display:block; margin-top:8px; font-weight:500;">Tambah Produk</span></a><a href="#" class="nav-link-dynamic" data-page="analitik" style="color: var(--neutral-800); text-decoration:none; ${this.state.currentUser?.role !== 'admin' ? 'display:none;' : ''}"><span style="width:60px; height:60px; background-color: var(--neutral-100); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid fa-chart-line"></i></span><span style="display:block; margin-top:8px; font-weight:500;">Lihat Analitik</span></a><a href="#" class="nav-link-dynamic" data-page="riwayat" style="color: var(--neutral-800); text-decoration:none;"><span style="width:60px; height:60px; background-color: var(--neutral-100); border-radius: 12px; display: inline-flex; justify-content: center; align-items: center; font-size: 24px;"><i class="fa-solid fa-receipt"></i></span><span style="display:block; margin-top:8px; font-weight:500;">Riwayat</span></a></div></div><div class="dashboard-section-title">Stok Menipis</div><div class="card" style="padding: 15px;">${lowStockProducts.length > 0 ? lowStockProducts.map(p => `<div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--neutral-100);"><span>${p.name}</span><span class="stock-badge low">Sisa ${p.stock}</span></div>`).join('') : '<p style="color:var(--neutral-400); text-align:center; padding: 10px;">Semua stok aman.</p>'}</div></div>`;

            setTimeout(() => this.initCarousel(), 0);
            return berandaHTML;
        },


        renderKasir() {
            const kasirHTML = `<div class="kasir-container page-container"><div class="card product-section" style="padding: 15px; display:flex; flex-direction:column; margin-bottom:0;"><div style="margin-bottom:15px;"><input type="text" id="kasir-search-input" class="form-input" placeholder="Cari produk (F1)..."></div><div id="product-grid" class="product-grid" style="flex-grow:1;"></div></div><div id="cart-container" class="card cart-container" style="margin-bottom:0;"><button class="mobile-cart-close-btn" data-action="hideMobileCart">&times;</button><h3 style="margin-bottom:15px;">Keranjang</h3><div id="cart-items" style="flex-grow:1; overflow-y:auto; padding-right:10px;"></div><div id="cart-total" style="margin-top:auto; padding-top:15px; border-top:1px solid var(--neutral-200);"></div><div id="cart-actions" style="display:flex; flex-direction:column; gap:10px; margin-top:15px;"><button class="btn btn-primary" style="flex:1;" data-action="openPaymentModal" disabled>Bayar (F9)</button></div></div></div><div id="cart-summary-bar" data-action="showMobileCart"></div>`;
            
            setTimeout(() => {
                const searchInput = document.getElementById('kasir-search-input');
                searchInput.addEventListener('input', e => this.renderProductGrid(e.target.value));
                document.getElementById('product-grid').addEventListener('click', e => {
                    const card = e.target.closest('.product-card:not(.out-of-stock)');
                    if (card) this.addToCart(parseInt(card.dataset.id));
                });
                this.renderProductGrid();
                this.renderCart();
            }, 0);

            return kasirHTML;
        },

        renderProductGrid(searchTerm = '') {
            const grid = document.getElementById('product-grid');
            if (!grid) return;
            const filteredProducts = searchTerm ? this.state.products.filter(p => this.fuzzySearch(p.name, searchTerm)) : this.state.products;
            grid.innerHTML = filteredProducts.length ? filteredProducts.map(p => {
                const imageHTML = p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.name}">` : `<div class="product-card-placeholder">${p.name.charAt(0)}</div>`;
                return `<div class="product-card ${p.stock <= 0 ? 'out-of-stock' : ''}" data-id="${p.id}"><div class="product-card-stock">Stok: ${p.stock}</div>${imageHTML}<div class="product-card-info"><h4>${p.name}</h4><p>${this.formatIntToRupiah(p.price)}</p></div></div>`
            }).join('') : `<p style="color: var(--neutral-400); text-align:center; width:100%;">Produk tidak ditemukan.</p>`;
        },

        renderRiwayat() {
            const pageState = this.state.pagination.transactions;
            const riwayatHTML = `<div class="page-container">
                <header class="header"><h1>Riwayat Transaksi</h1></header>
                <div class="page-header">
                    <input type="text" id="history-search" class="form-input" placeholder="Cari ID transaksi, nama pelanggan..." style="max-width:400px;" value="${pageState.filter}">
                </div>
                <div class="card" style="padding:0;">
                    <div class="table-wrapper" id="history-table-container"></div>
                </div>
            </div>`;

            setTimeout(() => {
                const searchInput = document.getElementById('history-search');
                searchInput.addEventListener('input', e => {
                    pageState.filter = e.target.value;
                    pageState.currentPage = 1;
                    this.renderTransactionHistory();
                });
                this.renderTransactionHistory();
            }, 0);
            return riwayatHTML;
        },

        renderTransactionHistory() {
            const container = document.getElementById('history-table-container');
            if (!container) return;
            
            const pageState = this.state.pagination.transactions;
            const filtered = this.state.transactions.filter(t => 
                this.fuzzySearch(t.id, pageState.filter) || this.fuzzySearch(t.customerName, pageState.filter)
            );

            const startIndex = (pageState.currentPage - 1) * this.state.itemsPerPage;
            const endIndex = startIndex + this.state.itemsPerPage;
            const paginatedItems = filtered.slice(startIndex, endIndex);

            let tableHTML = `<table class="responsive-table"><thead><tr><th>ID Transaksi</th><th>Tanggal</th><th>Pelanggan</th><th>Total</th><th>Kasir</th><th>Aksi</th></tr></thead><tbody>`;
            if (paginatedItems.length > 0) {
                paginatedItems.forEach(t => {
                    tableHTML += `<tr><td data-label="ID Transaksi">${t.id}</td><td data-label="Tanggal">${this.formatDate(t.date, true)}</td><td data-label="Pelanggan">${t.customerName}</td><td data-label="Total">${this.formatIntToRupiah(t.finalTotal)}</td><td data-label="Kasir">${t.userName}</td><td data-label="Aksi"><div class="actions"><button class="btn btn-text" data-action="viewTransaction" data-id="${t.id}"><i class="fa-solid fa-eye"></i></button></div></td></tr>`;
                });
            } else { tableHTML += `<tr><td colspan="6" style="text-align:center;">Transaksi tidak ditemukan.</td></tr>`; }
            tableHTML += `</tbody></table>`;
            
            container.innerHTML = tableHTML + this.renderPaginator('transactions', filtered.length);
        },

        renderLainnya() {
            const adminMenus = [ { id: 'produk', icon: 'fa-solid fa-box-open', label: 'Produk'}, { id: 'analitik', icon: 'fa-solid fa-chart-line', label: 'Analitik'}, { id: 'pelanggan', icon: 'fa-solid fa-users', label: 'Pelanggan'}, { id: 'biaya', icon: 'fa-solid fa-wallet', label: 'Biaya'}, { id: 'pengguna', icon: 'fa-solid fa-user-shield', label: 'Pengguna'}, { id: 'pengaturan', icon: 'fa-solid fa-gear', label: 'Pengaturan'} ];
            const menuItemsHTML = (this.state.currentUser.role === 'admin' ? adminMenus : []).map(item => `<li class="lainnya-menu-item"><a href="#" class="nav-link" data-page="${item.id}"><i class="${item.icon}"></i>${item.label}</a></li>`).join('');
            return `<div class="page-container"><header class="header"><h1>Lainnya</h1></header><ul class="lainnya-menu">${menuItemsHTML}<li class="lainnya-menu-item"><a href="#" data-action="logout"><i class="fa-solid fa-right-from-bracket"></i>Keluar</a></li></ul></div>`; 
        },

        renderPengaturan() {
            const banners = this.state.settings.dashboardBanners || [];
            const bannerPreviewHTML = banners.map((src, index) => `<div class="banner-preview-item"><img src="${src}" alt="Banner ${index + 1}"><button class="banner-remove-btn" data-action="removeBanner" data-id="${index}">&times;</button></div>`).join('');
            return `<div class="page-container"><header class="header"><h1>Pengaturan</h1></header><div class="card"><h2>Pengaturan Toko</h2><form id="settings-form" novalidate><div class="form-group"><input type="text" id="s-namaToko" class="form-input" placeholder=" " required value="${this.state.settings.namaToko}"><label class="form-label">Nama Toko</label></div><div class="form-group"><input type="text" id="s-alamatToko" class="form-input" placeholder=" " required value="${this.state.settings.alamatToko}"><label class="form-label">Alamat Toko</label></div><div class="form-group"><input type="tel" id="s-teleponToko" class="form-input" placeholder=" " required value="${this.state.settings.teleponToko}"><label class="form-label">No. Telepon</label></div><div class="form-group"><textarea id="s-pesanDiStruk" class="form-input" placeholder=" " required>${this.state.settings.pesanDiStruk}</textarea><label class="form-label">Pesan di Struk</label></div><div class="form-group"><input type="number" id="s-lowStock" class="form-input" placeholder=" " required value="${this.state.settings.lowStockThreshold}"><label class="form-label">Ambang Batas Stok Rendah</label></div><button type="button" class="btn btn-primary" data-action="saveSettings">Simpan Pengaturan</button></form></div><div class="card"><h2>Manajemen Banner Beranda</h2><p style="color: var(--neutral-600); margin-bottom: 20px;">Unggah hingga 5 gambar untuk ditampilkan di beranda.</p><div id="banner-preview-grid" class="banner-preview-grid">${bannerPreviewHTML}</div>${banners.length < 5 ? `<div style="margin-top: 20px;"><label for="banner-uploader" class="btn btn-secondary"><i class="fa-solid fa-upload"></i> Unggah Gambar</label><input type="file" id="banner-uploader" data-uploader="dashboardBanners" accept="image/*" multiple></div>` : `<p style="color: var(--warning-700); margin-top: 20px; font-weight: 500;">Slot banner sudah penuh (Maksimal 5).</p>`}</div></div>`;
        },

        // === 6. LOGIKA KERANJANG & PEMBAYARAN ===
        getCurrentCartItems() { return this.state.cart; },
        saveCurrentCart(items) { this.state.cart = items; this.saveToLocalStorage('cart', this.state.cart); },
        
        addToCart(productId) {
            const product = this.state.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) return;
            let currentCart = [...this.getCurrentCartItems()];
            const cartItem = currentCart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) { cartItem.quantity++; } 
                else { this.showToast(`Stok ${product.name} tidak mencukupi.`, 'warning'); return; }
            } else { currentCart.push({ ...product, quantity: 1 }); }
            this.saveCurrentCart(currentCart);
            this.scheduleRender('renderCart');
        },

        updateCartQuantity(productId, change) {
            let currentCart = [...this.getCurrentCartItems()];
            const cartItemIndex = currentCart.findIndex(item => item.id == productId);
            if (cartItemIndex === -1) return;
            const cartItem = currentCart[cartItemIndex];
            if (change === -Infinity || (cartItem.quantity + change <= 0)) { 
                currentCart.splice(cartItemIndex, 1);
            } else {
                const product = this.state.products.find(p => p.id == productId);
                const newQuantity = cartItem.quantity + change;
                if (product && newQuantity > product.stock) { this.showToast(`Stok ${product.name} tidak mencukupi.`, 'warning'); return; }
                cartItem.quantity = newQuantity;
            }
            this.saveCurrentCart(currentCart);
            this.scheduleRender('renderCart');
        },

        renderCart() {
            const cartItemsContainer = document.getElementById('cart-items');
            if (!cartItemsContainer) return;
            
            let items = this.getCurrentCartItems();
            let priceUpdated = false;

            items.forEach(item => {
                const productMaster = this.state.products.find(p => p.id === item.id);
                if (productMaster && item.price !== productMaster.price) {
                    item.price = productMaster.price;
                    item.priceJustUpdated = true;
                    priceUpdated = true;
                }
            });
            if (priceUpdated) {
                this.saveCurrentCart(items);
                this.showToast('Beberapa harga item di keranjang telah diperbarui.', 'warning');
            }

            const { subtotal, finalTotal } = this.calculateCartTotals(items);
            cartItemsContainer.innerHTML = items.length > 0 ? items.map(item => {
                const flashClass = item.priceJustUpdated ? 'price-updated-flash' : '';
                if(item.priceJustUpdated) delete item.priceJustUpdated;
                
                return `<div id="cart-item-${item.id}" class="${flashClass}" style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--neutral-100);"><div><strong style="display:block; margin-bottom: 4px; font-size: 14px;">${item.name}</strong><div class="cart-item-controls"><button data-action="updateCartQty" data-id="${item.id}" data-change="-1">-</button><span class="cart-item-qty">${item.quantity}</span><button data-action="updateCartQty" data-id="${item.id}" data-change="1">+</button><button data-action="removeFromCart" data-id="${item.id}" style="margin-left:10px; color: var(--danger-500); background: transparent;"><i class="fa-solid fa-trash"></i></button></div></div><div style="text-align:right;"><strong class="cart-item-total" style="font-weight: 500;">${this.formatIntToRupiah(item.price * item.quantity)}</strong></div></div>`;
            }).join('') : `<p class="empty-cart-msg" style="color: var(--neutral-400); text-align:center; padding: 20px 0;">Keranjang kosong</p>`;
            
            const totalEl = document.getElementById('cart-total');
            if (totalEl) { totalEl.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom: 5px;"><span>Subtotal:</span><span>${this.formatIntToRupiah(subtotal)}</span></div><div style="display:flex; justify-content:space-between; align-items:center; font-size: 1.2em;"><strong>Total:</strong> <strong>${this.formatIntToRupiah(finalTotal)}</strong></div>`; }
            
            document.querySelector('[data-action="openPaymentModal"]')?.toggleAttribute('disabled', items.length === 0);
            
            const summaryBar = document.getElementById('cart-summary-bar');
            if (summaryBar) {
                if (items.length > 0) {
                    summaryBar.style.display = 'flex';
                    summaryBar.innerHTML = `<span>${items.reduce((t, i) => t + i.quantity, 0)} item (${this.formatIntToRupiah(finalTotal)})</span><strong>Lihat Keranjang & Bayar &nbsp; &rsaquo;</strong>`;
                } else { summaryBar.style.display = 'none'; }
            }
        },

        calculateCartTotals(items) { 
            const finalTotal = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            return { subtotal: finalTotal, totalDiscount: 0, finalTotal };
        },

        openPaymentModal() { 
            const items = this.getCurrentCartItems(); if (items.length === 0) return; 
            const { finalTotal } = this.calculateCartTotals(items); 
            const content = `<div style="text-align:center; margin-bottom:20px;"><span style="font-size: 14px; color: var(--neutral-600);">Total Tagihan</span><h3 style="font-size: 32px; color: var(--primary-500);">${this.formatIntToRupiah(finalTotal)}</h3></div><div class="form-group"><select id="p-method" class="form-input"><option value="Tunai">Tunai</option><option value="QRIS">QRIS</option><option value="Kartu">Kartu Debit/Kredit</option></select><label class="form-label">Metode Pembayaran</label></div><div id="cash-payment-fields"><div class="form-group"><input type="number" id="p-paid" class="form-input" placeholder=" " required min="${finalTotal}" inputmode="numeric"><label class="form-label">Jumlah Dibayar</label></div><div style="text-align:center; margin-top: -15px;"><span style="font-size: 14px; color: var(--neutral-600);">Kembalian</span><h3 id="payment-change" style="font-size: 24px;">${this.formatIntToRupiah(0)}</h3></div></div><hr style="margin: 20px 0;"><div style="display:flex; justify-content:space-between; align-items:center;"><span>Pelanggan: <strong>${this.state.activeTransaction.customerName}</strong></span><button type="button" class="btn btn-secondary" data-action="showCustomerSelection">Ganti</button></div>`; 
            this.showModal('Pembayaran', content, () => this.processPayment(items), 'Proses Pembayaran'); 
            const paidInput = document.getElementById('p-paid'); 
            const changeEl = document.getElementById('payment-change'); 
            const methodSelect = document.getElementById('p-method'); 
            const cashFields = document.getElementById('cash-payment-fields'); 
            paidInput.addEventListener('input', () => { const paidAmount = this.parseRupiahToInt(paidInput.value) || 0; const change = paidAmount - finalTotal; changeEl.textContent = this.formatIntToRupiah(change >= 0 ? change : 0); }); 
            methodSelect.addEventListener('change', () => { if (methodSelect.value !== 'Tunai') { cashFields.style.display = 'none'; paidInput.value = finalTotal; paidInput.required = false; changeEl.textContent = this.formatIntToRupiah(0); } else { cashFields.style.display = 'block'; paidInput.value = ''; paidInput.required = true; } }); 
        },

        processPayment(paidItems) {
            const { finalTotal, subtotal } = this.calculateCartTotals(paidItems);
            const method = document.getElementById('p-method').value;
            let paidAmount = finalTotal, changeAmount = 0;
            if (method === 'Tunai') {
                const paidInput = document.getElementById('p-paid');
                if (!paidInput || !paidInput.value) { this.showToast('Masukkan jumlah uang dibayar!', 'error'); return false; }
                paidAmount = this.parseRupiahToInt(paidInput.value);
                if (isNaN(paidAmount) || paidAmount < finalTotal) { this.showToast('Jumlah bayar tidak cukup!', 'error'); return false; }
                changeAmount = paidAmount - finalTotal;
            }
            const trxId = 'TRX-' + Date.now();
            paidItems.forEach(item => {
                const product = this.state.products.find(p => p.id === item.id);
                if (product) {
                    const oldStock = product.stock;
                    product.stock -= item.quantity;
                    this.addStockLog(product.id, -item.quantity, oldStock, product.stock, `Penjualan #${trxId}`);
                }
            });
            const newTransaction = { id: trxId, date: new Date().toISOString(), items: paidItems, subtotal, totalDiscount: 0, finalTotal, paymentMethod: method, paidAmount, changeAmount, customerId: this.state.activeTransaction.customerId, customerName: this.state.activeTransaction.customerName, userId: this.state.currentUser.id, userName: this.state.currentUser.name, shiftId: this.state.activeShift ? this.state.activeShift.id : null, };
            this.state.transactions.unshift(newTransaction);
            if (this.state.activeTransaction.customerId) {
                const customer = this.state.customers.find(c => c.id == this.state.activeTransaction.customerId);
                if (customer) { customer.totalSpent = (customer.totalSpent || 0) + finalTotal; customer.visitCount = (customer.visitCount || 0) + 1; }
            }
            this.state.cart = [];
            this.state.activeTransaction = { customerId: null, customerName: 'Pelanggan Umum' };
            this.saveToLocalStorage('transactions', this.state.transactions);
            this.saveToLocalStorage('products', this.state.products);
            this.saveToLocalStorage('stockHistory', this.state.stockHistory);
            this.saveToLocalStorage('customers', this.state.customers);
            this.saveToLocalStorage('cart', this.state.cart);
            this.closeModal();
            setTimeout(() => this.showReceiptOptionsModal(trxId), 100); 
            this.toggleMobileCart(false);
            this.scheduleRender('renderCart');
            return true;
        },

        showReceiptOptionsModal(transactionId) {
            const trx = this.state.transactions.find(t => t.id === transactionId);
            if (!trx) return;
            const receiptHTML = this.generateReceiptHTML(trx);
            const defaultFilename = `Struk-${this.state.settings.namaToko.replace(/\s+/g, '-')}-${trx.id}.png`;
            const content = `<div style="text-align: center; margin-bottom: 20px;"><i class="fa-solid fa-circle-check" style="color: var(--success-500); font-size: 48px;"></i><h3 style="margin-top: 15px;">Transaksi Berhasil!</h3></div><div style="border: 1px solid var(--neutral-200); border-radius: 8px; max-height: 300px; overflow-y: auto;">${receiptHTML}</div><div id="receipt-actions" style="margin-top: 25px;"><div class="form-group"><input type="text" id="receipt-filename" class="form-input" value="${defaultFilename}" placeholder=" "><label for="receipt-filename" class="form-label">Nama File Nota</label></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;"><button class="btn btn-secondary" data-action="saveReceipt"><i class="fa-solid fa-floppy-disk"></i> Simpan Nota</button><button class="btn btn-secondary" data-action="printThermalReceipt"><i class="fa-solid fa-print"></i> Cetak Struk</button></div><button class="btn btn-primary" data-action="finishTransaction" style="width: 100%;">Selesai (Transaksi Baru)</button></div>`;
            this.showModal('Opsi Struk', content, null);
            const modalFooter = document.querySelector('#modal-container .modal-content div[style*="text-align:right"]');
            if(modalFooter) modalFooter.remove();
        },
        showTransactionDetailModal(transactionId) { const trx = this.state.transactions.find(t => t.id === transactionId); if (!trx) return; const receiptHTML = this.generateReceiptHTML(trx); const content = `<div style="border: 1px solid var(--neutral-200); border-radius: 8px; max-height: 400px; overflow-y: auto;">${receiptHTML}</div>`; this.showModal(`Detail Transaksi: ${trx.id}`, content, null, '', false); const modalFooter = document.querySelector('.modal-content div[style*="text-align:right"]'); if (modalFooter) { modalFooter.innerHTML = `<button class="btn btn-secondary" data-action="printReceipt"><i class="fa-solid fa-print"></i> Cetak Ulang Struk</button>`; } },
        generateReceiptHTML(trx) { const { settings } = this.state; return `<div id="receipt-print-area" style="font-family: 'Courier New', monospace; color: #000; padding: 20px;"><div style="text-align:center;"><h3 style="margin:0; font-size: 18px;">${settings.namaToko}</h3><p style="margin:0; font-size: 12px;">${settings.alamatToko}</p><p style="margin:0; font-size: 12px;">Tel: ${settings.teleponToko}</p></div><hr style="border: 1px dashed #000; margin: 10px 0;"><table style="font-size: 12px; width: 100%;"><tr><td>No Trans:</td><td style="text-align:right;">${trx.id}</td></tr><tr><td>Kasir:</td><td style="text-align:right;">${trx.userName}</td></tr><tr><td>Tanggal:</td><td style="text-align:right;">${this.formatDate(trx.date, true)}</td></tr><tr><td>Pelanggan:</td><td style="text-align:right;">${trx.customerName}</td></tr></table><hr style="border: 1px dashed #000; margin: 10px 0;"><table style="font-size: 12px; width: 100%; border-collapse: collapse;">${trx.items.map(item => `<tr><td colspan="3">${item.name}</td></tr><tr><td style="padding-left: 10px;">${item.quantity} x ${this.formatIntToRupiah(item.price)}</td><td></td><td style="text-align:right;">${this.formatIntToRupiah(item.quantity * item.price)}</td></tr>`).join('')}</table><hr style="border: 1px dashed #000; margin: 10px 0;"><table style="font-size: 12px; width: 100%;"><tr><td>Subtotal</td><td style="text-align:right;">${this.formatIntToRupiah(trx.subtotal)}</td></tr>${trx.totalDiscount > 0 ? `<tr><td>Diskon</td><td style="text-align:right;">-${this.formatIntToRupiah(trx.totalDiscount)}</td></tr>` : ''}<tr><td style="font-weight:bold;">Total</td><td style="text-align:right; font-weight:bold;">${this.formatIntToRupiah(trx.finalTotal)}</td></tr><tr><td>Metode Bayar</td><td style="text-align:right;">${trx.paymentMethod}</td></tr>${trx.paymentMethod === 'Tunai' ? `<tr><td>Bayar (Tunai)</td><td style="text-align:right;">${this.formatIntToRupiah(trx.paidAmount)}</td></tr><tr><td>Kembali</td><td style="text-align:right;">${this.formatIntToRupiah(trx.changeAmount)}</td></tr>` : ''}</table><hr style="border: 1px dashed #000; margin: 10px 0;"><div style="text-align:center; font-size: 12px;"><p>${settings.pesanDiStruk}</p></div></div>`;},
        
        // === 7. FUNGSI-FUNGSI ADMIN ===
        renderProduk() {
            const pageState = this.state.pagination.products;
            const produkHTML = `<div class="page-container">
                <header class="header"><h1>Manajemen Produk</h1><button class="btn btn-primary" data-action="addProduct"><i class="fa-solid fa-plus"></i> Tambah Produk</button></header>
                <div class="page-header"><input type="text" id="product-search" class="form-input" placeholder="Cari produk..." style="max-width:400px;" value="${pageState.filter}"></div>
                <div class="card" style="padding:0;"><div class="table-wrapper" id="product-table-container"></div></div>
            </div>`;

            setTimeout(() => {
                const searchInput = document.getElementById('product-search');
                searchInput.addEventListener('input', e => {
                    pageState.filter = e.target.value;
                    pageState.currentPage = 1;
                    this.renderProductTable();
                });
                this.renderProductTable();
            }, 0);
            return produkHTML;
        },

        renderProductTable() {
            const container = document.getElementById('product-table-container');
            if(!container) return;
            const pageState = this.state.pagination.products;
            const filtered = this.state.products.filter(p => this.fuzzySearch(p.name, pageState.filter));
            const paginatedItems = filtered.slice((pageState.currentPage - 1) * this.state.itemsPerPage, pageState.currentPage * this.state.itemsPerPage);
            
            let tableHTML = `<table class="responsive-table"><thead><tr><th>Nama Produk</th><th>Kategori</th><th>Harga Jual</th><th>Harga Modal</th><th>Stok</th><th>Aksi</th></tr></thead><tbody>`;
            if (paginatedItems.length > 0) {
                paginatedItems.forEach(p => {
                    let stockBadge = p.stock <= 0 ? `<span class="stock-badge out">Habis</span>` : p.stock <= this.state.settings.lowStockThreshold ? `<span class="stock-badge low">${p.stock}</span>` : `<span class="stock-badge ok">${p.stock}</span>`;
                    tableHTML += `<tr><td data-label="Nama">${p.name}</td><td data-label="Kategori">${p.category}</td><td data-label="Harga Jual">${this.formatIntToRupiah(p.price)}</td><td data-label="Harga Modal">${this.formatIntToRupiah(p.cost || 0)}</td><td data-label="Stok">${stockBadge}</td><td data-label="Aksi"><div class="actions"><button class="btn btn-text" data-action="editProduct" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn btn-text" data-action="deleteProduct" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button></div></td></tr>`;
                });
            } else { tableHTML += `<tr><td colspan="6" style="text-align:center;">Produk tidak ditemukan.</td></tr>`; }
            tableHTML += `</tbody></table>`;

            container.innerHTML = tableHTML + this.renderPaginator('products', filtered.length);
        },

        showProductModal(productId) {
            const isEdit = productId !== undefined;
            const product = isEdit ? this.state.products.find(p => p.id == productId) : {};
            const content = `<div class="form-group"><input type="text" id="p-name" class="form-input" placeholder=" " value="${product.name || ''}" required><label class="form-label">Nama Produk</label></div>
            <div class="form-group"><input type="text" id="p-category" class="form-input" placeholder=" " value="${product.category || ''}" required><label class="form-label">Kategori</label></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="form-group"><input type="number" id="p-price" class="form-input" placeholder=" " value="${product.price || ''}" required min="0" inputmode="numeric"><label class="form-label">Harga Jual</label></div>
                <div class="form-group"><input type="number" id="p-cost" class="form-input" placeholder=" " value="${product.cost || ''}" required min="0" inputmode="numeric"><label class="form-label">Harga Modal</label></div>
            </div>
            ${isEdit ? `<div class="form-group"><input type="number" id="p-stock-current" class="form-input" value="${product.stock}" disabled><label class="form-label">Stok Saat Ini</label></div><div class="form-group"><input type="number" id="p-stock-adjust" class="form-input" placeholder=" " inputmode="numeric"><label class="form-label">Jumlah Penyesuaian Stok (+/-)</label></div>` : 
            `<div class="form-group"><input type="number" id="p-stock-initial" class="form-input" placeholder=" " value="0" required min="0" inputmode="numeric"><label class="form-label">Stok Awal</label></div>`}`;
            this.showModal(isEdit ? 'Edit Produk' : 'Tambah Produk', content, () => this.saveProduct(productId));
        },

        saveProduct(productId) {
            const name = document.getElementById('p-name').value.trim();
            const price = this.parseRupiahToInt(document.getElementById('p-price').value);
            const cost = this.parseRupiahToInt(document.getElementById('p-cost').value);
            if (!name || isNaN(price) || isNaN(cost)) return false;
            
            const productData = { name, category: document.getElementById('p-category').value.trim(), price, cost };

            if (productId) {
                const index = this.state.products.findIndex(p => p.id == productId);
                const product = this.state.products[index];
                const stockAdjustInput = document.getElementById('p-stock-adjust');
                if (stockAdjustInput && stockAdjustInput.value.trim() !== '') {
                    const change = parseInt(stockAdjustInput.value, 10);
                    if (!isNaN(change)) {
                        const oldStock = product.stock;
                        const newStock = oldStock + change;
                        if (newStock < 0) { this.showToast('Stok tidak boleh kurang dari nol.', 'error'); return false; }
                        product.stock = newStock;
                        this.addStockLog(product.id, change, oldStock, newStock, 'Penyesuaian saat edit');
                    }
                }
                this.state.products[index] = { ...product, ...productData };
            } else {
                const initialStock = parseInt(document.getElementById('p-stock-initial').value, 10);
                if(isNaN(initialStock)) return false;
                productData.stock = initialStock;
                productData.id = Date.now();
                productData.imageUrl = null;
                this.state.products.push(productData);
                this.addStockLog(productData.id, initialStock, 0, initialStock, 'Stok Awal');
            }

            this.saveToLocalStorage('products', this.state.products);
            this.saveToLocalStorage('stockHistory', this.state.stockHistory);
            this.showPage('produk');
            this.showToast(`Produk berhasil ${productId ? 'diperbarui' : 'ditambahkan'}.`);
            return true;
        },

        deleteProduct(productId) { this.showConfirmModal('Hapus Produk?', 'Anda yakin ingin menghapus produk ini?', () => { this.state.products = this.state.products.filter(p => p.id != productId); this.saveToLocalStorage('products', this.state.products); this.showPage('produk'); this.showToast('Produk berhasil dihapus.'); }); },
        addStockLog(productId, change, from, to, reason) { this.state.stockHistory.unshift({ id: 'STK-' + Date.now(), productId, date: new Date().toISOString(), change, from, to, reason, userId: this.state.currentUser.id, userName: this.state.currentUser.name }); },
        
        renderPelanggan() {
            const pageState = this.state.pagination.customers;
            const pelangganHTML = `<div class="page-container">
                <header class="header"><h1>Pelanggan</h1><button class="btn btn-primary" data-action="addCustomer"><i class="fa-solid fa-plus"></i> Tambah Pelanggan</button></header>
                <div class="page-header"><input type="text" id="customer-search" class="form-input" placeholder="Cari nama atau no. HP..." style="max-width:400px;" value="${pageState.filter}"></div>
                <div class="card" style="padding:0;"><div class="table-wrapper" id="customer-table-container"></div></div>
            </div>`;

            setTimeout(() => {
                const searchInput = document.getElementById('customer-search');
                searchInput.addEventListener('input', e => {
                    pageState.filter = e.target.value;
                    pageState.currentPage = 1;
                    this.renderCustomerTable();
                });
                this.renderCustomerTable();
            }, 0);
            return pelangganHTML;
        },

        renderCustomerTable() {
            const container = document.getElementById('customer-table-container');
            if(!container) return;
            const pageState = this.state.pagination.customers;
            const filtered = this.state.customers.filter(c => this.fuzzySearch(c.name, pageState.filter) || (c.phone && c.phone.includes(pageState.filter)));
            const paginatedItems = filtered.slice((pageState.currentPage - 1) * this.state.itemsPerPage, pageState.currentPage * this.state.itemsPerPage);
            
            let tableHTML = `<table class="responsive-table"><thead><tr><th>Nama</th><th>No. HP</th><th>Total Belanja</th><th>Kunjungan</th><th>Aksi</th></tr></thead><tbody>`;
            if (paginatedItems.length > 0) {
                paginatedItems.forEach(c => {
                    tableHTML += `<tr><td data-label="Nama">${c.name}</td><td data-label="No. HP">${c.phone || '-'}</td><td data-label="Total Belanja">${this.formatIntToRupiah(c.totalSpent || 0)}</td><td data-label="Kunjungan">${c.visitCount || 0}</td><td data-label="Aksi"><div class="actions"><button class="btn btn-text" data-action="editCustomer" data-id="${c.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn btn-text" data-action="deleteCustomer" data-id="${c.id}"><i class="fa-solid fa-trash"></i></button></div></td></tr>`;
                });
            } else { tableHTML += `<tr><td colspan="5" style="text-align:center;">Pelanggan tidak ditemukan.</td></tr>`; }
            tableHTML += `</tbody></table>`;

            container.innerHTML = tableHTML + this.renderPaginator('customers', filtered.length);
        },

        showCustomerModal(customerId) { const isEdit = customerId !== undefined; const customer = isEdit ? this.state.customers.find(c => c.id == customerId) : {}; const content = `<div class="form-group"><input type="text" id="c-name" class="form-input" placeholder=" " required value="${customer.name || ''}"><label class="form-label">Nama</label></div><div class="form-group"><input type="tel" id="c-phone" class="form-input" placeholder=" " value="${customer.phone || ''}"><label class="form-label">No. HP (Opsional)</label></div>`; this.showModal(isEdit ? 'Edit Pelanggan' : 'Tambah Pelanggan', content, () => this.saveCustomer(customerId)); },
        saveCustomer(customerId) { const name = document.getElementById('c-name').value.trim(); const phone = document.getElementById('c-phone').value.trim(); if (!name) return false; if (customerId) { const index = this.state.customers.findIndex(c => c.id == customerId); this.state.customers[index] = { ...this.state.customers[index], name, phone }; } else { this.state.customers.push({ id: Date.now(), name, phone, totalSpent: 0, visitCount: 0 }); } this.saveToLocalStorage('customers', this.state.customers); this.showPage('pelanggan'); this.showToast(`Pelanggan berhasil ${customerId ? 'diperbarui' : 'ditambahkan'}.`); return true; },
        deleteCustomer(customerId) { this.showConfirmModal('Hapus Pelanggan?', 'Anda yakin ingin menghapus pelanggan ini?', () => { this.state.customers = this.state.customers.filter(c => c.id != customerId); this.saveToLocalStorage('customers', this.state.customers); this.showPage('pelanggan'); this.showToast('Pelanggan berhasil dihapus.'); }); },
        
        renderAnalitik() {
            const today = new Date();
            const lastWeek = new Date();
            lastWeek.setDate(today.getDate() - 6);
            const renderAnalitikHTML = `<div class="page-container"><header class="header"><h1>Analitik & Laporan</h1></header><div class="card"><div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center; justify-content:space-between;"><div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;"><div class="form-group" style="margin-bottom:0;"><input type="date" id="report-start" class="form-input" value="${lastWeek.toISOString().slice(0,10)}"><label class="form-label has-value">Mulai</label></div><div class="form-group" style="margin-bottom:0;"><input type="date" id="report-end" class="form-input" value="${today.toISOString().slice(0,10)}"><label class="form-label has-value">Selesai</label></div></div><button id="generate-report-btn" class="btn btn-primary"><i class="fa-solid fa-arrows-rotate"></i> Tampilkan</button></div></div><div id="report-results"></div></div>`;
            
            setTimeout(() => {
                document.getElementById('generate-report-btn').addEventListener('click', () => this.renderAnalyticsPage());
                this.renderAnalyticsPage();
            }, 0);
            return renderAnalitikHTML;
        },

        renderAnalyticsPage() {
            const resultsContainer = document.getElementById('report-results'); if (!resultsContainer) return;
            const start = new Date(document.getElementById('report-start').value); const end = new Date(document.getElementById('report-end').value); end.setHours(23, 59, 59, 999);
            const trx = this.state.transactions.filter(t => { const tDate = new Date(t.date); return tDate >= start && tDate <= end; });
            const totalRevenue = trx.reduce((sum, t) => sum + t.finalTotal, 0); const totalTransactions = trx.length;
            const productSales = {}; trx.forEach(t => t.items.forEach(item => { productSales[item.name] = (productSales[item.name] || 0) + item.quantity; }));
            const sortedProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
            resultsContainer.innerHTML = `<div class="stats-grid"><div class="stat-card"><h4>Total Pendapatan</h4><p class="stat-card-value">${this.formatIntToRupiah(totalRevenue)}</p></div><div class="stat-card"><h4>Total Transaksi</h4><p class="stat-card-value">${totalTransactions}</p></div><div class="stat-card"><h4>Rata-rata / Transaksi</h4><p class="stat-card-value">${this.formatIntToRupiah(totalTransactions > 0 ? Math.round(totalRevenue / totalTransactions) : 0)}</p></div></div><div class="card"><div class="chart-container" style="height: 300px;"><canvas id="salesChart"></canvas></div></div><div class="card"><h4>Produk Terlaris</h4><div class="table-wrapper"><table class="responsive-table"><thead><tr><th>Nama Produk</th><th>Jumlah Terjual</th></tr></thead><tbody>${sortedProducts.length > 0 ? sortedProducts.map(([name, qty]) => `<tr><td data-label="Produk">${name}</td><td data-label="Jumlah">${qty}</td></tr>`).join('') : '<tr><td colspan="2">Tidak ada data penjualan.</td></tr>'}</tbody></table></div></div>`;
            if (trx.length > 0) this.renderSalesChart(trx);
        },

        renderSalesChart(transactions) {
            if (this.charts.salesChart) this.charts.salesChart.destroy();
            const ctx = document.getElementById('salesChart')?.getContext('2d'); if (!ctx) return;
            const salesByDate = transactions.reduce((acc, curr) => { const date = curr.date.split('T')[0]; acc[date] = (acc[date] || 0) + curr.finalTotal; return acc; }, {});
            const sortedDates = Object.keys(salesByDate).sort((a, b) => new Date(a) - new Date(b));
            this.charts.salesChart = new Chart(ctx, { type: 'line', data: { labels: sortedDates, datasets: [{ label: 'Pendapatan', data: sortedDates.map(date => salesByDate[date]), borderColor: 'var(--primary-500)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 }] }, options: { maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd MMM yyyy' } }, y: { ticks: { callback: (value) => this.formatIntToRupiah(value) } } } } });
        },

        // === 8. UTILITAS LAINNYA ===
        initCarousel() {
            const carousel = document.getElementById('dashboard-carousel'); if (!carousel) return;
            const track = carousel.querySelector('.carousel-track'); const slides = Array.from(track.children); const dots = Array.from(carousel.querySelectorAll('.carousel-dot'));
            if (slides.length <= 1) return;
            let currentIndex = 0;
            const goToSlide = (index) => { if(!track || !dots[index]) return; track.style.transform = `translateX(-${index * 100}%)`; dots.forEach(dot => dot.classList.remove('active')); dots[index].classList.add('active'); currentIndex = index; };
            dots.forEach(dot => { dot.addEventListener('click', e => { const targetIndex = parseInt(e.target.dataset.slideTo); goToSlide(targetIndex); clearInterval(this.carouselInterval); this.carouselInterval = setInterval(autoSlide, 3000); }); });
            const autoSlide = () => { const nextIndex = (currentIndex + 1) % slides.length; goToSlide(nextIndex); };
            this.carouselInterval = setInterval(autoSlide, 3000);
        },
        
        async handleUploader(type, files) {
            if (!files || files.length === 0) return;
            this.showLoader();
            if (type === 'dashboardBanners') {
                const currentBanners = this.state.settings.dashboardBanners || [];
                const slotsAvailable = 5 - currentBanners.length;
                if (files.length > slotsAvailable) { this.showToast(`Anda hanya bisa menambahkan ${slotsAvailable} banner lagi.`, 'warning'); }
                const filesToProcess = Array.from(files).slice(0, slotsAvailable);

                const compressionOptions = {
                    maxSizeMB: 0.5,
                    maxWidthOrHeight: 1280,
                    useWebWorker: true,
                };

                try {
                    const compressedFiles = await Promise.all(filesToProcess.map(file => imageCompression(file, compressionOptions)));
                    const base64Promises = compressedFiles.map(file => new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = error => reject(error);
                        reader.readAsDataURL(file);
                    }));
                    
                    const base64results = await Promise.all(base64Promises);
                    this.state.settings.dashboardBanners.push(...base64results);
                    this.saveToLocalStorage('settings', this.state.settings);
                    this.showPage('pengaturan');
                    this.showToast(`${base64results.length} banner berhasil dikompresi dan ditambahkan.`, 'success');

                } catch (error) {
                    console.error("Error compressing or processing banner images:", error);
                    this.showToast('Gagal memproses gambar banner.', 'error');
                } finally {
                    this.hideLoader();
                }
            } else {
                this.hideLoader();
            }
        },

        toggleMobileCart(show) {
            const cartContainer = document.getElementById('cart-container'); const body = document.body;
            if (cartContainer) {
                if (show) { body.classList.add('mobile-cart-open'); cartContainer.classList.add('is-visible'); } 
                else { body.classList.remove('mobile-cart-open'); cartContainer.classList.remove('is-visible'); }
            }
        },
    };
    
    App.init();
});

</script>
</body>
</html>