<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>tokopintar.id - Professional POS</title>

    <style>
        /* === 1. DESIGN SYSTEM & RESET === */
        :root {
            --primary-500: #3b82f6; --primary-600: #2563eb;
            --neutral-0: #ffffff; --neutral-50: #f8fafc; --neutral-100: #f1f5f9; --neutral-200: #e2e8f0; --neutral-400: #94a3b8; --neutral-600: #475569; --neutral-800: #1e293b;
            --success-500: #10b981; --success-100: #d1fae5; --success-700: #047857;
            --danger-500: #ef4444; --danger-100: #fee2e2; --danger-700: #b91c1c;
            --warning-500: #f59e0b; --warning-100: #fef3c7; --warning-700: #b45309;
            --font-main: 'Inter', sans-serif;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }
        html { scroll-behavior: smooth; }
        body { background-color: var(--neutral-100); color: var(--neutral-800); -webkit-font-smoothing: antialiased; }
        ::selection { background-color: var(--primary-500); color: var(--neutral-0); }

        /* === 2. LAYOUT UTAMA (MOBILE-FIRST) === */
        .app-container { display: flex; }
        .main-content { width: 100%; padding: 0; padding-bottom: 80px; /* Space for bottom nav */ transition: margin-left 0.3s ease; }
        .sidebar { display: none; } /* Hidden on mobile */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background-color: var(--neutral-0); border-top: 1px solid var(--neutral-200); display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .bottom-nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--neutral-400); gap: 4px; }
        .bottom-nav-link i { font-size: 20px; }
        .bottom-nav-link span { font-size: 10px; font-weight: 500; }
        .bottom-nav-link.active { color: var(--primary-500); }

        /* TABLET LAYOUT */
        @media (min-width: 768px) {
            .main-content { margin-left: 80px; width: calc(100% - 80px); padding: 20px; padding-bottom: 20px; }
            .sidebar { display: flex; flex-direction: column; position: fixed; width: 80px; height: 100vh; background-color: var(--neutral-0); border-right: 1px solid var(--neutral-200); padding: 20px 0; transition: width 0.3s ease; z-index: 1001; }
            .sidebar:hover { width: 250px; }
            .sidebar-header { display: flex; align-items: center; justify-content: center; padding: 0 10px; min-height: 40px; }
            .sidebar-header i { color: var(--primary-500); font-size: 28px; }
            .sidebar-header h2 { font-size: 22px; opacity: 0; visibility: hidden; white-space: nowrap; }
            .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu { list-style: none; margin-top: 30px; }
            .sidebar-menu a { display: flex; align-items: center; text-decoration: none; color: var(--neutral-600); padding: 15px 28px; white-space: nowrap; }
            .sidebar-menu a i { font-size: 22px; min-width: 24px; }
            .sidebar-menu a span { margin-left: 20px; font-weight: 500; opacity: 0; visibility: hidden; }
            .sidebar:hover .sidebar-menu a span { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu a:hover { background-color: var(--neutral-100); }
            .sidebar-menu a.active { color: var(--primary-500); font-weight: 600; position: relative; }
            .sidebar-menu a.active::before { content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background-color: var(--primary-500); border-radius: 0 4px 4px 0; }
            .bottom-nav { display: none; }
        }
        /* DESKTOP LAYOUT */
        @media (min-width: 1200px) {
            .main-content { margin-left: 250px; width: calc(100% - 250px); }
            .sidebar, .sidebar:hover { width: 250px; }
            .sidebar-header { justify-content: flex-start; padding: 0 25px; }
            .sidebar-header h2, .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: none; }
            .sidebar-menu a span, .sidebar:hover .sidebar-menu a span { opacity: 1; visibility: visible; transition: none; }
        }

        /* === 3. KOMPONEN UI MODERN === */
        .page-container { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 24px; }
        @media (min-width: 768px) { .header h1 { font-size: 28px; } }

        .card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; border-radius: 8px; font-weight: 600; text-decoration: none; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .btn:disabled { background-color: var(--neutral-200); color: var(--neutral-600); cursor: not-allowed; opacity: 0.7; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-500); color: var(--neutral-0); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-600); }
        .btn-secondary { background-color: var(--neutral-0); color: var(--neutral-800); border-color: var(--neutral-200); }
        .btn-secondary:hover { background-color: var(--neutral-50); }
        .btn-danger { background-color: var(--danger-500); color: var(--neutral-0); }
        .btn-danger:hover { background-color: #d73737; }
        .btn-text { background: none; color: var(--primary-500); padding: 8px; }
        .btn-text:hover { background-color: var(--neutral-100); }
        
        .form-group { position: relative; margin-bottom: 25px; }
        .form-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--neutral-200); font-size: 16px; background-color: var(--neutral-0); }
        .form-input:focus { border-color: var(--primary-500); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-label { position: absolute; left: 12px; top: 12px; font-size: 16px; color: var(--neutral-400); background-color: var(--neutral-0); padding: 0 4px; transition: all 0.2s ease; pointer-events: none; }
        .form-input:not(:placeholder-shown) + .form-label, .form-input:focus + .form-label, .form-group.has-value .form-label { top: -10px; font-size: 12px; color: var(--primary-500); }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        
        .modal { position: fixed; inset: 0; background-color: rgba(30, 41, 59, 0.5); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; padding: 15px; }
        .modal-content { background-color: var(--neutral-0); border-radius: 12px; padding: 25px; min-width: 300px; max-width: 500px; width: 100%; box-shadow: var(--shadow-md); animation: scaleIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-400); }

        #toast-container { position: fixed; bottom: 85px; right: 20px; z-index: 3000; } /* Adjusted position for bottom nav */
        .toast { padding: 15px 20px; border-radius: 8px; color: var(--neutral-0); margin-top: 10px; box-shadow: var(--shadow-md); animation: slideIn 0.3s ease; }
        .toast.success { background-color: var(--success-500); }
        .toast.error { background-color: var(--danger-500); }
        .toast.warning { background-color: var(--warning-500); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        @media (min-width: 768px) { #toast-container { bottom: 20px; } }

        /* === 4. TAMPILAN SPESIFIK HALAMAN === */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        
        /* Kasir */
        .kasir-container { display: grid; grid-template-columns: 1fr; gap: 20px; height: calc(100vh - 80px); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 5px; }
        .product-card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; overflow: hidden; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-card.out-of-stock { opacity: 0.5; cursor: not-allowed; }
        .product-card.out-of-stock::after { content: 'Stok Habis'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .product-card-stock { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.5); color: white; padding: 2px 6px; font-size: 10px; font-weight: 600; border-radius: 4px; }
        .product-card img { width: 100%; height: 100px; object-fit: cover; background-color: var(--neutral-200); }
        .product-card-placeholder { width:100%; height:100px; background-color: var(--neutral-200); color:var(--neutral-600); display:flex; align-items:center; justify-content:center; font-size: 3rem; font-weight: bold; }
        .product-card-info { padding: 10px; }
        .product-card-info h4 { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .product-card-info p { font-size: 12px; color: var(--primary-500); font-weight: 500; }
        #cart-summary-bar { position: fixed; bottom: 65px; left: 0; right: 0; background-color: var(--primary-500); color: var(--neutral-0); padding: 15px; display: none; justify-content: space-between; align-items: center; cursor: pointer; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cart-item-controls { display: flex; align-items: center; gap: 8px; }
        .cart-item-controls button { background: var(--neutral-200); border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-item-controls button:hover { background: var(--neutral-400); color: var(--neutral-0); }
        
        @media (min-width: 1200px) {
            .kasir-container { grid-template-columns: 2fr 1.2fr; height: calc(100vh - 40px); }
            .cart-container { display: flex !important; flex-direction: column; }
            #cart-summary-bar { display: none !important; }
        }
        
        /* Tabel Responsif */
        .table-wrapper { overflow-x: auto; }
        .responsive-table { width: 100%; border-collapse: collapse; }
        .responsive-table th, .responsive-table td { padding: 12px 15px; text-align: left; }
        .responsive-table thead { background-color: var(--neutral-50); }
        .responsive-table tbody tr { border-bottom: 1px solid var(--neutral-200); }
        .responsive-table tbody tr:last-of-type { border-bottom: none; }
        .responsive-table .actions { display: flex; gap: 5px; }
        .stock-badge { padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .stock-badge.low { background-color: var(--warning-100); color: var(--warning-700); }
        .stock-badge.out { background-color: var(--danger-100); color: var(--danger-700); }
        .stock-badge.ok { background-color: var(--success-100); color: var(--success-700); }
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; background: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid var(--neutral-100); padding: 10px 0; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 15px; }
        }

        /* Halaman Lainnya */
        .lainnya-menu { list-style: none; }
        .lainnya-menu-item a { display: flex; align-items: center; padding: 20px 15px; background-color: var(--neutral-0); border-bottom: 1px solid var(--neutral-200); text-decoration: none; color: var(--neutral-800); font-weight: 500; }
        .lainnya-menu-item a:hover { background-color: var(--neutral-50); }
        .lainnya-menu-item:first-child a { border-radius: 8px 8px 0 0; }
        .lainnya-menu-item:last-child a { border-bottom: none; border-radius: 0 0 8px 8px; }
        .lainnya-menu-item i { margin-right: 15px; color: var(--neutral-400); width: 24px; text-align: center; }

        /* === 5. DASHBOARD REVAMP === */
        /* NEW: Carousel Styles */
        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            margin-bottom: 20px;
            background-color: var(--primary-500); /* Fallback color */
        }
        .carousel-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-slide {
            min-width: 100%;
            position: relative;
        }
        .carousel-slide img {
            width: 100%;
            display: block;
            height: 250px; /* Adjust height as needed */
            object-fit: cover;
        }
        .carousel-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .carousel-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .carousel-dot.active {
            background-color: white;
        }
        /* END NEW */
        
        .dashboard-hero {
            background-color: var(--primary-500);
            color: var(--neutral-0);
            padding: 20px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg width='600' height='600' viewBox='0 0 600 600' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M360 0c-9.9 0-18 8.1-18 18s8.1 18 18 18h222v222c0 9.9 8.1 18 18 18s18-8.1 18-18V18c0-9.9-8.1-18-18-18H360zM240 600c9.9 0 18-8.1 18-18s-8.1-18-18-18H18V360c0-9.9-8.1-18-18-18s-18 8.1-18 18v222c0 9.9 8.1 18 18 18h222z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            margin-bottom: 20px;
        }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .dashboard-header .store-info { font-weight: 500; }
        .dashboard-header .store-info span { font-size: 14px; opacity: 0.8; display: block; }
        .hero-balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .hero-balance-card { background-color: rgba(255,255,255, 0.1); border: 1px solid rgba(255,255,255, 0.2); padding: 15px; border-radius: 12px; }
        .hero-balance-card h3 { font-size: 14px; font-weight: 500; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .hero-balance-card h3 i { font-size: 10px; }
        .hero-balance-card p { font-size: 22px; font-weight: 700; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 15px; text-align: center; }
        .action-button { display: flex; flex-direction: column; align-items: center; gap: 8px; color: var(--neutral-0); text-decoration: none; font-size: 12px; font-weight: 500; cursor: pointer; }
        .action-button-icon { width: 50px; height: 50px; background-color: var(--neutral-0); color: var(--primary-500); border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-size: 20px; box-shadow: var(--shadow-sm); }
        .dashboard-section-title { font-size: 14px; font-weight: 600; color: var(--neutral-600); margin-bottom: 15px; text-transform: uppercase; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 12px; padding: 15px; }
        .stat-card h4 { font-size: 14px; font-weight: 500; color: var(--neutral-600); margin-bottom: 8px; }
        .stat-card-value { display: flex; align-items: baseline; gap: 8px; }
        .stat-card-value p { font-size: 20px; font-weight: 700; }

        /* NEW: Styles for image previews */
        .image-preview-container { margin-bottom: 15px; }
        .image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid var(--neutral-200); object-fit: cover; }
        .banner-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .banner-preview-item { position: relative; }
        .banner-preview-item img { width: 100%; height: 60px; object-fit: cover; border-radius: 4px; }
        .banner-remove-btn { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: var(--danger-500); color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fa-solid fa-bolt"></i>
                <h2 id="store-name-sidebar"></h2>
            </div>
            <ul class="sidebar-menu"></ul>
        </nav>

        <main class="main-content">
            <div id="page-content"></div>
        </main>

        <nav class="bottom-nav"></nav>
        
        <div id="modal-container" class="modal"></div>
        <div id="toast-container"></div>
    </div>

<script>
// --- APLIKASI POS PROFESIONAL (SINGLE-FILE) ---
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        // === 1. STATE & INISIALISASI ===
        state: { 
            currentPage: 'dashboard', 
            currentUserRole: 'admin', 
            cart: [], 
            products: [], 
            customers: [], 
            transactions: [], 
            expenses: [], 
            stockHistory: [],
            settings: {},
            activeTransaction: {
                customerId: null,
                customerName: 'Pelanggan Umum'
            }
        },
        elements: {},
        carouselInterval: null, // NEW: To hold carousel timer
        
        init() {
            this.initData();
            this.injectBaseHTML();
            this.cacheDOMElements();
            this.applySettings();
            this.attachEventListeners();
            this.showPage(this.state.currentPage || 'dashboard');
        },

        initData() {
            // NEW: Added dashboardBanners to default settings
            const defaultSettings = { 
                namaToko: 'Kopi Pagi', pemilik: 'Budi Gunawan', alamatToko: 'Jl. Digital No. 1, Semarang', 
                pesanDiStruk: 'Terima kasih telah berbelanja!', teleponToko: '081234567890', lowStockThreshold: 10,
                dashboardBanners: [] 
            };
            try {
                this.state.settings = this.getFromLocalStorage('settings', defaultSettings);
                // Ensure dashboardBanners exists to prevent errors from old data
                if (!this.state.settings.dashboardBanners) {
                    this.state.settings.dashboardBanners = [];
                }
                this.state.products = this.getFromLocalStorage('products', [ 
                    { id: 1, name: 'Kopi Susu Gula Aren', category: 'Kopi', price: 18000, cost: 10000, stock: 50, imageUrl: null }, 
                    { id: 2, name: 'Croissant Coklat', category: 'Roti', price: 22000, cost: 12000, stock: 8, imageUrl: null },
                    { id: 3, name: 'Americano', category: 'Kopi', price: 15000, cost: 7000, stock: 0, imageUrl: null }, 
                ]);
                this.state.customers = this.getFromLocalStorage('customers', []);
                this.state.transactions = this.getFromLocalStorage('transactions', []);
                this.state.expenses = this.getFromLocalStorage('expenses', []);
                this.state.stockHistory = this.getFromLocalStorage('stockHistory', []);
                this.state.cart = this.getFromLocalStorage('cart', []);
                this.state.currentPage = this.getFromLocalStorage('currentPage', 'dashboard');
            } catch (e) {
                console.error("Gagal memuat data dari localStorage:", e);
                if (confirm("Data aplikasi tampaknya rusak. Apakah Anda ingin mereset ke pengaturan awal? Data yang ada akan hilang.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            this.saveAllData();
        },

        injectBaseHTML() {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-solid fa-store', label: 'Beranda', role: 'all' },
                { id: 'kasir', icon: 'fa-solid fa-cash-register', label: 'Kasir', role: 'all' },
                { id: 'produk', icon: 'fa-solid fa-box-open', label: 'Produk', role: 'admin' },
                { id: 'laporan', icon: 'fa-solid fa-chart-line', label: 'Laporan', role: 'admin' },
                { id: 'lainnya', icon: 'fa-solid fa-ellipsis', label: 'Lainnya', role: 'all', mobileOnly: true },
                { id: 'pelanggan', icon: 'fa-solid fa-users', label: 'Pelanggan', role: 'admin' },
                { id: 'biaya', icon: 'fa-solid fa-wallet', label: 'Biaya', role: 'admin' },
                { id: 'pengaturan', icon: 'fa-solid fa-gear', label: 'Pengaturan', role: 'admin' }
            ];
            
            const sidebarMenu = document.querySelector('.sidebar-menu');
            sidebarMenu.innerHTML = menuItems.filter(item => !item.mobileOnly).map(item => 
                `<li data-role="${item.role}"><a href="#" class="nav-link" data-page="${item.id}"><i class="${item.icon}"></i><span>${item.label}</span></a></li>`
            ).join('');
            
            const bottomNav = document.querySelector('.bottom-nav');
            bottomNav.innerHTML = menuItems.filter(item => ['dashboard', 'kasir', 'produk', 'lainnya'].includes(item.id)).map(item =>
                `<a href="#" class="bottom-nav-link nav-link" data-page="${item.id}" data-role="${item.role}"><i class="${item.icon}"></i><span>${item.label}</span></a>`
            ).join('');
        },

        cacheDOMElements() {
            this.elements = {
                pageContent: document.getElementById('page-content'), modalContainer: document.getElementById('modal-container'),
                toastContainer: document.getElementById('toast-container'), navLinks: document.querySelectorAll('.nav-link'),
                sidebarStoreName: document.getElementById('store-name-sidebar'),
            };
        },
        
        attachEventListeners() {
            this.elements.navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); this.showPage(e.currentTarget.dataset.page); }));
            
            document.body.addEventListener('click', e => {
                const navLink = e.target.closest('.nav-link-dynamic');
                if (navLink) { e.preventDefault(); this.showPage(navLink.dataset.page); }
                
                const actionEl = e.target.closest('[data-action]');
                if(actionEl) {
                    e.preventDefault();
                    this.handleAction(actionEl.dataset.action, actionEl.dataset.id || actionEl.dataset.value, actionEl);
                }
            });
            
            // NEW: Delegated listener for file inputs
            document.body.addEventListener('change', e => {
                const uploader = e.target.closest('[data-uploader]');
                if (uploader) {
                    this.handleUploader(uploader.dataset.uploader, uploader.files);
                }
            });

            document.addEventListener('keydown', e => { 
                if (e.key === 'Escape') this.closeModal(); 
                if (this.state.currentPage === 'kasir') {
                    if (e.key === 'F1') { e.preventDefault(); document.getElementById('kasir-search-input')?.focus(); }
                    if (e.key === 'F9' && this.state.cart.length > 0) { e.preventDefault(); this.openPaymentModal(); }
                }
            });
        },

        attachPageSpecificEventListeners(pageId) {
            // NEW: Clear carousel interval when leaving dashboard
            if (this.carouselInterval) {
                clearInterval(this.carouselInterval);
                this.carouselInterval = null;
            }

            switch(pageId) {
                case 'dashboard':
                    this.initCarousel(); // NEW
                    break;
                case 'kasir':
                    document.getElementById('kasir-search-input').addEventListener('input', e => this.renderProductGrid(e.target.value));
                    document.getElementById('product-grid').addEventListener('click', e => { 
                        const card = e.target.closest('.product-card:not(.out-of-stock)'); 
                        if (card) this.addToCart(parseInt(card.dataset.id)); 
                    });
                    document.getElementById('btn-bayar')?.addEventListener('click', () => this.openPaymentModal());
                    document.getElementById('cart-summary-bar')?.addEventListener('click', () => this.openPaymentModal());
                    this.renderProductGrid();
                    this.renderCart();
                    break;
                case 'produk':
                    document.getElementById('product-search').addEventListener('input', e => this.renderProductTable(e.target.value));
                    break;
                case 'pelanggan':
                    document.getElementById('customer-search').addEventListener('input', e => this.renderCustomerTable(e.target.value));
                    break;
                case 'biaya':
                    document.getElementById('expense-start').addEventListener('change', () => this.renderExpenseTable());
                    document.getElementById('expense-end').addEventListener('change', () => this.renderExpenseTable());
                    break;
                case 'laporan':
                    document.getElementById('generate-report-btn').addEventListener('click', () => this.generateReport());
                    this.generateReport(); // Generate initial report for today
                    break;
            }
        },
        
        handleAction(action, id, element) {
            const value = id;
            switch(action) {
                case 'showPage': this.showPage(value); break;
                // Modals
                case 'addProduct': this.showProductModal(); break;
                case 'editProduct': this.showProductModal(value); break;
                case 'deleteProduct': this.deleteProduct(value); break;
                case 'addCustomer': this.showCustomerModal(); break;
                case 'editCustomer': this.showCustomerModal(value); break;
                case 'deleteCustomer': this.deleteCustomer(value); break;
                case 'addExpense': this.showExpenseModal(); break;
                case 'editExpense': this.showExpenseModal(value); break;
                case 'deleteExpense': this.deleteExpense(value); break;
                case 'showCustomerSelection': this.showCustomerSelectionModal(); break;
                // Settings
                case 'saveSettings': this.saveSettings(); break;
                case 'exportData': this.exportData(); break;
                case 'resetTransactions': 
                    this.showConfirmModal('Reset Data Transaksi?', 'Semua data penjualan, biaya, dan riwayat pelanggan akan dihapus permanen. Data produk dan pengaturan akan tetap ada. Anda yakin?', () => this.resetTransactions());
                    break;
                // Cart Actions
                case 'updateCartQty':
                    this.updateCartQuantity(value, parseInt(element.dataset.change));
                    break;
                case 'removeFromCart':
                    this.updateCartQuantity(value, -Infinity);
                    break;
                // NEW: Banner Actions
                case 'removeBanner':
                    this.state.settings.dashboardBanners.splice(parseInt(id), 1);
                    this.saveAllData();
                    this.showPage('pengaturan'); // Rerender settings page
                    this.showToast('Banner berhasil dihapus.', 'success');
                    break;
            }
        },

        // === 2. UTILITIES ===
        saveAllData() { for (const key in this.state) { this.saveToLocalStorage(key, this.state[key]); } },
        getFromLocalStorage(key, defaultValue) { const data = localStorage.getItem(key); if (!data) return defaultValue; try { return JSON.parse(data); } catch { return defaultValue; } },
        saveToLocalStorage: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        formatRupiah: (number) => `Rp ${new Intl.NumberFormat('id-ID').format(number)}`,
        formatDate: (isoString) => new Date(isoString).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }),
        applySettings() { document.title = `${this.state.settings.namaToko} - POS`; if(this.elements.sidebarStoreName) this.elements.sidebarStoreName.textContent = this.state.settings.namaToko; },

        showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            this.elements.toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        },

        showModal(title, contentHTML, onConfirm, confirmText = 'Simpan', onConfirmShouldClose = true) {
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <div class="modal-header"><h2>${title}</h2><button class="close-modal">&times;</button></div>
                <form id="modal-form" novalidate>${contentHTML}</form>
                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn btn-secondary close-modal">Batal</button>
                    ${onConfirm ? `<button type="button" class="btn btn-primary" id="modal-confirm">${confirmText}</button>` : ''}
                </div>`;
            this.elements.modalContainer.innerHTML = '';
            this.elements.modalContainer.appendChild(modalContent);
            this.elements.modalContainer.style.display = 'flex';
            
            modalContent.querySelectorAll('.form-input').forEach(input => {
                if (input.value || input.type === 'date' || document.activeElement === input) { input.parentElement.classList.add('has-value'); }
            });

            const modalForm = document.getElementById('modal-form');
            if (onConfirm) {
                const confirmBtn = document.getElementById('modal-confirm');
                confirmBtn.addEventListener('click', () => { 
                    if (!modalForm.checkValidity()) {
                        modalForm.reportValidity();
                        this.showToast('Mohon isi semua kolom yang wajib diisi.', 'error');
                        return;
                    }
                    const result = onConfirm();
                    if(onConfirmShouldClose && result !== false) this.closeModal(); 
                });
                modalForm.addEventListener('submit', (e) => { e.preventDefault(); confirmBtn.click(); });
            }
            this.elements.modalContainer.querySelectorAll('.close-modal').forEach(el => el.addEventListener('click', () => this.closeModal()));
        },
        
        showConfirmModal(title, message, onConfirm) {
            this.showModal(title, `<p>${message}</p>`, () => { onConfirm(); return true; }, "Ya, Lanjutkan", true);
        },

        closeModal() { this.elements.modalContainer.style.display = 'none'; this.elements.modalContainer.innerHTML = ''; },

        // === 3. NAVIGASI & RENDER HALAMAN ===
        showPage(pageId) {
            if (!pageId) return;
            // Update active links
            this.elements.navLinks.forEach(l => l.classList.remove('active'));
            document.querySelectorAll(`.nav-link[data-page="${pageId}"]`).forEach(l => l.classList.add('active'));
            
            // Save state
            this.state.currentPage = pageId;
            this.saveToLocalStorage('currentPage', pageId);
            
            const pageRenderers = {
                dashboard: this.renderDashboard, kasir: this.renderKasir,
                produk: this.renderProduk, laporan: this.renderLaporan,
                lainnya: this.renderLainnya, pelanggan: this.renderPelanggan,
                biaya: this.renderBiaya, pengaturan: this.renderPengaturan,
            };
            
            const renderer = pageRenderers[pageId];

            if (renderer) {
                const pageHTML = renderer.call(this);
                this.elements.pageContent.innerHTML = pageHTML;
                this.attachPageSpecificEventListeners(pageId);
            } else {
                this.elements.pageContent.innerHTML = `<div class="page-container"><div class="card">Halaman "${pageId}" tidak ditemukan.</div></div>`;
            }
        },

        // === 4. FUNGSI RENDER PER MODUL (Return HTML String) ===
        
        renderDashboard() {
            const today = new Date().toISOString().slice(0, 10);
            const todayTrx = this.state.transactions.filter(t => t.date.startsWith(today));
            const revenueToday = todayTrx.reduce((sum, t) => sum + t.finalTotal, 0);
            
            let cogsToday = 0;
            todayTrx.forEach(t => { t.items.forEach(item => { cogsToday += (item.cost || 0) * item.quantity; }); });
            const expensesToday = this.state.expenses.filter(e => e.date === today).reduce((sum, e) => sum + e.amount, 0);
            const netProfitToday = revenueToday - cogsToday - expensesToday;

            const lowStockProducts = this.state.products.filter(p => p.stock > 0 && p.stock <= this.state.settings.lowStockThreshold);

            // NEW: Banner Carousel Logic
            const banners = this.state.settings.dashboardBanners || [];
            let heroHTML = '';
            if (banners.length > 0) {
                heroHTML = `
                <div id="dashboard-carousel" class="carousel-container">
                    <div class="carousel-track">
                        ${banners.map(bannerSrc => `
                            <div class="carousel-slide">
                                <img src="${bannerSrc}" alt="Dashboard Banner">
                            </div>
                        `).join('')}
                    </div>
                    <div class="carousel-dots">
                        ${banners.map((_, index) => `<div class="carousel-dot ${index === 0 ? 'active' : ''}" data-slide-to="${index}"></div>`).join('')}
                    </div>
                </div>`;
            } else {
                heroHTML = `<div class="dashboard-hero">...</div>`; // Fallback to old hero, content filled below
            }
            
            const fullDashboardHTML = `
            <div class="page-container">
                ${heroHTML}
                <div class="dashboard-section-title">Ringkasan Hari Ini</div>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 20px;">
                    <div class="stat-card"><h4>Pendapatan</h4><p class="stat-card-value">${this.formatRupiah(revenueToday)}</p></div>
                    <div class="stat-card"><h4>Laba Bersih</h4><p class="stat-card-value">${this.formatRupiah(netProfitToday)}</p></div>
                </div>

                <div class="dashboard-section-title">Aksi Cepat</div>
                <div class="card" style="padding:15px">
                    <div class="quick-actions-grid" style="color: var(--neutral-800);">
                        <a href="#" class="action-button nav-link-dynamic" data-page="kasir" style="color: inherit;">
                            <span class="action-button-icon" style="background-color: var(--neutral-100);"><i class="fa-solid fa-cash-register"></i></span> Transaksi
                        </a>
                        <a href="#" class="action-button" data-action="addProduct" style="color: inherit;">
                            <span class="action-button-icon" style="background-color: var(--neutral-100);"><i class="fa-solid fa-plus"></i></span> Produk
                        </a>
                        <a href="#" class="action-button" data-action="addExpense" style="color: inherit;">
                            <span class="action-button-icon" style="background-color: var(--neutral-100);"><i class="fa-solid fa-wallet"></i></span> Biaya
                        </a>
                        <a href="#" class="action-button nav-link-dynamic" data-page="laporan" style="color: inherit;">
                            <span class="action-button-icon" style="background-color: var(--neutral-100);"><i class="fa-solid fa-chart-line"></i></span> Laporan
                        </a>
                    </div>
                </div>

                <div class="dashboard-section-title">Stok Menipis</div>
                <div class="card" style="padding: 15px;">
                    ${lowStockProducts.length > 0 ? lowStockProducts.map(p => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--neutral-100);">
                            <span>${p.name}</span>
                            <span class="stock-badge low">Sisa ${p.stock}</span>
                        </div>`).join('') : '<p style="color:var(--neutral-400); text-align:center; padding: 10px;">Semua stok aman.</p>'
                    }
                </div>
            </div>`;
            
            // If no banners, inject the old hero content into the placeholder
            return banners.length > 0 ? fullDashboardHTML : fullDashboardHTML.replace('<div class="dashboard-hero">...</div>', `
                <div class="dashboard-hero">
                    <div class="dashboard-header">
                        <div class="store-info">
                            <span>Selamat Datang, ${this.state.settings.pemilik.split(' ')[0]}</span>
                            <strong>${this.state.settings.namaToko}</strong>
                        </div>
                    </div>
                </div>`);
        },
        
        renderKasir() {
            return `
            <div class="kasir-container page-container">
                <div class="card product-section" style="padding: 15px; display:flex; flex-direction:column;">
                    <div style="margin-bottom:15px;"><input type="text" id="kasir-search-input" class="form-input" placeholder="Cari produk (F1)..."></div>
                    <div id="product-grid" class="product-grid" style="flex-grow:1;"></div>
                </div>
                <div id="cart-container" class="card cart-container" style="display:none;">
                    <h3 style="margin-bottom:15px;">Keranjang</h3>
                    <div id="cart-items" style="flex-grow:1; overflow-y:auto; padding-right:10px;"></div>
                    <div id="cart-total" style="margin-top:auto; padding-top:15px; border-top:1px solid var(--neutral-200);"></div>
                    <button id="btn-bayar" class="btn btn-primary" style="width:100%; margin-top:15px;" disabled>Bayar (F9)</button>
                </div>
            </div>
            <div id="cart-summary-bar"></div>`;
        },
        
        renderProductGrid(searchTerm = '') {
            const grid = document.getElementById('product-grid');
            if(!grid) return;
            const term = searchTerm.toLowerCase();
            const filteredProducts = this.state.products.filter(p => p.name.toLowerCase().includes(term));
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = `<p style="color: var(--neutral-400); text-align:center; width:100%;">Produk tidak ditemukan.</p>`; return;
            }
            
            // NEW: Updated to show image or placeholder
            grid.innerHTML = filteredProducts.map(p => {
                const imageHTML = p.imageUrl 
                    ? `<img src="${p.imageUrl}" alt="${p.name}">`
                    : `<div class="product-card-placeholder">${p.name.charAt(0)}</div>`;

                return `
                <div class="product-card ${p.stock <= 0 ? 'out-of-stock' : ''}" data-id="${p.id}">
                    <div class="product-card-stock">Stok: ${p.stock}</div>
                    ${imageHTML}
                    <div class="product-card-info">
                        <h4>${p.name}</h4>
                        <p>${this.formatRupiah(p.price)}</p>
                    </div>
                </div>`;
            }).join('');
        },

        renderProduk() {
            return `
            <div class="page-container">
                <header class="header"><h1>Manajemen Produk</h1></header>
                <div class="page-header">
                    <input type="text" id="product-search" class="form-input" placeholder="Cari produk..." style="max-width:300px;">
                    <button class="btn btn-primary" data-action="addProduct"><i class="fa-solid fa-plus"></i> Tambah Produk</button>
                </div>
                <div class="card" style="padding:0;"><div class="table-wrapper" id="product-table-container">${this.renderProductTable()}</div></div>
            </div>`;
        },

        renderProductTable(filter = '') {
            const filtered = this.state.products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
            let tableHTML = `<table class="responsive-table"><thead><tr><th>Nama Produk</th><th>Kategori</th><th>Harga Jual</th><th>Stok</th><th>Aksi</th></tr></thead><tbody>`;
            if (filtered.length > 0) {
                filtered.forEach(p => {
                    let stockBadge = `<span class="stock-badge ok">${p.stock}</span>`;
                    if (p.stock <= 0) stockBadge = `<span class="stock-badge out">Habis</span>`;
                    else if (p.stock <= this.state.settings.lowStockThreshold) stockBadge = `<span class="stock-badge low">${p.stock}</span>`;

                    tableHTML += `
                        <tr>
                            <td data-label="Nama">${p.name}</td> <td data-label="Kategori">${p.category}</td>
                            <td data-label="Harga Jual">${this.formatRupiah(p.price)}</td> <td data-label="Stok">${stockBadge}</td>
                            <td data-label="Aksi">
                                <div class="actions">
                                    <button class="btn btn-text" data-action="editProduct" data-id="${p.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                                    <button class="btn btn-text" data-action="deleteProduct" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                });
            } else { tableHTML += `<tr><td colspan="5" style="text-align:center;">Belum ada data produk.</td></tr>`; }
            tableHTML += `</tbody></table>`;
            
            const container = document.getElementById('product-table-container');
            if (container) { container.innerHTML = tableHTML; }
            else { return tableHTML; }
        },
        
        renderPengaturan() {
            const { settings } = this.state;
            // NEW: Banner management HTML
            const bannersHTML = (settings.dashboardBanners || []).map((bannerSrc, index) => `
                <div class="banner-preview-item">
                    <img src="${bannerSrc}" alt="Banner ${index + 1}">
                    <button class="banner-remove-btn" data-action="removeBanner" data-id="${index}">&times;</button>
                </div>
            `).join('');

            return `
            <div class="page-container">
                <header class="header"><h1>Pengaturan</h1></header>
                <div style="max-width: 700px; margin: 0 auto;">
                    <div class="card">
                        <h3 style="margin-bottom:20px;">Informasi Toko</h3>
                        <div class="form-group"><input type="text" id="s-namaToko" class="form-input" value="${settings.namaToko}" required placeholder=" "><label class="form-label">Nama Toko</label></div>
                        <div class="form-group"><input type="text" id="s-pemilik" class="form-input" value="${settings.pemilik}" placeholder=" "><label class="form-label">Nama Pemilik</label></div>
                        <div class="form-group"><input type="text" id="s-teleponToko" class="form-input" value="${settings.teleponToko}" placeholder=" "><label class="form-label">Telepon Toko</label></div>
                        <div class="form-group"><input type="text" id="s-alamatToko" class="form-input" value="${settings.alamatToko}" placeholder=" "><label class="form-label">Alamat Toko</label></div>
                        <div class="form-group"><textarea id="s-pesanDiStruk" class="form-input" placeholder=" " style="min-height:80px;">${settings.pesanDiStruk}</textarea><label class="form-label">Pesan di Struk</label></div>
                        <div class="form-group"><input type="number" id="s-lowStockThreshold" class="form-input" value="${settings.lowStockThreshold}" placeholder=" " min="0"><label class="form-label">Ambang Batas Stok Rendah</label></div>
                        <div style="text-align:right;"><button class="btn btn-primary" data-action="saveSettings">Simpan Pengaturan</button></div>
                    </div>

                    <div class="card">
                        <h3 style="margin-bottom:20px;">Manajemen Banner Dashboard</h3>
                        <p style="font-size: 14px; color: var(--neutral-600); margin-bottom: 15px;">
                            Unggah hingga 5 gambar untuk ditampilkan di beranda. Gunakan gambar yang sudah dioptimasi untuk performa terbaik.
                        </p>
                        <input type="file" id="banner-uploader" data-uploader="dashboardBanners" accept="image/*" multiple style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('banner-uploader').click();" ${ (settings.dashboardBanners || []).length >= 5 ? 'disabled' : '' }>
                            <i class="fa-solid fa-upload"></i> Unggah Banner
                        </button>
                        <div class="banner-preview-grid" id="banner-preview-container">
                            ${bannersHTML}
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="margin-bottom:20px;">Manajemen Data</h3>
                        <div style="display:flex; flex-direction:column; gap:15px;">
                            <button class="btn btn-secondary" data-action="exportData"><i class="fa-solid fa-file-export"></i> Ekspor Semua Data (JSON)</button>
                            <button class="btn btn-danger" data-action="resetTransactions"><i class="fa-solid fa-triangle-exclamation"></i> Reset Data Transaksi</button>
                        </div>
                    </div>
                </div>
            </div>`;
        },

        // --- All other render functions (pelanggan, biaya, laporan, lainnya) are unchanged ---
        renderPelanggan() { /*UNCHANGED*/ return `<div class="page-container"><header class="header"><h1>Pelanggan</h1></header><div class="page-header"><input type="text" id="customer-search" class="form-input" placeholder="Cari pelanggan..." style="max-width:300px;"><button class="btn btn-primary" data-action="addCustomer"><i class="fa-solid fa-plus"></i> Tambah</button></div><div class="card" style="padding:0;"><div class="table-wrapper" id="customer-table-container">${this.renderCustomerTable()}</div></div></div>`; },
        renderCustomerTable(filter = '') { /*UNCHANGED*/ const filtered = this.state.customers.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()) || c.phone.includes(filter)); let tableHTML = `<table class="responsive-table"><thead><tr><th>Nama</th><th>Telepon</th><th>Total Belanja</th><th>Kunjungan</th><th>Aksi</th></tr></thead><tbody>`; if (filtered.length > 0) { filtered.forEach(c => { tableHTML += `<tr><td data-label="Nama">${c.name}</td><td data-label="Telepon">${c.phone}</td><td data-label="Total Belanja">${this.formatRupiah(c.totalSpent || 0)}</td><td data-label="Kunjungan">${c.visitCount || 0}</td><td data-label="Aksi"><div class="actions"><button class="btn btn-text" data-action="editCustomer" data-id="${c.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn btn-text" data-action="deleteCustomer" data-id="${c.id}"><i class="fa-solid fa-trash"></i></button></div></td></tr>`; }); } else { tableHTML += `<tr><td colspan="5" style="text-align:center;">Belum ada data pelanggan.</td></tr>`; } tableHTML += `</tbody></table>`; const container = document.getElementById('customer-table-container'); if (container) { container.innerHTML = tableHTML; } else { return tableHTML; } },
        renderBiaya() { /*UNCHANGED*/ const today = new Date().toISOString().slice(0, 10); return `<div class="page-container"><header class="header"><h1>Biaya Operasional</h1></header><div class="page-header"><div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;"><div class="form-group" style="margin-bottom:0;"><input type="date" id="expense-start" class="form-input" value="${today}"><label class="form-label">Mulai</label></div><div class="form-group" style="margin-bottom:0;"><input type="date" id="expense-end" class="form-input" value="${today}"><label class="form-label">Selesai</label></div></div><button class="btn btn-primary" data-action="addExpense"><i class="fa-solid fa-plus"></i> Tambah</button></div><div class="card" style="padding:0;"><div class="table-wrapper" id="expense-table-container">${this.renderExpenseTable()}</div></div></div>`; },
        renderExpenseTable() { /*UNCHANGED*/ const startEl = document.getElementById('expense-start'); const endEl = document.getElementById('expense-end'); let filtered = this.state.expenses; if(startEl && endEl && startEl.value && endEl.value) { const start = new Date(startEl.value); start.setHours(0,0,0,0); const end = new Date(endEl.value); end.setHours(23,59,59,999); filtered = this.state.expenses.filter(e => { const d = new Date(e.date); return d >= start && d <= end; }); } let tableHTML = `<table class="responsive-table"><thead><tr><th>Tanggal</th><th>Deskripsi</th><th>Kategori</th><th>Jumlah</th><th>Aksi</th></tr></thead><tbody>`; if(filtered.length > 0) { filtered.forEach(e => { tableHTML += `<tr><td data-label="Tanggal">${this.formatDate(e.date)}</td><td data-label="Deskripsi">${e.description}</td><td data-label="Kategori">${e.category}</td><td data-label="Jumlah">${this.formatRupiah(e.amount)}</td><td data-label="Aksi"><div class="actions"><button class="btn btn-text" data-action="editExpense" data-id="${e.id}"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn btn-text" data-action="deleteExpense" data-id="${e.id}"><i class="fa-solid fa-trash"></i></button></div></td></tr>`; }); } else { tableHTML += `<tr><td colspan="5" style="text-align:center;">Tidak ada biaya pada periode ini.</td></tr>`; } tableHTML += `</tbody></table>`; const container = document.getElementById('expense-table-container'); if (container) { container.innerHTML = tableHTML; }  else { return tableHTML; } },
        renderLaporan() { /*UNCHANGED*/ const today = new Date().toISOString().slice(0, 10); return `<div class="page-container"><header class="header"><h1>Laporan Penjualan</h1></header><div class="card"><div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center; justify-content:space-between;"><div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;"><div class="form-group" style="margin-bottom:0;"><input type="date" id="report-start" class="form-input" value="${today}"><label class="form-label">Mulai</label></div><div class="form-group" style="margin-bottom:0;"><input type="date" id="report-end" class="form-input" value="${today}"><label class="form-label">Selesai</label></div></div><button id="generate-report-btn" class="btn btn-primary"><i class="fa-solid fa-arrows-rotate"></i> Buat Laporan</button></div></div><div id="report-results"></div></div>`; },
        renderLainnya() { /*UNCHANGED*/ return `<div class="page-container"><header class="header"><h1>Menu Lainnya</h1></header><ul class="lainnya-menu"><li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="laporan"><i class="fa-solid fa-chart-line"></i>Laporan</a></li><li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="pelanggan"><i class="fa-solid fa-users"></i>Pelanggan</a></li><li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="biaya"><i class="fa-solid fa-wallet"></i>Biaya</a></li><li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="pengaturan"><i class="fa-solid fa-gear"></i>Pengaturan</a></li></ul></div>`; },
        
        // --- Remaining functions from previous version, with modifications for images ---
        // NEW: Function to handle file uploads
        handleUploader(type, files) {
            if (!files || files.length === 0) return;
            const promises = [];
            const filesArray = Array.from(files);

            if (type === 'dashboardBanners') {
                const currentCount = (this.state.settings.dashboardBanners || []).length;
                if (filesArray.length + currentCount > 5) {
                    this.showToast(`Anda hanya bisa menambahkan ${5 - currentCount} banner lagi.`, 'error');
                    return;
                }
            }

            for (const file of filesArray) {
                promises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                }));
            }

            Promise.all(promises).then(base64results => {
                if (type === 'productImage') {
                    const preview = document.getElementById('p-image-preview');
                    const hiddenInput = document.getElementById('p-image-base64');
                    preview.src = base64results[0];
                    hiddenInput.value = base64results[0];
                    preview.style.display = 'block';
                } else if (type === 'dashboardBanners') {
                    this.state.settings.dashboardBanners.push(...base64results);
                    this.saveAllData();
                    this.showPage('pengaturan'); // Rerender to show new banners
                    this.showToast(`${base64results.length} banner berhasil ditambahkan.`, 'success');
                }
            }).catch(error => {
                console.error("Error reading file:", error);
                this.showToast('Gagal memproses gambar.', 'error');
            });
        },

        // NEW: Function to initialize and control the carousel
        initCarousel() {
            const carousel = document.getElementById('dashboard-carousel');
            if (!carousel) return;
            const track = carousel.querySelector('.carousel-track');
            const slides = Array.from(track.children);
            const dots = Array.from(carousel.querySelectorAll('.carousel-dot'));
            if (slides.length <= 1) return;

            let currentIndex = 0;

            const goToSlide = (index) => {
                track.style.transform = `translateX(-${index * 100}%)`;
                dots.forEach(dot => dot.classList.remove('active'));
                dots[index].classList.add('active');
                currentIndex = index;
            };

            dots.forEach(dot => {
                dot.addEventListener('click', e => {
                    const targetIndex = parseInt(e.target.dataset.slideTo);
                    goToSlide(targetIndex);
                    // Reset interval on manual navigation
                    clearInterval(this.carouselInterval);
                    this.carouselInterval = setInterval(autoSlide, 5000);
                });
            });

            const autoSlide = () => {
                const nextIndex = (currentIndex + 1) % slides.length;
                goToSlide(nextIndex);
            };

            this.carouselInterval = setInterval(autoSlide, 5000);
        },

        showProductModal(productId) {
            const isEdit = productId !== undefined;
            const product = isEdit ? this.state.products.find(p => p.id == productId) : {};
            const title = isEdit ? 'Edit Produk' : 'Tambah Produk';
            const history = isEdit ? this.state.stockHistory.filter(h => h.productId == productId) : [];
            // NEW: Added image uploader section
            const content = `
                <div class="form-group"><input type="text" id="p-name" class="form-input" placeholder=" " value="${product.name || ''}" required><label class="form-label">Nama Produk</label></div>
                
                <div class="form-group">
                    <label style="font-size: 14px; color: var(--neutral-600);">Foto Produk (Opsional)</label>
                    <div class="image-preview-container">
                        <img id="p-image-preview" src="${product.imageUrl || ''}" class="image-preview" style="display: ${product.imageUrl ? 'block' : 'none'};">
                    </div>
                    <input type="file" id="p-image-uploader" data-uploader="productImage" accept="image/*" style="display:none;">
                    <input type="hidden" id="p-image-base64" value="${product.imageUrl || ''}">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('p-image-uploader').click();">Pilih Gambar</button>
                </div>
                <div class="form-group"><input type="text" id="p-category" class="form-input" placeholder=" " value="${product.category || ''}" required><label class="form-label">Kategori</label></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group"><input type="number" id="p-price" class="form-input" placeholder=" " value="${product.price || ''}" required min="0"><label class="form-label">Harga Jual</label></div>
                    <div class="form-group"><input type="number" id="p-cost" class="form-input" placeholder=" " value="${product.cost || ''}" required min="0"><label class="form-label">Harga Modal</label></div>
                </div>
                <div class="form-group"><input type="number" id="p-stock" class="form-input" placeholder=" " value="${product.stock !== undefined ? product.stock : 0}" required min="0" ${isEdit ? 'disabled' : ''}><label class="form-label">${isEdit ? 'Stok Saat Ini' : 'Stok Awal'}</label></div>
                ${isEdit ? `
                <hr style="margin:20px 0;"><h4 style="margin-bottom:15px;">Manajemen Stok</h4>
                <div style="display:grid; grid-template-columns: 1fr auto; gap:15px; align-items:flex-start;">
                    <div class="form-group" style="margin-bottom:0;"><input type="number" id="p-stock-change" class="form-input" placeholder=" " min="1"><label class="form-label">Jumlah</label></div>
                    <div style="display:flex; gap: 8px; margin-top:5px;">
                        <button type="button" class="btn btn-secondary" id="add-stock-btn"><i class="fa-solid fa-plus"></i></button>
                        <button type="button" class="btn btn-secondary" id="reduce-stock-btn"><i class="fa-solid fa-minus"></i></button>
                    </div>
                </div>
                <div class="form-group"><input type="text" id="p-stock-reason" class="form-input" placeholder=" "><label class="form-label">Alasan (Opsional)</label></div>
                <h4 style="margin-bottom:15px; margin-top:20px;">Riwayat Stok</h4>
                <div class="table-wrapper" style="max-height:150px; overflow-y:auto;">
                 <table class="responsive-table">
                    <thead><tr><th>Tanggal</th><th>Perubahan</th><th>Alasan</th><th>Stok</th></tr></thead>
                    <tbody>
                    ${history.length > 0 ? history.map(h => `<tr><td data-label="Tanggal"><small>${this.formatDate(h.date)}</small></td><td data-label="Perubahan" style="color:${h.change > 0 ? 'var(--success-500)' : 'var(--danger-500)'};">${h.change > 0 ? '+' : ''}${h.change}</td><td data-label="Alasan">${h.reason}</td><td data-label="Stok">${h.from} &rarr; ${h.to}</td></tr>`).join('') : '<tr><td colspan="4" style="text-align:center;">Belum ada riwayat.</td></tr>'}
                    </tbody>
                 </table>
                </div>` : ''}
            `;
            this.showModal(title, content, () => this.saveProduct(productId), 'Simpan Informasi', false);

            if(isEdit) {
                const stockChangeHandler = (multiplier) => {
                    const changeInput = document.getElementById('p-stock-change'); const reasonInput = document.getElementById('p-stock-reason');
                    const change = parseInt(changeInput.value); if(isNaN(change) || change <= 0) { this.showToast('Masukkan jumlah yang valid.', 'error'); return; }
                    const actualChange = change * multiplier; if(product.stock + actualChange < 0) { this.showToast('Stok tidak boleh kurang dari nol.', 'error'); return; }
                    const oldStock = product.stock; product.stock += actualChange; this.addStockLog(product.id, actualChange, oldStock, product.stock, reasonInput.value || 'Penyesuaian Stok');
                    this.saveAllData(); this.closeModal(); this.showPage('produk'); this.showToast(`Stok berhasil ${actualChange > 0 ? 'ditambah' : 'dikurangi'}.`);
                };
                document.getElementById('add-stock-btn').addEventListener('click', () => stockChangeHandler(1));
                document.getElementById('reduce-stock-btn').addEventListener('click', () => stockChangeHandler(-1));
            }
        },
        saveProduct(productId) {
            const name = document.getElementById('p-name').value.trim();
            const price = parseFloat(document.getElementById('p-price').value);
            const cost = parseFloat(document.getElementById('p-cost').value);
            const stock = parseInt(document.getElementById('p-stock').value);
            // NEW: Get image data
            const imageUrl = document.getElementById('p-image-base64').value || null;

            if (!name || isNaN(price) || isNaN(cost) || price < 0 || cost < 0) return false;
            
            const productData = { name, category: document.getElementById('p-category').value.trim(), price, cost, imageUrl };

            if(productId) {
                const index = this.state.products.findIndex(p => p.id == productId);
                this.state.products[index] = { ...this.state.products[index], ...productData };
            } else {
                if(isNaN(stock) || stock < 0) return false;
                productData.stock = stock;
                productData.id = Date.now();
                this.state.products.push(productData);
                this.addStockLog(productData.id, stock, 0, stock, 'Stok Awal');
            }
            this.saveAllData(); this.showPage('produk');
            this.showToast(`Produk berhasil ${productId ? 'diperbarui' : 'ditambahkan'}.`);
            return true;
        },

        // --- All other functions (deleteProduct, modals, processPayment, cart, etc.) are unchanged ---
        // ... (The rest of the JS code is identical to your original provided script, no changes needed for them) ...
        addToCart(productId) { /*UNCHANGED*/ const product = this.state.products.find(p => p.id === productId); if (!product || product.stock <= 0) return; const cartItem = this.state.cart.find(item => item.id === productId); if (cartItem) { if(cartItem.quantity < product.stock) { cartItem.quantity++; } else { this.showToast(`Stok ${product.name} tidak mencukupi.`, 'warning'); } } else { this.state.cart.push({ ...product, quantity: 1 }); } this.saveToLocalStorage('cart', this.state.cart); this.renderCart(); },
        updateCartQuantity(productId, change) { /*UNCHANGED*/ const cartItem = this.state.cart.find(item => item.id == productId); if (!cartItem) return; if (change === -Infinity || (cartItem.quantity + change <= 0)) { this.state.cart = this.state.cart.filter(item => item.id != productId); } else { const product = this.state.products.find(p => p.id == productId); const newQuantity = cartItem.quantity + change; if (newQuantity > product.stock) { this.showToast(`Stok ${product.name} tidak mencukupi.`, 'warning'); return; } cartItem.quantity = newQuantity; } this.saveToLocalStorage('cart', this.state.cart); this.renderCart(); },
        renderCart() { /*UNCHANGED*/ const container = document.getElementById('cart-items'); if(!container) return; const subtotal = this.state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0); container.innerHTML = this.state.cart.length ? this.state.cart.map(item => `<div style="display:flex; justify-content:space-between; align-items:center; padding: 10px 0; border-bottom: 1px solid var(--neutral-100);"><div><strong style="display:block; margin-bottom: 4px; font-size: 14px;">${item.name}</strong><div class="cart-item-controls"><button data-action="updateCartQty" data-id="${item.id}" data-change="-1">-</button><span>${item.quantity}</span><button data-action="updateCartQty" data-id="${item.id}" data-change="1">+</button><button data-action="removeFromCart" data-id="${item.id}" style="margin-left:10px; color: var(--danger-500); background: transparent;"><i class="fa-solid fa-trash"></i></button></div></div><div style="font-weight: 500;">${this.formatRupiah(item.price * item.quantity)}</div></div>`).join('') : `<p style="color: var(--neutral-400); text-align:center; padding: 20px 0;">Keranjang kosong</p>`; document.getElementById('cart-total').innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;"><span>Pelanggan:</span><button class="btn btn-text" data-action="showCustomerSelection" style="padding: 4px 8px;"><strong>${this.state.activeTransaction.customerName}</strong> &nbsp;<i class="fa-solid fa-pen-to-square fa-xs"></i></button></div><div style="display:flex; justify-content:space-between; align-items:center; font-size: 1.2em;"><strong>Total:</strong> <strong>${this.formatRupiah(subtotal)}</strong></div>`; document.getElementById('btn-bayar').disabled = this.state.cart.length === 0; const summaryBar = document.getElementById('cart-summary-bar'); if (summaryBar) { if(this.state.cart.length > 0) { summaryBar.style.display = 'flex'; summaryBar.innerHTML = `<span>${this.state.cart.reduce((t,i) => t+i.quantity, 0)} item (${this.formatRupiah(subtotal)})</span><strong>Lihat Keranjang & Bayar &nbsp; &rsaquo;</strong>`; } else { summaryBar.style.display = 'none'; } } },
        openPaymentModal() { /*UNCHANGED*/ if (this.state.cart.length === 0) return; const total = this.state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0); const content = `<div style="text-align:center; margin-bottom:20px;"><span style="font-size: 14px; color: var(--neutral-600);">Total Tagihan</span><h3 style="font-size: 32px; color: var(--primary-500);">${this.formatRupiah(total)}</h3></div><div class="form-group"><input type="number" id="p-paid" class="form-input" placeholder=" " required min="${total}"><label class="form-label">Jumlah Dibayar</label></div> <div style="text-align:center; margin-top: -15px;"><span style="font-size: 14px; color: var(--neutral-600);">Kembalian</span><h3 id="payment-change" style="font-size: 24px;">${this.formatRupiah(0)}</h3></div><hr style="margin: 20px 0;"><div style="display:flex; justify-content:space-between; align-items:center;"><span>Pelanggan: <strong>${this.state.activeTransaction.customerName}</strong></span><button type="button" class="btn btn-secondary" data-action="showCustomerSelection">Ganti</button></div>`; this.showModal('Pembayaran', content, () => this.processPayment(), 'Proses Pembayaran'); const paidInput = document.getElementById('p-paid'); const changeEl = document.getElementById('payment-change'); paidInput.addEventListener('input', () => { const paidAmount = parseFloat(paidInput.value) || 0; const change = paidAmount - total; changeEl.textContent = this.formatRupiah(change >= 0 ? change : 0); }); },
        showCustomerSelectionModal(){ /*UNCHANGED*/ const customersHTML = this.state.customers.map(c => `<div class="customer-list-item" data-id="${c.id}" data-name="${c.name}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--neutral-100); cursor:pointer;">${c.name} <small>${c.phone}</small></div>`).join(''); const content = `<input type="text" id="customer-select-search" class="form-input" placeholder="Cari pelanggan..." style="margin-bottom: 15px;"><div id="customer-list-container" style="max-height: 250px; overflow-y: auto;"><div class="customer-list-item" data-id="null" data-name="Pelanggan Umum" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--neutral-100); cursor:pointer;"><strong>Pelanggan Umum</strong></div>${customersHTML}</div>`; this.showModal('Pilih Pelanggan', content, null); const container = document.getElementById('modal-container'); container.onclick = e => { const item = e.target.closest('.customer-list-item'); if(item) { this.state.activeTransaction.customerId = item.dataset.id === 'null' ? null : item.dataset.id; this.state.activeTransaction.customerName = item.dataset.name; this.closeModal(); if(this.state.currentPage === 'kasir') this.renderCart(); } }; document.getElementById('customer-select-search').addEventListener('input', e => { const term = e.target.value.toLowerCase(); document.querySelectorAll('.customer-list-item').forEach(item => { item.style.display = item.dataset.name.toLowerCase().includes(term) ? 'flex' : 'none'; }); }); },
        processPayment() { /*UNCHANGED*/ const subtotal = this.state.cart.reduce((s,i)=>s+(i.price*i.quantity),0); const paidInput = document.getElementById('p-paid'); if (!paidInput.value) { this.showToast('Masukkan jumlah uang dibayar!', 'error'); return false; } const paidAmount = parseFloat(paidInput.value); if(isNaN(paidAmount) || paidAmount < subtotal) { this.showToast('Jumlah bayar tidak cukup!', 'error'); return false; } this.state.cart.forEach(cartItem => { const product = this.state.products.find(p => p.id === cartItem.id); if(product) { const oldStock = product.stock; product.stock -= cartItem.quantity; this.addStockLog(product.id, -cartItem.quantity, oldStock, product.stock, 'Penjualan'); } }); const newTransaction = { id: 'TRX-' + Date.now(), date: new Date().toISOString(), items: this.state.cart, finalTotal: subtotal, customerId: this.state.activeTransaction.customerId, customerName: this.state.activeTransaction.customerName }; this.state.transactions.unshift(newTransaction); if(this.state.activeTransaction.customerId) { const customer = this.state.customers.find(c => c.id === this.state.activeTransaction.customerId); if(customer){ customer.totalSpent = (customer.totalSpent || 0) + subtotal; customer.visitCount = (customer.visitCount || 0) + 1; } } this.state.cart = []; this.state.activeTransaction = { customerId: null, customerName: 'Pelanggan Umum' }; this.saveAllData(); this.showToast('Transaksi berhasil!'); if(this.state.currentPage === 'kasir') this.showPage('kasir'); return true; },
        addStockLog(productId, change, from, to, reason) { /*UNCHANGED*/ this.state.stockHistory.unshift({ id: 'STK-' + Date.now(), productId, date: new Date().toISOString(), change, from, to, reason }); },
        deleteProduct(productId) { /*UNCHANGED*/ this.showConfirmModal('Hapus Produk?', 'Anda yakin ingin menghapus produk ini?', () => { this.state.products = this.state.products.filter(p => p.id != productId); this.saveAllData(); this.showPage('produk'); this.showToast('Produk berhasil dihapus.'); }); },
        showCustomerModal(customerId) { /*UNCHANGED*/ const isEdit = customerId !== undefined; const customer = isEdit ? this.state.customers.find(c => c.id === customerId) : {}; const title = isEdit ? 'Edit Pelanggan' : 'Tambah Pelanggan'; const content = `<div class="form-group"><input type="text" id="c-name" class="form-input" placeholder=" " value="${customer.name || ''}" required><label class="form-label">Nama Lengkap</label></div><div class="form-group"><input type="tel" id="c-phone" class="form-input" placeholder=" " value="${customer.phone || ''}" required><label class="form-label">Nomor Telepon</label></div><div class="form-group"><input type="email" id="c-email" class="form-input" placeholder=" " value="${customer.email || ''}"><label class="form-label">Email (Opsional)</label></div>`; this.showModal(title, content, () => this.saveCustomer(customerId)); },
        saveCustomer(customerId) { /*UNCHANGED*/ const name = document.getElementById('c-name').value.trim(); const phone = document.getElementById('c-phone').value.trim(); if (!name || !phone) { return false; } const customerData = { name, phone, email: document.getElementById('c-email').value.trim() }; if(customerId) { const index = this.state.customers.findIndex(c => c.id === customerId); this.state.customers[index] = { ...this.state.customers[index], ...customerData }; } else { this.state.customers.push({ id: 'CUST-' + Date.now(), ...customerData, joinDate: new Date().toISOString(), totalSpent: 0, visitCount: 0 }); } this.saveAllData(); this.showPage('pelanggan'); this.showToast(`Pelanggan berhasil ${customerId ? 'diperbarui' : 'ditambahkan'}.`); return true; },
        deleteCustomer(customerId) { /*UNCHANGED*/ this.showConfirmModal('Hapus Pelanggan?', 'Anda yakin ingin menghapus pelanggan ini?', () => { this.state.customers = this.state.customers.filter(c => c.id !== customerId); this.saveAllData(); this.showPage('pelanggan'); this.showToast('Pelanggan berhasil dihapus.'); }); },
        showExpenseModal(expenseId) { /*UNCHANGED*/ const isEdit = expenseId !== undefined; const expense = isEdit ? this.state.expenses.find(e => e.id === expenseId) : {}; const title = isEdit ? 'Edit Biaya' : 'Tambah Biaya'; const content = `<div class="form-group"><input type="date" id="e-date" class="form-input" value="${expense.date || new Date().toISOString().slice(0, 10)}" required><label class="form-label">Tanggal</label></div><div class="form-group"><input type="text" id="e-desc" class="form-input" placeholder=" " value="${expense.description || ''}" required><label class="form-label">Deskripsi</label></div><div class="form-group"><input type="text" id="e-cat" class="form-input" placeholder=" " value="${expense.category || ''}" required><label class="form-label">Kategori</label></div><div class="form-group"><input type="number" id="e-amount" class="form-input" placeholder=" " value="${expense.amount || ''}" required min="1"><label class="form-label">Jumlah</label></div>`; this.showModal(title, content, () => this.saveExpense(expenseId)); },
        saveExpense(expenseId) { /*UNCHANGED*/ const description = document.getElementById('e-desc').value.trim(); const amount = parseFloat(document.getElementById('e-amount').value); if (!description || isNaN(amount) || amount <= 0) { return false; } const expenseData = { date: document.getElementById('e-date').value, description, category: document.getElementById('e-cat').value, amount }; if(expenseId) { const index = this.state.expenses.findIndex(e => e.id === expenseId); this.state.expenses[index] = { ...this.state.expenses[index], ...expenseData }; } else { this.state.expenses.push({ id: 'EXP-' + Date.now(), ...expenseData }); } this.state.expenses.sort((a,b) => new Date(b.date) - new Date(a.date)); this.saveAllData(); this.showPage('biaya'); this.showToast(`Biaya berhasil ${expenseId ? 'diperbarui' : 'dicatat'}.`); return true; },
        deleteExpense(expenseId) { /*UNCHANGED*/ this.showConfirmModal('Hapus Biaya?', 'Anda yakin ingin menghapus catatan biaya ini?', () => { this.state.expenses = this.state.expenses.filter(e => e.id !== expenseId); this.saveAllData(); this.showPage('biaya'); this.showToast('Biaya berhasil dihapus.'); }); },
        saveSettings() { /*UNCHANGED*/ this.state.settings.namaToko = document.getElementById('s-namaToko').value; this.state.settings.pemilik = document.getElementById('s-pemilik').value; this.state.settings.alamatToko = document.getElementById('s-alamatToko').value; this.state.settings.pesanDiStruk = document.getElementById('s-pesanDiStruk').value; this.state.settings.teleponToko = document.getElementById('s-teleponToko').value; this.state.settings.lowStockThreshold = parseInt(document.getElementById('s-lowStockThreshold').value) || 10; this.saveAllData(); this.applySettings(); this.showToast('Pengaturan berhasil disimpan!'); },
        exportData() { /*UNCHANGED*/ const dataStr = JSON.stringify(this.state, null, 2); const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `tokopintar_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); this.showToast('Data berhasil diekspor.'); },
        resetTransactions() { /*UNCHANGED*/ this.state.transactions = []; this.state.expenses = []; this.state.stockHistory = []; this.state.customers.forEach(c => { c.totalSpent = 0; c.visitCount = 0; }); this.saveAllData(); this.showToast('Data transaksi berhasil direset.', 'warning'); if(this.state.currentPage === 'dashboard' || this.state.currentPage === 'laporan') { this.showPage(this.state.currentPage); } },
        generateReport() { /*UNCHANGED*/ const resultsContainer = document.getElementById('report-results'); const startDateStr = document.getElementById('report-start').value; const endDateStr = document.getElementById('report-end').value; if (!startDateStr || !endDateStr || !resultsContainer) return; const start = new Date(startDateStr); start.setHours(0, 0, 0, 0); const end = new Date(endDateStr); end.setHours(23, 59, 59, 999); const filteredTrx = this.state.transactions.filter(t => new Date(t.date) >= start && new Date(t.date) <= end); const filteredExp = this.state.expenses.filter(e => { const d = new Date(e.date); return d >= start && d <= end; }); const totalRevenue = filteredTrx.reduce((sum, t) => sum + t.finalTotal, 0); let totalCOGS = 0; const productSales = {}; const customerSpending = {}; filteredTrx.forEach(t => { if (t.customerId) { customerSpending[t.customerId] = (customerSpending[t.customerId] || 0) + t.finalTotal; } t.items.forEach(item => { totalCOGS += (item.cost || 0) * item.quantity; productSales[item.name] = (productSales[item.name] || 0) + item.quantity; }); }); const grossProfit = totalRevenue - totalCOGS; const totalExpenses = filteredExp.reduce((sum, e) => sum + e.amount, 0); const netProfit = grossProfit - totalExpenses; const topCustomers = Object.keys(customerSpending).map(customerId => ({ ...(this.state.customers.find(c => c.id === customerId) || { name: 'Pelanggan Dihapus'}), spentPeriod: customerSpending[customerId] })).sort((a,b) => b.spentPeriod - a.spentPeriod).slice(0, 5); resultsContainer.innerHTML = `<div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"><div class="stat-card"><h4>Total Pendapatan</h4><p class="stat-card-value">${this.formatRupiah(totalRevenue)}</p></div><div class="stat-card"><h4>Laba Kotor</h4><p class="stat-card-value">${this.formatRupiah(grossProfit)}</p></div><div class="stat-card"><h4>Total Biaya</h4><p class="stat-card-value">${this.formatRupiah(totalExpenses)}</p></div><div class="stat-card" style="background-color: ${netProfit >= 0 ? 'var(--success-100)' : 'var(--danger-100)'};"><h4 style="color: ${netProfit >= 0 ? 'var(--success-700)' : 'var(--danger-700)'};">Laba Bersih</h4><p class="stat-card-value" style="color: ${netProfit >= 0 ? 'var(--success-700)' : 'var(--danger-700)'};">${this.formatRupiah(netProfit)}</p></div></div><div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;"><div class="card" style="padding:0; margin-bottom:0;"><h3 style="padding:20px 25px;">Penjualan per Produk</h3><div class="table-wrapper"><table class="responsive-table"><thead><tr><th>Produk</th><th>Jml Terjual</th></tr></thead><tbody>${Object.keys(productSales).length > 0 ? Object.entries(productSales).sort((a,b) => b[1] - a[1]).map(([name, qty]) => `<tr><td data-label="Produk">${name}</td><td data-label="Jumlah">${qty}</td></tr>`).join('') : '<tr><td colspan="2" style="text-align:center;">Tidak ada penjualan.</td></tr>'}</tbody></table></div></div><div class="card" style="padding:0; margin-bottom:0;"><h3 style="padding:20px 25px;">Pelanggan Teratas (Periode Ini)</h3><div class="table-wrapper"><table class="responsive-table"><thead><tr><th>Nama</th><th>Total Belanja</th></tr></thead><tbody>${topCustomers.length > 0 ? topCustomers.map(c => `<tr><td data-label="Nama">${c.name}</td><td data-label="Belanja">${this.formatRupiah(c.spentPeriod)}</td></tr>`).join('') : '<tr><td colspan="2" style="text-align:center;">Tidak ada data.</td></tr>'}</tbody></table></div></div></div>`; },
    };
    
    App.init();
});
</script>
</body>
</html>
