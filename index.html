<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>tokopintar.id - Professional POS</title>

    <style>
        /* === 1. DESIGN SYSTEM & RESET === */
        :root {
            --primary-500: #3b82f6; --primary-600: #2563eb;
            --neutral-0: #ffffff; --neutral-50: #f8fafc; --neutral-100: #f1f5f9; --neutral-200: #e2e8f0; --neutral-400: #94a3b8; --neutral-600: #475569; --neutral-800: #1e293b;
            --success-500: #10b981; --danger-500: #ef4444; --warning-500: #f59e0b;
            --font-main: 'Inter', sans-serif;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }
        html { scroll-behavior: smooth; }
        body { background-color: var(--neutral-100); color: var(--neutral-800); -webkit-font-smoothing: antialiased; }
        ::selection { background-color: var(--primary-500); color: var(--neutral-0); }

        /* === 2. LAYOUT UTAMA (MOBILE-FIRST) === */
        .app-container { display: flex; }
        .main-content { width: 100%; padding: 15px; padding-bottom: 80px; /* Space for bottom nav */ transition: margin-left 0.3s ease; }
        .sidebar { display: none; } /* Hidden on mobile */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background-color: var(--neutral-0); border-top: 1px solid var(--neutral-200); display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
        .bottom-nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: var(--neutral-400); gap: 4px; }
        .bottom-nav-link i { font-size: 20px; }
        .bottom-nav-link span { font-size: 10px; font-weight: 500; }
        .bottom-nav-link.active { color: var(--primary-500); }

        /* TABLET LAYOUT */
        @media (min-width: 768px) {
            .main-content { margin-left: 80px; width: calc(100% - 80px); padding: 20px; padding-bottom: 20px; }
            .sidebar { display: flex; flex-direction: column; position: fixed; width: 80px; height: 100vh; background-color: var(--neutral-0); border-right: 1px solid var(--neutral-200); padding: 20px 0; transition: width 0.3s ease; z-index: 1001; }
            .sidebar:hover { width: 250px; }
            .sidebar-header { display: flex; align-items: center; justify-content: center; padding: 0 10px; min-height: 40px; }
            .sidebar-header i { color: var(--primary-500); font-size: 28px; }
            .sidebar-header h2 { font-size: 22px; opacity: 0; visibility: hidden; white-space: nowrap; }
            .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu { list-style: none; margin-top: 30px; }
            .sidebar-menu a { display: flex; align-items: center; text-decoration: none; color: var(--neutral-600); padding: 15px 28px; white-space: nowrap; }
            .sidebar-menu a i { font-size: 22px; min-width: 24px; }
            .sidebar-menu a span { margin-left: 20px; font-weight: 500; opacity: 0; visibility: hidden; }
            .sidebar:hover .sidebar-menu a span { opacity: 1; visibility: visible; transition: opacity 0.3s ease 0.1s; }
            .sidebar-menu a:hover { background-color: var(--neutral-100); }
            .sidebar-menu a.active { color: var(--primary-500); font-weight: 600; position: relative; }
            .sidebar-menu a.active::before { content: ''; position: absolute; left: 0; top: 10px; bottom: 10px; width: 4px; background-color: var(--primary-500); border-radius: 0 4px 4px 0; }
            .bottom-nav { display: none; }
        }
        /* DESKTOP LAYOUT */
        @media (min-width: 1200px) {
            .main-content { margin-left: 250px; width: calc(100% - 250px); }
            .sidebar, .sidebar:hover { width: 250px; }
            .sidebar-header { justify-content: flex-start; padding: 0 25px; }
            .sidebar-header h2, .sidebar:hover .sidebar-header h2 { opacity: 1; visibility: visible; transition: none; }
            .sidebar-menu a span, .sidebar:hover .sidebar-menu a span { opacity: 1; visibility: visible; transition: none; }
        }

        /* === 3. KOMPONEN UI MODERN === */
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 28px; }

        .card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; border-radius: 8px; font-weight: 600; text-decoration: none; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--primary-500); color: var(--neutral-0); }
        .btn-primary:hover { background-color: var(--primary-600); }
        .btn-secondary { background-color: var(--neutral-0); color: var(--neutral-800); border-color: var(--neutral-200); }
        .btn-secondary:hover { background-color: var(--neutral-50); }
        .btn-text { background: none; color: var(--primary-500); padding: 8px; }
        .btn-text:hover { background-color: var(--neutral-100); }
        
        .form-group { position: relative; margin-bottom: 25px; }
        .form-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--neutral-200); font-size: 16px; background-color: var(--neutral-0); }
        .form-input:focus { border-color: var(--primary-500); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .form-label { position: absolute; left: 12px; top: 12px; font-size: 16px; color: var(--neutral-400); background-color: var(--neutral-0); padding: 0 4px; transition: all 0.2s ease; pointer-events: none; }
        .form-input:not(:placeholder-shown) + .form-label, .form-input:focus + .form-label { top: -10px; font-size: 12px; color: var(--primary-500); }
        
        .modal { position: fixed; inset: 0; background-color: rgba(30, 41, 59, 0.5); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; padding: 15px; }
        .modal-content { background-color: var(--neutral-0); border-radius: 12px; padding: 25px; min-width: 300px; max-width: 500px; width: 100%; box-shadow: var(--shadow-md); animation: scaleIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--neutral-400); }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast { padding: 15px 20px; border-radius: 8px; color: var(--neutral-0); margin-top: 10px; box-shadow: var(--shadow-md); animation: slideIn 0.3s ease; }
        .toast.success { background-color: var(--success-500); }
        .toast.error { background-color: var(--danger-500); }
        .toast.warning { background-color: var(--warning-500); }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* === 4. TAMPILAN SPESIFIK HALAMAN === */
        /* Dashboard */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .summary-card { padding: 20px; }
        .summary-card h3 { font-size: 16px; color: var(--neutral-600); margin-bottom: 10px; }
        .summary-card p { font-size: 28px; font-weight: 700; }

        /* Kasir */
        .kasir-container { display: grid; grid-template-columns: 1fr; gap: 20px; height: calc(100vh - 150px); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 5px; }
        .product-card { background-color: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; overflow: hidden; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-card img { width: 100%; height: 100px; object-fit: cover; background-color: var(--neutral-200); color: var(--neutral-600); display:flex; align-items:center; justify-content:center; font-size: 3rem; font-weight: bold;}
        .product-card-info { padding: 10px; }
        .product-card-info h4 { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .product-card-info p { font-size: 12px; color: var(--primary-500); font-weight: 500; }
        #cart-summary-bar { position: fixed; bottom: 65px; left: 0; right: 0; background-color: var(--primary-500); color: var(--neutral-0); padding: 15px; display: none; justify-content: space-between; align-items: center; cursor: pointer; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        @media (min-width: 1200px) {
            .kasir-container { grid-template-columns: 2fr 1.2fr; }
            .cart-container { display: flex !important; flex-direction: column; }
            #cart-summary-bar { display: none !important; }
        }

        /* Tabel Responsif */
        .table-wrapper { overflow-x: auto; }
        .responsive-table { width: 100%; border-collapse: collapse; }
        .responsive-table th, .responsive-table td { padding: 12px 15px; text-align: left; }
        .responsive-table thead { background-color: var(--neutral-50); }
        .responsive-table tbody tr { border-bottom: 1px solid var(--neutral-200); }
        .responsive-table tbody tr:last-of-type { border-bottom: none; }
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; background: var(--neutral-0); border: 1px solid var(--neutral-200); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; border-bottom: 1px solid var(--neutral-100); padding: 10px 0; }
            .responsive-table td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 15px; }
        }

        /* Halaman Lainnya */
        .lainnya-menu { list-style: none; }
        .lainnya-menu-item a { display: flex; align-items: center; padding: 20px 15px; background-color: var(--neutral-0); border-bottom: 1px solid var(--neutral-200); text-decoration: none; color: var(--neutral-800); font-weight: 500; }
        .lainnya-menu-item a:hover { background-color: var(--neutral-50); }
        .lainnya-menu-item:first-child a { border-radius: 8px 8px 0 0; }
        .lainnya-menu-item:last-child a { border-bottom: none; border-radius: 0 0 8px 8px; }
        .lainnya-menu-item i { margin-right: 15px; color: var(--neutral-400); width: 24px; text-align: center; }

        /* Upload Foto Produk */
        #image-preview { width: 100px; height: 100px; border: 1px solid var(--neutral-200); border-radius: 8px; object-fit: cover; display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="app-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <i class="fa-solid fa-bolt"></i>
                <h2 id="store-name-sidebar"></h2>
            </div>
            <ul class="sidebar-menu"></ul>
        </nav>

        <main class="main-content">
            <header class="header">
                <h1 id="page-title"></h1>
                <div id="clock" style="color: var(--neutral-600); font-weight: 500;"></div>
            </header>
            <div id="page-content"></div>
        </main>

        <nav class="bottom-nav"></nav>
        
        <div id="modal-container" class="modal"></div>
        <div id="toast-container"></div>
    </div>

<script>
// --- APLIKASI POS PROFESIONAL (SINGLE-FILE) ---
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        // === 1. STATE & INISIALISASI ===
        state: { 
            currentPage: 'dashboard', 
            currentUserRole: 'admin', 
            cart: [], products: [], customers: [], transactions: [], expenses: [], stockHistory: [],
            settings: {}
        },
        elements: {},
        
        init() {
            this.initData();
            this.injectBaseHTML();
            this.cacheDOMElements();
            this.applySettings();
            this.attachEventListeners();
            this.updateClock();
            setInterval(() => this.updateClock(), 1000);
            this.showPage(this.state.currentPage || 'dashboard');
        },

        initData() {
            const defaultSettings = { namaToko: 'tokopintar.id', alamatToko: 'Jl. Digital No. 1, Semarang', pesanDiStruk: 'Terima kasih telah berbelanja!' };
            try {
                this.state.settings = this.getFromLocalStorage('settings', defaultSettings);
                this.state.products = this.getFromLocalStorage('products', [ 
                    { id: 1, name: 'Kopi Susu Gula Aren', category: 'Kopi', price: 18000, cost: 10000, stock: 50, imageUrl: null }, 
                    { id: 2, name: 'Croissant Coklat', category: 'Roti', price: 22000, cost: 12000, stock: 30, imageUrl: null } 
                ]);
                this.state.customers = this.getFromLocalStorage('customers', []);
                this.state.transactions = this.getFromLocalStorage('transactions', []);
                this.state.expenses = this.getFromLocalStorage('expenses', []);
                this.state.stockHistory = this.getFromLocalStorage('stockHistory', []);
                this.state.cart = this.getFromLocalStorage('cart', []);
                this.state.currentPage = this.getFromLocalStorage('currentPage', 'dashboard');
            } catch (e) {
                console.error("Gagal memuat data dari localStorage:", e);
                if (confirm("Data aplikasi tampaknya rusak. Apakah Anda ingin mereset ke pengaturan awal? Data yang ada akan hilang.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            this.saveAllData();
        },

        injectBaseHTML() {
            const menuItems = [
                { id: 'dashboard', icon: 'fa-solid fa-chart-pie', label: 'Dashboard', role: 'all' },
                { id: 'kasir', icon: 'fa-solid fa-cash-register', label: 'Kasir', role: 'all' },
                { id: 'produk', icon: 'fa-solid fa-box-open', label: 'Produk', role: 'admin' },
                { id: 'laporan', icon: 'fa-solid fa-chart-line', label: 'Laporan', role: 'admin' },
                { id: 'lainnya', icon: 'fa-solid fa-ellipsis', label: 'Lainnya', role: 'all', mobileOnly: true },
                { id: 'pelanggan', icon: 'fa-solid fa-users', label: 'Pelanggan', role: 'admin', desktopOnly: true },
                { id: 'biaya', icon: 'fa-solid fa-wallet', label: 'Biaya', role: 'admin', desktopOnly: true },
                { id: 'pengaturan', icon: 'fa-solid fa-gear', label: 'Pengaturan', role: 'admin', desktopOnly: true }
            ];
            
            const sidebarHTML = menuItems.filter(item => !item.mobileOnly).map(item => 
                `<li data-role="${item.role}"><a href="#" class="nav-link" data-page="${item.id}"><i class="${item.icon}"></i><span>${item.label}</span></a></li>`
            ).join('');
            document.querySelector('.sidebar-menu').innerHTML = sidebarHTML;

            const bottomNavHTML = menuItems.filter(item => !item.desktopOnly).map(item =>
                `<a href="#" class="bottom-nav-link nav-link" data-page="${item.id}" data-role="${item.role}"><i class="${item.icon}"></i><span>${item.label}</span></a>`
            ).join('');
            document.querySelector('.bottom-nav').innerHTML = bottomNavHTML;
        },

        cacheDOMElements() {
            this.elements = {
                pageTitle: document.getElementById('page-title'), clock: document.getElementById('clock'),
                pageContent: document.getElementById('page-content'), modalContainer: document.getElementById('modal-container'),
                toastContainer: document.getElementById('toast-container'), navLinks: document.querySelectorAll('.nav-link'),
                sidebarStoreName: document.getElementById('store-name-sidebar'),
            };
        },
        
        attachEventListeners() {
            // Event listener untuk link navigasi utama
            this.elements.navLinks.forEach(link => link.addEventListener('click', e => { e.preventDefault(); this.showPage(e.currentTarget.dataset.page); }));
            
            // Event listener untuk menu dinamis di dalam page-content (seperti menu di halaman "Lainnya")
            this.elements.pageContent.addEventListener('click', e => {
                const link = e.target.closest('.nav-link-dynamic');
                if (link) {
                    e.preventDefault();
                    this.showPage(link.dataset.page);
                }
            });
            
            document.addEventListener('keydown', e => { if (e.key === 'Escape') this.closeModal(); });
            document.addEventListener('keydown', e => { 
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); this.showToast('Command Palette belum tersedia.', 'warning'); }
                if (this.state.currentPage === 'kasir') {
                    if (e.key === 'F1') { e.preventDefault(); document.getElementById('kasir-search-input')?.focus(); }
                    if (e.key === 'F9') { e.preventDefault(); this.openPaymentModal(); }
                }
            });
        },
        
        // === 2. UTILITIES ===
        saveAllData() { for (const key in this.state) { this.saveToLocalStorage(key, this.state[key]); } },
        getFromLocalStorage(key, defaultValue) { const data = localStorage.getItem(key); if (!data) return defaultValue; try { return JSON.parse(data); } catch { return defaultValue; } },
        saveToLocalStorage: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
        formatRupiah: (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number),
        updateClock() { this.elements.clock.textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }); },
        applySettings() { document.title = `${this.state.settings.namaToko} - POS`; this.elements.sidebarStoreName.textContent = this.state.settings.namaToko; },

        showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            this.elements.toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        },

        showModal(title, contentHTML, onConfirm, confirmText = 'Simpan') {
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <div class="modal-header"><h2>${title}</h2><button class="close-modal">&times;</button></div>
                <form id="modal-form">${contentHTML}</form>
                <div style="text-align:right; margin-top:20px;">
                    <button class="btn btn-secondary close-modal">Batal</button>
                    ${onConfirm ? `<button class="btn btn-primary" id="modal-confirm">${confirmText}</button>` : ''}
                </div>`;
            this.elements.modalContainer.innerHTML = '';
            this.elements.modalContainer.appendChild(modalContent);
            this.elements.modalContainer.style.display = 'flex';
            
            if (onConfirm) {
                document.getElementById('modal-confirm').addEventListener('click', () => { if(onConfirm()) this.closeModal(); });
            }
            this.elements.modalContainer.querySelectorAll('.close-modal').forEach(el => el.addEventListener('click', () => this.closeModal()));
        },
        closeModal() { this.elements.modalContainer.style.display = 'none'; this.elements.modalContainer.innerHTML = ''; },

        // === 3. NAVIGASI & RENDER HALAMAN ===
        showPage(pageId) {
            this.elements.navLinks.forEach(l => l.classList.remove('active'));
            document.querySelectorAll(`.nav-link[data-page="${pageId}"]`).forEach(l => l.classList.add('active'));
            this.state.currentPage = pageId;
            this.saveToLocalStorage('currentPage', pageId);

            const pageData = {
                dashboard: { title: 'Dashboard', render: this.renderDashboard },
                kasir: { title: 'Kasir', render: this.renderKasir },
                produk: { title: 'Manajemen Produk', render: this.renderProduk },
                laporan: { title: 'Laporan Penjualan', render: this.renderLaporan },
                lainnya: { title: 'Menu Lainnya', render: this.renderLainnya },
                pelanggan: { title: 'Pelanggan', render: () => this.renderPlaceholder('Pelanggan') },
                biaya: { title: 'Biaya Operasional', render: () => this.renderPlaceholder('Biaya') },
                pengaturan: { title: 'Pengaturan', render: () => this.renderPlaceholder('Pengaturan') },
            };
            const page = pageData[pageId];
            this.elements.pageTitle.textContent = page?.title || 'Halaman Tidak Ditemukan';
            this.elements.pageContent.innerHTML = '<div class="card">Memuat...</div>'; // Loading state
            if(page) {
                page.render.call(this);
            } else {
                this.elements.pageContent.innerHTML = `<div class="card">Halaman "${pageId}" tidak ditemukan.</div>`;
            }
        },

        renderPlaceholder(pageName) {
             this.elements.pageContent.innerHTML = `<div class="card">Fitur ${pageName} sedang dalam pengembangan.</div>`;
        },
        
        // === 4. FUNGSI PER MODUL ===

        // --- DASHBOARD ---
        renderDashboard() {
            const today = new Date().toISOString().slice(0, 10);
            const salesToday = this.state.transactions.filter(t => t.date.startsWith(today));
            const totalRevenueToday = salesToday.reduce((sum, t) => sum + t.finalTotal, 0);
            const totalTransactionsToday = salesToday.length;

            const productSales = {};
            this.state.transactions.forEach(trx => {
                trx.items.forEach(item => {
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                });
            });
            const topProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 3);

            this.elements.pageContent.innerHTML = `
                <div class="summary-grid">
                    <div class="card summary-card"><h3>Penjualan Hari Ini</h3><p>${this.formatRupiah(totalRevenueToday)}</p></div>
                    <div class="card summary-card"><h3>Transaksi Hari Ini</h3><p>${totalTransactionsToday}</p></div>
                </div>
                <div class="card">
                    <h3>Produk Terlaris (Berdasarkan Jumlah)</h3>
                    ${topProducts.length > 0 ? `
                    <ul style="list-style: none; margin-top: 15px; padding-left: 0;">
                        ${topProducts.map(p => `<li style="padding: 8px 0; border-bottom: 1px solid var(--neutral-100);">${p[0]} - <strong>${p[1]}</strong> terjual</li>`).join('')}
                    </ul>` : `<p style="margin-top: 10px; color: var(--neutral-400);">Belum ada data penjualan.</p>`}
                </div>
            `;
        },
        
        // --- KASIR ---
        renderKasir() {
            this.elements.pageContent.innerHTML = `<div class="kasir-container"><div class="card product-section" style="padding: 15px;"><div style="margin-bottom:15px;"><input type="text" id="kasir-search-input" class="form-input" placeholder="Cari produk (F1)..."></div><div id="product-grid" class="product-grid"></div></div><div id="cart-container" class="card cart-container" style="display:none;"><h3 style="margin-bottom:15px;">Keranjang</h3><div id="cart-items" style="flex-grow:1; overflow-y:auto;"></div><div id="cart-total" style="margin-top:auto; padding-top:15px; border-top:1px solid var(--neutral-200);"></div><button id="btn-bayar" class="btn btn-primary" style="width:100%; margin-top:15px;">Bayar (F9)</button></div></div><div id="cart-summary-bar"></div>`;
            document.getElementById('kasir-search-input').addEventListener('input', e => this.renderProductGrid(e.target.value));
            document.getElementById('product-grid').addEventListener('click', e => { const card = e.target.closest('.product-card'); if (card) this.addToCart(parseInt(card.dataset.id)); });
            document.getElementById('btn-bayar').addEventListener('click', () => this.openPaymentModal());
            document.getElementById('cart-summary-bar').addEventListener('click', () => this.openPaymentModal());
            this.renderProductGrid();
            this.renderCart();
        },
        renderProductGrid(searchTerm = '') {
            const container = document.getElementById('product-grid');
            if (!container) return;
            const normalizedSearch = searchTerm.toLowerCase();
            const products = this.state.products.filter(p => p.name.toLowerCase().includes(normalizedSearch));
            container.innerHTML = products.map(p => `
                <div class="product-card" data-id="${p.id}">
                    ${p.imageUrl ? `<img src="${p.imageUrl}" alt="${p.name}">` : `<img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="${p.name.charAt(0)}">`}
                    <div class="product-card-info"><h4>${p.name}</h4><p>${this.formatRupiah(p.price)}</p></div>
                </div>`).join('') || `<p style="grid-column: 1 / -1; text-align:center; color: var(--neutral-400);">Tidak ada produk.</p>`;
        },
        addToCart(productId) { 
            const product = this.state.products.find(p => p.id === productId);
            if(product.stock <= 0) return this.showToast('Stok produk habis!', 'error');
            const itemInCart = this.state.cart.find(i => i.id === productId);
            if(itemInCart) {
                if(itemInCart.quantity >= product.stock) return this.showToast('Jumlah melebihi stok!', 'error');
                itemInCart.quantity++;
            } else {
                this.state.cart.push({ ...product, quantity: 1 });
            }
            this.saveToLocalStorage('cart', this.state.cart);
            this.renderCart();
        },
        renderCart() {
            const container = document.getElementById('cart-items');
            if(!container) return;
            const subtotal = this.state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            container.innerHTML = this.state.cart.length ? this.state.cart.map(item => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding: 8px 0;">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>${this.formatRupiah(item.price)} x ${item.quantity}</small>
                    </div>
                    <div>${this.formatRupiah(item.price * item.quantity)}</div>
                </div>
            `).join('') : `<i style="color: var(--neutral-400);">Keranjang kosong</i>`;
            document.getElementById('cart-total').innerHTML = `<strong>Total: ${this.formatRupiah(subtotal)}</strong>`;
            
            const summaryBar = document.getElementById('cart-summary-bar');
            if (summaryBar) {
                if(this.state.cart.length > 0) {
                    summaryBar.style.display = 'flex';
                    summaryBar.innerHTML = `<span>${this.state.cart.reduce((t,i) => t+i.quantity, 0)} item</span><strong>Lihat Keranjang & Bayar &nbsp; &rsaquo;</strong>`;
                } else {
                    summaryBar.style.display = 'none';
                }
            }
        },
        openPaymentModal() {
            if (this.state.cart.length === 0) return this.showToast('Keranjang kosong!', 'error');
            const subtotal = this.state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const cartItemsHTML = this.state.cart.map(item => `<p>${item.name} x ${item.quantity}</p>`).join('');
            this.showModal('Konfirmasi Pembayaran', 
                `<div>${cartItemsHTML}<hr style="margin: 10px 0;"><strong>Total: ${this.formatRupiah(subtotal)}</strong></div>`, 
                () => this.processPayment(),
                'Proses Pembayaran'
            );
        },
        processPayment() {
            this.state.cart.forEach(cartItem => {
                const product = this.state.products.find(p => p.id === cartItem.id);
                if(product) product.stock -= cartItem.quantity;
            });
            const newTransaction = { 
                id: 'TRX-' + Date.now(), 
                date: new Date().toISOString(), 
                items: this.state.cart, 
                finalTotal: this.state.cart.reduce((s,i)=>s+(i.price*i.quantity),0) 
            };
            this.state.transactions.push(newTransaction);
            this.state.cart = [];
            this.saveAllData();
            this.showToast('Transaksi berhasil!');
            if(this.state.currentPage === 'kasir') this.renderKasir();
            return true;
        },

        // --- PRODUK ---
        renderProduk() {
            this.elements.pageContent.innerHTML = `<div class="header"><h1></h1><button class="btn btn-primary" id="btn-add-product"><i class="fa-solid fa-plus"></i> Tambah Produk</button></div><div class="card" style="padding:0;"><div class="table-wrapper" id="product-table-container"></div></div>`;
            document.getElementById('btn-add-product').addEventListener('click', () => this.showProductModal());
            this.renderProductTable();
        },
        renderProductTable() {
            let tableHTML = `<table class="responsive-table"><thead><tr><th>Produk</th><th>Kategori</th><th>Harga Jual</th><th>Harga Pokok</th><th>Stok</th><th>Aksi</th></tr></thead><tbody>`;
            this.state.products.forEach(p => {
                tableHTML += `
                    <tr>
                        <td data-label="Produk">${p.name}</td>
                        <td data-label="Kategori">${p.category}</td>
                        <td data-label="Harga Jual">${this.formatRupiah(p.price)}</td>
                        <td data-label="Harga Pokok">${this.formatRupiah(p.cost)}</td>
                        <td data-label="Stok">${p.stock}</td>
                        <td data-label="Aksi"><button class="btn btn-text" onclick="App.showProductModal(${p.id})"><i class="fa-solid fa-pen-to-square"></i></button></td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            document.getElementById('product-table-container').innerHTML = tableHTML;
        },
        showProductModal(productId) {
            const isEdit = productId !== undefined;
            const product = isEdit ? this.state.products.find(p => p.id === productId) : {};
            const title = isEdit ? 'Edit Produk' : 'Tambah Produk';
            const content = `
                <div class="form-group"><input type="text" id="p-name" class="form-input" placeholder=" " value="${product.name || ''}" required><label class="form-label">Nama Produk</label></div>
                <div class="form-group"><input type="text" id="p-category" class="form-input" placeholder=" " value="${product.category || ''}" required><label class="form-label">Kategori</label></div>
                <div class="form-group"><input type="number" id="p-price" class="form-input" placeholder=" " value="${product.price || ''}" required><label class="form-label">Harga Jual</label></div>
                <div class="form-group"><input type="number" id="p-cost" class="form-input" placeholder=" " value="${product.cost || ''}" required><label class="form-label">Harga Pokok (Modal)</label></div>
                <div class="form-group"><input type="number" id="p-stock" class="form-input" placeholder=" " value="${product.stock || ''}" required><label class="form-label">Stok</label></div>
                <div>
                    <label>Foto Produk (Opsional)</label>
                    <input type="file" id="p-image" class="form-input" accept="image/*" style="padding-top:10px;">
                    <img id="image-preview" src="${product.imageUrl || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="Preview">
                </div>
            `;
            this.showModal(title, content, () => this.saveProduct(productId));
            document.getElementById('p-image').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('image-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        },
        saveProduct(productId) {
            const name = document.getElementById('p-name').value.trim();
            const price = parseFloat(document.getElementById('p-price').value);
            const cost = parseFloat(document.getElementById('p-cost').value);
            const stock = parseInt(document.getElementById('p-stock').value);
            const imageUrl = document.getElementById('image-preview').src;

            if (!name || isNaN(price) || price < 0 || isNaN(stock) || stock < 0 || isNaN(cost) || cost < 0) {
                this.showToast('Data tidak valid! Periksa kembali semua field.', 'error'); return false;
            }

            const productData = { name, category: document.getElementById('p-category').value.trim(), price, cost, stock, imageUrl: imageUrl.startsWith('data:image') ? imageUrl : null, };

            if (productId !== undefined) {
                const productIndex = this.state.products.findIndex(p => p.id === productId);
                this.state.products[productIndex] = { ...this.state.products[productIndex], ...productData };
            } else {
                const newId = (Math.max(0, ...this.state.products.map(p => p.id)) + 1);
                this.state.products.push({ id: newId, ...productData });
            }
            this.saveAllData();
            this.renderProductTable();
            this.showToast(`Produk berhasil ${productId !== undefined ? 'diperbarui' : 'ditambahkan'}.`);
            return true;
        },

        // --- LAPORAN ---
        renderLaporan() {
            this.elements.pageContent.innerHTML = `
                <div class="card">
                    <div class="header">
                        <h3>Filter Laporan</h3>
                    </div>
                    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                        <div class="form-group" style="margin-bottom:0; flex-grow:1;"><input type="date" id="report-start" class="form-input"><label class="form-label">Tanggal Mulai</label></div>
                        <div class="form-group" style="margin-bottom:0; flex-grow:1;"><input type="date" id="report-end" class="form-input"><label class="form-label">Tanggal Akhir</label></div>
                        <button id="generate-report" class="btn btn-primary">Tampilkan Laporan</button>
                    </div>
                </div>
                <div id="report-results"></div>
            `;
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('report-start').value = today;
            document.getElementById('report-end').value = today;
            document.getElementById('generate-report').addEventListener('click', () => this.generateReport());
            this.generateReport(); // Generate for today by default
        },
        generateReport() {
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;
            if (!startDate || !endDate) return;

            const start = new Date(startDate).setHours(0, 0, 0, 0);
            const end = new Date(endDate).setHours(23, 59, 59, 999);

            const filteredTrx = this.state.transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= start && tDate <= end;
            });

            const totalRevenue = filteredTrx.reduce((sum, t) => sum + t.finalTotal, 0);
            let totalCOGS = 0;
            const productSales = {};

            filteredTrx.forEach(t => {
                t.items.forEach(item => {
                    totalCOGS += (item.cost || 0) * item.quantity;
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                });
            });
            
            const grossProfit = totalRevenue - totalCOGS;
            const totalExpenses = 0; // Placeholder, integrate with expenses module later
            const netProfit = grossProfit - totalExpenses;
            
            const lowStockProducts = this.state.products.filter(p => p.stock <= 5);

            document.getElementById('report-results').innerHTML = `
                <div class="summary-grid">
                    <div class="card summary-card"><h3>Total Pendapatan</h3><p>${this.formatRupiah(totalRevenue)}</p></div>
                    <div class="card summary-card"><h3>Laba Kotor</h3><p>${this.formatRupiah(grossProfit)}</p></div>
                    <div class="card summary-card"><h3>Laba Bersih</h3><p>${this.formatRupiah(netProfit)}</p></div>
                </div>
                <div class="card" style="padding:0;"><div class="table-wrapper">
                    <h3 style="padding:20px 25px;">Penjualan per Produk</h3>
                    <table class="responsive-table">
                        <thead><tr><th>Produk</th><th>Jumlah Terjual</th></tr></thead>
                        <tbody>
                        ${Object.keys(productSales).length > 0 ? Object.entries(productSales).sort((a,b) => b[1] - a[1]).map(([name, qty]) => `
                            <tr><td data-label="Produk">${name}</td><td data-label="Jumlah">${qty}</td></tr>`).join('') 
                            : '<tr><td colspan="2" style="text-align:center;">Tidak ada penjualan pada periode ini.</td></tr>'}
                        </tbody>
                    </table>
                </div></div>
                <div class="card" style="padding:0;"><div class="table-wrapper">
                    <h3 style="padding:20px 25px;">Stok Rendah (<= 5)</h3>
                     <table class="responsive-table">
                        <thead><tr><th>Produk</th><th>Sisa Stok</th></tr></thead>
                        <tbody>
                        ${lowStockProducts.length > 0 ? lowStockProducts.map(p => `
                            <tr><td data-label="Produk">${p.name}</td><td data-label="Sisa Stok">${p.stock}</td></tr>`).join('') 
                            : '<tr><td colspan="2" style="text-align:center;">Semua stok aman.</td></tr>'}
                        </tbody>
                    </table>
                </div></div>
            `;
        },
        
        // --- LAINNYA (MOBILE) ---
        renderLainnya() {
            this.elements.pageContent.innerHTML = `
                <ul class="lainnya-menu">
                    <li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="pelanggan"><i class="fa-solid fa-users"></i> Pelanggan</a></li>
                    <li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="biaya"><i class="fa-solid fa-wallet"></i> Biaya</a></li>
                    <li class="lainnya-menu-item"><a href="#" class="nav-link-dynamic" data-page="pengaturan"><i class="fa-solid fa-gear"></i> Pengaturan</a></li>
                </ul>
            `;
        },
    };

    window.App = {
        showProductModal: App.showProductModal.bind(App),
    };
    
    App.init();
});
</script>
</body>
</html>
